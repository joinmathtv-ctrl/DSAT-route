<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DSAT Practice ‚Äî Classic UI</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script defer id="MathJax-script"
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
  :root{
    --bg:#fafbfe; --card:#fff; --ink:#0f172a; --muted:#6b7280;
    --line:#e5e7eb; --accent:#2563eb; --accent-ghost:#e7f0ff;
    --flag:#ef9b0f; --choice:#f7f7fb; --choice-hover:#eef2ff;
    --danger:#dc2626;
  }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Arial,sans-serif; color:var(--ink); background:var(--bg) }

  /* ===== TOP BAR ===== */
  .topbar{ position:sticky; top:0; z-index:5; background:#fff; border-bottom:1px solid var(--line) }
  .topbar-row{ display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:10px; padding:6px 14px }
  .crumb{ font-weight:600; font-size:14px }
  .controls{ justify-self:end; display:flex; gap:8px }
  .icon-btn{ border:1px solid var(--line); background:#fff; padding:6px 10px; border-radius:8px; font-size:12px; cursor:pointer }
  .timer-wrap{ justify-self:center; display:flex; align-items:center; gap:8px }
  .timer{ font-weight:800; font-variant-numeric:tabular-nums }
  .hide-btn{ border:1px solid var(--line); background:#fff; padding:3px 8px; border-radius:6px; font-size:12px; cursor:pointer }

  /* Directions dropdown */
  .dir-zone{ display:flex; align-items:center; gap:10px }
  .dir-btn{ border:1px solid var(--line); background:#fff; padding:5px 10px; border-radius:8px; font-size:13px; cursor:pointer }
  .dir-panel{
    position:absolute; left:14px; top:44px; width:520px; background:#fff; border:1px solid var(--line);
    border-radius:12px; padding:12px; font-size:14px; line-height:1.45; box-shadow:0 12px 32px rgba(0,0,0,.08); display:none;
  }

  .dash{ height:6px; background:repeating-linear-gradient(90deg,
      #d9ead3 0 46px, #fff 46px 54px,
      #f9e1ae 54px 98px, #fff 98px 106px,
      #cfe2f3 106px 152px, #fff 152px 160px); opacity:.95 }

  /* ===== MAIN ===== */
  .wrap{ max-width:1060px; margin:12px auto 92px; padding:0 14px } /* bottom space for ribbon */
  .loader{ display:flex; gap:8px; margin:6px 0 12px 0 }
  input[type="text"]#path{ width:330px; padding:7px 10px; border:1px solid var(--line); border-radius:8px }
  .btn{ border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer }
  .btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent) }
  .btn.danger{ background:var(--danger); color:#fff; border-color:var(--danger) }
  .alert{ background:#fef3f2; color:#b42318; border:1px solid #fecdca; padding:10px 12px; border-radius:10px; margin:8px 0; font-size:14px }

  /* ===== Question Card ===== */
  .qcard{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,.04) }
  .qhead{ display:flex; align-items:center; gap:10px; margin-bottom:6px }
  .qnum{ width:28px; height:28px; display:grid; place-items:center; font-weight:700; border:1px solid var(--line); border-radius:6px }
  .flag-btn{ margin-left:4px; border:1px solid var(--line); background:#fff; border-radius:8px; padding:4px 10px; cursor:pointer; font-size:13px; color:var(--muted) }
  .flagged{ color:var(--flag); border-color:#fde68a; background:#fffaf0 }
  .qtitle{ text-align:center; color:#0f172a; font-size:14px; margin:4px 0 6px 0 }
  .qstem{ font-size:16px; line-height:1.55; margin:10px 0 12px 0 }
  .choices{ display:grid; gap:10px }

  .choice{ border:1px solid var(--line); background:var(--choice); border-radius:10px; padding:10px 12px; cursor:pointer;
           display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:flex-start; transition:background .15s, border-color .15s }
  .choice:hover{ background:var(--choice-hover) }
  .bubble{ width:24px; height:24px; border:1px solid var(--line); border-radius:50%; display:grid; place-items:center;
           font-weight:700; background:#fff; user-select:none; font-size:13px }
  .choice input{ display:none }
  .choice.selected{ border-color:#bfd3ff; background:#eef4ff }
  .choice.selected .bubble{ border-color:var(--accent); color:#fff; background:var(--accent) }

  .gridin{ width:260px; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-size:16px; background:#fff }

  /* ===== Fixed bottom ribbon ===== */
  .ribbon{
    position:fixed; left:0; right:0; bottom:0; z-index:10; background:#fff;
    border-top:1px solid var(--line); box-shadow:0 -6px 16px rgba(0,0,0,.04);
  }
  .rib-row{
    max-width:1060px; margin:0 auto; padding:10px 14px;
    display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:12px;
  }
  .rib-left{ display:flex; align-items:center; gap:10px }
  .rib-center{ display:flex; justify-content:center }
  .rib-right{ display:flex; justify-content:flex-end; align-items:center; gap:18px } /* submitÍ≥º prev/next ÏÇ¨Ïù¥ Í∞ÑÍ≤© ÎÑìÌûò */

  .navopen{
    min-width:120px; text-align:center; font-weight:700;
    border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:22px; cursor:pointer;
  }
  .rib-left .btn{ min-width:90px }
  .rib-right .btn{ min-width:100px }

  /* ===== Number grid modal ===== */
  .modal-back{ position:fixed; inset:0; background:rgba(15,23,42,.35); display:none; z-index:20 }
  .modal{ background:#fff; width:min(720px,92vw); margin:8vh auto; padding:16px; border-radius:12px; border:1px solid var(--line); box-shadow:0 24px 48px rgba(0,0,0,.2) }
  .head{ font-weight:800; margin-bottom:8px }
  .grid{ display:grid; grid-template-columns:repeat(11,1fr); gap:8px }
  .cell{ border:1px solid var(--line); border-radius:10px; padding:8px 0; text-align:center; cursor:pointer; background:#fff }
  .cell.answered{ background:#e9fbe7; border-color:#b7f4be }
  .cell.flag{ background:#fff3d6; border-color:#fde68a }
  .modal-foot{ margin-top:12px; display:flex; justify-content:flex-end; gap:10px }

  /* ===== Scoreboard (after module 2) ===== */
  .score-wrap{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:14px }
  .scores{ display:flex; gap:10px; flex-wrap:wrap }
  .pill{ padding:6px 10px; border-radius:999px; background:#f3f4f6; border:1px solid var(--line); font-weight:600 }
  .legend{ color:var(--muted); font-size:14px }

  .checkboard{ display:grid; grid-template-columns:repeat(11,1fr); gap:8px; margin-top:10px }
  .qb{ border:1px solid var(--line); border-radius:10px; padding:8px 0; text-align:center; cursor:pointer; background:#fff; font-weight:600 }
  .qb.correct{ background:#e9fbe7; border-color:#b7f4be }
  .qb.wrong{ background:#fee2e2; border-color:#fecaca }
  .qb.flag{ outline:2px dashed #fbbf24 }

  /* ===== Explanation popup (results only) ===== */
  .exp-back{ position:fixed; inset:0; background:rgba(15,23,42,.4); display:none; z-index:30 }
  .exp{ background:#fff; width:min(940px,95vw); margin:6vh auto; padding:16px; border-radius:14px; border:1px solid var(--line); box-shadow:0 24px 48px rgba(0,0,0,.25) }
  .exp-head{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px }
  .exp-title{ font-weight:800 }
  .close-x{ border:1px solid var(--line); background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer }
  .exp-body{ display:grid; grid-template-columns:1fr; gap:12px }
  .exp-box{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px }
  .kv{ display:grid; grid-template-columns:120px 1fr; gap:8px; font-size:14px }
  .kv b{ color:#111827 }

  /* Hide native palette (we now use modal) */
  .palette{ display:none !important }
</style>
</head>
<body>

<!-- ===== TOP BAR ===== -->
<div class="topbar">
  <div class="topbar-row">
    <div class="dir-zone">
      <div class="crumb" id="crumb">Section 2, Module 1: Math</div>
      <button class="dir-btn" id="dirToggle">Directions ‚ñæ</button>
      <div class="dir-panel" id="dirPanel"></div>
    </div>
    <div class="timer-wrap">
      <span class="timer" id="timer">35:00</span>
      <button class="hide-btn" id="hideBtn">Hide</button>
    </div>
    <div class="controls">
      <button class="icon-btn">üî¢ Calculator</button>
      <button class="icon-btn">üìÑ Reference</button>
      <button class="icon-btn">‚ãØ More</button>
    </div>
  </div>
  <div class="dash"></div>
</div>

<div class="wrap">
  <div class="loader">
    <input id="path" type="text" value="./questions.json" />
    <button class="btn" id="loadBtn">Load set</button>
  </div>
  <div id="loadError" class="alert" style="display:none"></div>

  <!-- Î¨∏Ï†ú Ïπ¥Îìú -->
  <div class="qcard" id="card" style="display:none">
    <div class="qhead">
      <div class="qnum" id="qnum">1</div>
      <button id="flagBtn" class="flag-btn">Mark for Review</button>
    </div>
    <div class="qtitle" id="qtitle"></div>
    <div class="qstem" id="qstem"></div>
    <div class="choices" id="choices"></div>
  </div>

  <!-- Í≤∞Í≥º/Ï†êÏàò ÌëúÏãú ÏòÅÏó≠ -->
  <div id="scoreBox"></div>
</div>

<!-- ===== ÌïòÎã® Í≥†Ï†ï Î¶¨Î≥∏ ===== -->
<div class="ribbon" id="ribbon" style="display:none">
  <div class="rib-row">
    <div class="rib-left">
      <button class="btn" id="prevBtn">‚Üê Prev</button>
    </div>
    <div class="rib-center">
      <!-- ÏßÑÌñâÏÉÅÌô© Ïò§Ìîà Î≤ÑÌäº(ÌïòÎã® Ï§ëÏïô) -->
      <button class="navopen" id="navOpen">1/22</button>
    </div>
    <div class="rib-right">
      <button class="btn" id="nextBtn">Next ‚Üí</button>
      <button class="btn primary" id="submitBtn">Submit</button>
    </div>
  </div>
</div>

<!-- ===== Î≤àÌò∏ Í∑∏Î¶¨Îìú Î™®Îã¨ ===== -->
<div class="modal-back" id="gridBack">
  <div class="modal">
    <div class="head">Go to Question</div>
    <div class="grid" id="numGrid"></div>
    <div class="modal-foot">
      <button class="btn" id="gridClose">Close</button>
    </div>
  </div>
</div>

<!-- ===== Ï†úÏ∂ú ÌôïÏù∏ Î™®Îã¨ ===== -->
<div class="modal-back" id="confirmBack">
  <div class="modal">
    <div class="head">Ï†úÏ∂úÌïòÏãúÍ≤†Ïñ¥Ïöî?</div>
    <div class="body" style="line-height:1.5">
      <div style="margin-bottom:8px">ÌòÑÏû¨ <b id="confirmModLabel">Module 1</b>ÏùÑ(Î•º) Ï†úÏ∂úÌï©ÎãàÎã§.</div>
      <ul style="margin:0; padding-left:18px; color:var(--muted); font-size:14px">
        <li>After submission, you can‚Äôt change answers in this module.</li>
        <li>Submitting Module 1 will automatically start Module 2.</li>
        <li>Submitting Module 2 will show the combined review with explanations.</li>
      </ul>
    </div>
    <div class="modal-foot" style="display:flex; justify-content:flex-end; gap:10px">
      <button class="btn" id="confirmCancel">Cancel</button>
      <button class="btn primary" id="confirmOk">OK</button>
    </div>
  </div>
</div>

<!-- ===== Ìï¥ÏÑ§ ÌåùÏóÖ (Í≤∞Í≥ºÌëúÏóêÏÑúÎßå ÏÉùÏÑ±/ÌëúÏãú) ===== -->
<div class="exp-back" id="expBack">
  <div class="exp">
    <div class="exp-head">
      <div class="exp-title" id="expTitle">Explanation</div>
      <button class="close-x" id="expClose">Close</button>
    </div>
    <div class="exp-body" id="expBody"></div>
  </div>
</div>

<script>
/* ===== ÏÉÅÌÉú ===== */
let SET=null, modIdx=0, qIdx=0;
let flags=new Set(), answers={};
let timerSec=0, tickId=null;

// Í≤∞Í≥º Ï†ÄÏû•
let moduleResults = []; // [{score, total, detail:[{id, correct, user, correctAns, rationale, module, index}]}]

/* ===== Ïú†Ìã∏ ===== */
const $ = s=>document.querySelector(s);
const bubbleABC = idx => "ABCD".charAt(idx);
const fmt = s => (s??"").replaceAll("\\n","<br>");
const fmtTime = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
const typeset = ()=> window.MathJax && MathJax.typesetPromise();
// [[IMAGE: file.png|alt]] -> <img ...>
const injectImages = html =>
  (html||"").replace(/\[\[IMAGE:\s*([^|\]]+)(?:\|([^\]]+))?\]\]/g,
    (_m,src,alt)=>`<img src="./img/${src.trim()}" alt="${(alt||'problem image').trim()}" style="max-width:100%">`);

/* ===== Directions ===== */
const dirBtn=$('#dirToggle'), dirPanel=$('#dirPanel');
dirBtn.onclick=()=> dirPanel.style.display = dirPanel.style.display==='block'?'none':'block';
document.addEventListener('click',e=>{
  if(!dirPanel.contains(e.target) && e.target!==dirBtn) dirPanel.style.display='none';
});

/* ===== Î°úÎìú ===== */
async function loadSet(path){
  try{
    const res = await fetch(path, {cache:'no-store'});
    SET = await res.json();
    $('#loadError').style.display='none';
  }catch(e){
    $('#loadError').textContent = `Î°úÎìú Ïã§Ìå®: ${e.message}`;
    $('#loadError').style.display='block';
    return;
  }
  // Ï¥àÍ∏∞Ìôî
  flags.clear(); answers={}; $('#scoreBox').innerHTML=''; moduleResults=[];
  dirPanel.innerHTML = fmt(SET.metadata?.directions);
  startModule(0); // Ìï≠ÏÉÅ 1Î™®ÎìàÎ∂ÄÌÑ∞
}

/* ===== Î™®Îìà Ïù¥Îèô/ÌÉÄÏù¥Î®∏ ===== */
function startModule(idx){
  modIdx = idx; qIdx = 0;
  $('#crumb').textContent = `Section 2, Module ${modIdx+1}: Math`;
  // ÌÉÄÏù¥Î®∏
  clearInterval(tickId);
  timerSec = (SET.metadata?.durationMinutesPerModule?.[modIdx] ?? 35) * 60;
  $('#timer').textContent = fmtTime(timerSec);
  tickId = setInterval(()=>{
    timerSec = Math.max(0, timerSec - 1);
    $('#timer').textContent = fmtTime(timerSec);
    if (timerSec === 0) { clearInterval(tickId); openSubmitConfirm(); }
  }, 1000);

  // UI ÌëúÏãú
  $('#card').style.display='block';
  $('#ribbon').style.display='block';
  $('#scoreBox').innerHTML='';
  renderQuestion();
  updateNavOpen();
}

function gotoNextModule(){
  const last = SET.modules.length - 1;
  if (modIdx < last){
    startModule(modIdx + 1);
  } else {
    finishExam(); // ÏïàÏ†ÑÎßù
  }
}

function finishExam(){
  clearInterval(tickId);
  $('#card').style.display='none';
  $('#ribbon').style.display='none';
}

/* ===== Î¨∏Ï†ú/ÌåîÎ†àÌä∏ ===== */
function updateNavOpen(){
  const total = SET.modules[modIdx].questions.length;
  $('#navOpen').textContent = `${qIdx+1}/${total}`;
}

function renderGridModal(){
  const list = SET.modules[modIdx].questions;
  const box = $('#numGrid'); box.innerHTML='';
  list.forEach((q,i)=>{
    const b=document.createElement('button');
    b.className = 'cell';
    if(flags.has(q.id)) b.classList.add('flag');
    if(answers[q.id]!==undefined && answers[q.id]!=='' ) b.classList.add('answered');
    b.textContent = (i+1);
    b.onclick = ()=>{
      qIdx=i; renderQuestion(); updateNavOpen(); $('#gridBack').style.display='none';
    };
    box.appendChild(b);
  });
}

function renderQuestion(){
  const q = SET.modules[modIdx].questions[qIdx];
  $('#qnum').textContent = qIdx+1;

  const fb=$('#flagBtn');
  const flagged=flags.has(q.id);
  fb.className = 'flag-btn' + (flagged?' flagged':'');
  fb.textContent = flagged ? 'Marked for Review' : 'Mark for Review';
  fb.onclick = ()=>{ flagged?flags.delete(q.id):flags.add(q.id); };

  $('#qtitle').innerHTML = q.title || '';
  $('#qstem').innerHTML  = injectImages(fmt(q.prompt));

  const area = $('#choices'); area.innerHTML='';
  if(q.type==='mcq'){
    q.choices.forEach((c,i)=>{
      const row=document.createElement('label'); row.className='choice';
      row.innerHTML = `
        <input type="radio" name="ans" value="${i}" ${String(answers[q.id])===String(i)?'checked':''}/>
        <div class="bubble">${bubbleABC(i)}</div>
        <div class="txt">${c}</div>`;
      if(String(answers[q.id])===String(i)) row.classList.add('selected');
      row.addEventListener('click',()=>{ answers[q.id]=i; renderQuestion(); updateNavOpen(); });
      area.appendChild(row);
    });
  }else{
    const inp=document.createElement('input'); inp.className='gridin';
    inp.placeholder='Enter your answer'; inp.value=answers[q.id]??'';
    inp.oninput=e=>{ answers[q.id]=e.target.value.trim(); updateNavOpen(); };
    area.appendChild(inp);
  }
  typeset();
}

/* ===== ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò ===== */
$('#prevBtn').onclick=()=>{ if(qIdx>0){ qIdx--; renderQuestion(); updateNavOpen(); } };
$('#nextBtn').onclick=()=>{
  const n=SET.modules[modIdx].questions.length;
  if(qIdx<n-1){ qIdx++; renderQuestion(); updateNavOpen(); }
  else{ openSubmitConfirm(); } // Î™®Îìà ÎÅùÏóêÏÑú Ï†úÏ∂ú Ïú†ÎèÑ
};
$('#navOpen').onclick=()=>{ renderGridModal(); $('#gridBack').style.display='block'; };
$('#gridClose').onclick=()=> $('#gridBack').style.display='none';

/* ===== Ï†úÏ∂ú ÌôïÏù∏ ===== */
function openSubmitConfirm(){
  $('#confirmModLabel').textContent = `Module ${modIdx+1}`;
  $('#confirmBack').style.display='block';
}
$('#confirmCancel').onclick=()=> $('#confirmBack').style.display='none';
$('#confirmOk').onclick=()=>{
  $('#confirmBack').style.display='none';
  handleSubmitModule();
};

/* ===== Ï±ÑÏ†ê Î°úÏßÅ ===== */
function gridinEqual(user,q){
  if(user===undefined || user==='') return false;
  if(q.answerNumeric!==undefined){
    const num = Number(user); if(!isNaN(num)){
      const tol = Number(q.tolerance||0);
      if(Math.abs(num-Number(q.answerNumeric))<=tol) return true;
    }
  }
  if(Array.isArray(q.altNumeric)){
    const s=String(user).replace(/\s/g,'');
    return q.altNumeric.some(v=> String(v).replace(/\s/g,'')===s );
  }
  return false;
}
function choiceLabel(i){ return "ABCD".charAt(Number(i)) || ""; }

function evaluateModule(idx){
  const qs = SET.modules[idx].questions;
  let score=0;
  const detail = qs.map((q,qi)=>{
    const user = answers[q.id];
    let correct=false, correctAns='', userDisp='', rationale = q.rationale || '';
    if(q.type==='mcq'){
      correct = Number(user)===Number(q.answer);
      correctAns = `${choiceLabel(q.answer)}. ${q.choices[q.answer]}`;
      userDisp   = (user===undefined||user==='') ? '' : `${choiceLabel(user)}. ${q.choices[user]}`;
    }else{
      correct = gridinEqual(user, q);
      // Ï†ïÎãµ ÌëúÏãúÎäî Ïö∞ÏÑ† answerNumeric, ÏóÜÏúºÎ©¥ altNumericÏùò Ï≤´ Ìï≠Î™©
      if(q.answerNumeric!==undefined) correctAns = String(q.answerNumeric);
      else if(Array.isArray(q.altNumeric) && q.altNumeric.length) correctAns = String(q.altNumeric[0]);
      userDisp = (user??'');
    }
    if(correct) score++;
    return { id:q.id, index:qi+1, module:idx+1, correct, user:userDisp, correctAns, rationale, prompt:q.prompt, title:q.title||'', type:q.type, choices:q.choices||[] };
  });
  return { score, total:qs.length, detail };
}

function handleSubmitModule(){
  clearInterval(tickId);
  // ÌòÑÏû¨ Î™®Îìà Ï±ÑÏ†ê Ï†ÄÏû•
  const result = evaluateModule(modIdx);
  moduleResults[modIdx] = result;

  const last = SET.modules.length - 1;
  if(modIdx < last){
    // Module 1 Ï†úÏ∂ú ‚Üí Module 2 ÏûêÎèô ÏãúÏûë
    // ÏÉÅÎã®ÏóêÎäî Ï†êÏàò Í∞ÑÎã®Ìûà Î≥¥Ïó¨Ï§å
    $('#scoreBox').innerHTML =
      `<div class="qcard" style="margin-top:10px">
        <b>Module ${modIdx+1} Score:</b> ${result.score} / ${result.total}<br>
        Module 2 will start now.
      </div>`;
    startModule(modIdx + 1);
  }else{
    // Module 2 Ï†úÏ∂ú ‚Üí Ï¢ÖÌï© Í≤∞Í≥º
    showCombinedResults();
    finishExam();
  }
}

/* ===== Ï¢ÖÌï© Í≤∞Í≥º & Ìï¥ÏÑ§ ÌåùÏóÖ ===== */
function showCombinedResults(){
  const all = moduleResults.map((r,i)=> r || evaluateModule(i)); // ÌòπÏãú Î™®Îìà1Îßå Ï†ÄÏû•ÎêòÏñ¥ ÏûàÏùÑ Îïå Î≥¥Ï†ï
  const sumScore = all.reduce((s,r)=>s+r.score,0);
  const sumTotal = all.reduce((s,r)=>s+r.total,0);

  // Í≤∞Í≥ºÌåê Íµ¨ÏÑ±
  const root = document.createElement('div');
  root.className='score-wrap';
  root.innerHTML = `
    <div class="qcard">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px">
        <div>
          <div style="font-weight:800; margin-bottom:6px">Review & Explanations</div>
          <div class="scores">
            <span class="pill">Total: <b>${sumScore}</b> / ${sumTotal}</span>
            <span class="pill">Module 1: <b>${all[0].score}</b> / ${all[0].total}</span>
            <span class="pill">Module 2: <b>${all[1].score}</b> / ${all[1].total}</span>
          </div>
          <div class="legend" style="margin-top:6px">Green = Correct, Red = Incorrect, Dashed = Marked for Review</div>
        </div>
      </div>

      <div style="margin-top:12px; font-weight:700">Module 1</div>
      <div class="checkboard" id="board1"></div>

      <div style="margin-top:16px; font-weight:700">Module 2</div>
      <div class="checkboard" id="board2"></div>
    </div>
  `;
  $('#scoreBox').innerHTML = '';
  $('#scoreBox').appendChild(root);

  // Í∞Å Î™®Îìà Î≥¥Îìú Î†åÎçîÎßÅ
  renderResultBoard('#board1', 0, all[0]);
  renderResultBoard('#board2', 1, all[1]);
  typeset(); // ÏàòÏãù Îã§Ïãú ÌÉÄÏûÖÏÖã
}

// Í≤∞Í≥º Î≤àÌò∏Ìåê Î†åÎçîÎßÅ. ÌÅ¥Î¶≠ Ïãú Ìï¥ÏÑ§ ÌåùÏóÖ
function renderResultBoard(sel, mIdx, res){
  const board = document.querySelector(sel); board.innerHTML='';
  res.detail.forEach(d=>{
    const b=document.createElement('button');
    b.className='qb ' + (d.correct?'correct':'wrong');
    if(flags.has(d.id)) b.classList.add('flag');
    b.textContent = d.index;
    b.onclick = ()=> openExplanation(d);
    board.appendChild(b);
  });
}

// Ìï¥ÏÑ§ ÌåùÏóÖ(Î¨∏Ï†ú+Ìï¥ÏÑ§+Ï†ïÎãµ+ÎÇ¥Îãµ). Í≤∞Í≥º Î≥¥Í∏∞ÏóêÏÑúÎßå ÏÇ¨Ïö©.
function openExplanation(d){
  $('#expTitle').textContent = `Module ${d.module} ‚Äî Q${d.index}`;
  const body = $('#expBody'); body.innerHTML = '';

  // Î¨∏Ï†ú Î≥∏Î¨∏
  const qBox = document.createElement('div'); qBox.className='exp-box';
  qBox.innerHTML = `<div style="font-weight:700; margin-bottom:6px">Question</div>
                    <div class="qstem">${injectImages(fmt(d.title?('<div style="text-align:center;font-size:14px;color:#374151">'+d.title+'</div>'):'')+ (d.prompt||''))}</div>`;
  body.appendChild(qBox);

  // Ï†ïÎãµ/ÎÇ¥ Îãµ
  const aBox = document.createElement('div'); aBox.className='exp-box';
  aBox.innerHTML = `
    <div style="font-weight:700; margin-bottom:6px">Answer Summary</div>
    <div class="kv"><b>Correct</b><div>${d.correctAns || '-'}</div></div>
    <div class="kv"><b>Your answer</b><div>${(d.user && d.user!=='')? d.user : '<span style="color:#9ca3af">(no response)</span>'}</div></div>
    <div class="kv"><b>Result</b><div style="font-weight:800; color:${d.correct?'#16a34a':'#dc2626'}">${d.correct?'Correct':'Incorrect'}</div></div>
  `;
  body.appendChild(aBox);

  // Ìï¥ÏÑ§
  const rBox = document.createElement('div'); rBox.className='exp-box';
  rBox.innerHTML = `<div style="font-weight:700; margin-bottom:6px">Explanation</div>
                    <div>${d.rationale || '<span style="color:#9ca3af">No explanation provided.</span>'}</div>`;
  body.appendChild(rBox);

  $('#expBack').style.display='block';
  typeset();
}
$('#expClose').onclick=()=> $('#expBack').style.display='none';
$('#expBack').addEventListener('click',e=>{ if(e.target.id==='expBack') $('#expBack').style.display='none'; });

/* ===== Î≤ÑÌäº/Ï¥àÍ∏∞ ===== */
$('#loadBtn').onclick=()=>loadSet($('#path').value);
$('#hideBtn').onclick=()=>{ const w=$('.wrap'); w.style.display = w.style.display==='none'?'block':'none'; };
window.addEventListener('DOMContentLoaded',()=>loadSet($('#path').value));
</script>
</body>
</html>
