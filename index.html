<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DSAT Practice â€” Classic UI (Enhanced)</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script defer id="MathJax-script"
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
  :root{
    --bg:#fafbfe; --card:#fff; --ink:#111827; --muted:#6b7280;
    --line:#e5e7eb; --accent:#2563eb; --accent-ghost:#e7f0ff;
    --flag:#ef9b0f; --choice:#f7f7fb; --choice-hover:#eef2ff;
    --ok:#16a34a; --ng:#dc2626;
  }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Arial,sans-serif; color:var(--ink); background:var(--bg) }

  /* ===== TOP BAR ===== */
  .topbar{
    position:sticky; top:0; z-index:10; background:#fff;
    border-bottom:1px solid var(--line);
  }
  .topbar-row{
    display:grid; grid-template-columns:1fr auto 1fr; align-items:center;
    gap:10px; padding:6px 14px;
  }
  .crumb{ font-weight:600; font-size:14px }
  .controls{ justify-self:end; display:flex; gap:8px }
  .icon-btn{ border:1px solid var(--line); background:#fff; padding:6px 10px; border-radius:8px; font-size:12px; cursor:pointer }
  .timer-wrap{ justify-self:center; display:flex; align-items:center; gap:8px }
  .timer{ font-weight:800; font-variant-numeric:tabular-nums }
  .hide-btn{ border:1px solid var(--line); background:#fff; padding:3px 8px; border-radius:6px; font-size:12px; cursor:pointer }

  .dir-zone{ display:flex; align-items:center; gap:10px; position:relative }
  .dir-btn{ border:1px solid var(--line); background:#fff; padding:5px 10px; border-radius:8px; font-size:13px; cursor:pointer }
  .dir-panel{
    position:absolute; left:0; top:40px; width:520px; max-width:90vw; background:#fff; border:1px solid var(--line);
    border-radius:12px; padding:12px; font-size:14px; line-height:1.45; box-shadow:0 12px 32px rgba(0,0,0,.08); display:none; z-index:20;
  }
  .dash{ height:6px; background:repeating-linear-gradient(90deg,
      #d9ead3 0 46px, #fff 46px 54px,
      #f9e1ae 54px 98px, #fff 98px 106px,
      #cfe2f3 106px 152px, #fff 152px 160px); opacity:.95 }

  /* ===== ë ˆì´ì•„ì›ƒ ===== */
  .page{
    display:grid; grid-template-columns: 1fr 320px; gap:16px;
    max-width:1280px; margin:12px auto; padding:0 14px;
  }
  .side{ display:none } /* í•´ì„¤íŒ¨ë„ì€ ê²°ê³¼ ë‹¨ê³„ì—ì„œë§Œ í‘œì‹œ */

  /* ===== ì¹´ë“œ ===== */
  .qcard{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,.04) }
  .qhead{ display:flex; align-items:center; gap:10px; margin-bottom:6px }
  .qnum{ min-width:28px; height:28px; display:grid; place-items:center; font-weight:700;
         border:1px solid var(--line); border-radius:6px; padding:0 8px }
  .flag-btn{ margin-left:4px; border:1px solid var(--line); background:#fff; border-radius:8px; padding:4px 10px; cursor:pointer; font-size:13px; color:var(--muted) }
  .flagged{ color:var(--flag); border-color:#fde68a; background:#fffaf0 }
  .qtitle{ text-align:center; color:#0f172a; font-size:14px; margin:4px 0 6px 0 }
  .qstem{ font-size:16px; line-height:1.55; margin:10px 0 12px 0 }
  .choices{ display:grid; gap:10px }

  .choice{ border:1px solid var(--line); background:var(--choice); border-radius:10px; padding:10px 12px; cursor:pointer;
           display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:flex-start; transition:background .15s, border-color .15s; }
  .choice:hover{ background:var(--choice-hover) }
  .bubble{
    width:24px; height:24px; border:1px solid var(--line); border-radius:50%;
    display:grid; place-items:center; font-weight:700; background:#fff; user-select:none; font-size:13px;
  }
  .choice input{ display:none }
  .choice.selected{ border-color:#bfd3ff; background:#eef4ff }
  .choice.selected .bubble{ border-color:var(--accent); color:#fff; background:var(--accent) }

  .gridin{ width:260px; max-width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-size:16px; background:#fff }

  /* ===== í•˜ë‹¨ ê³ ì • ë¦¬ë³¸ ===== */
  .ribbon{
    position:sticky; bottom:0; left:0; right:0; z-index:9;
    background:rgba(255,255,255,.95); backdrop-filter:saturate(1.2) blur(6px);
    border-top:1px solid var(--line);
  }
  .ribbon-row{
    max-width:1280px; margin:0 auto; padding:8px 14px;
    display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px;
  }
  .btn{ border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer }
  .btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent) }
  .btn.ghost{ background:var(--accent-ghost); color:#1d4ed8; border-color:#c3d3ff }

  .progress-box{ border:1px solid var(--line); background:#fff; padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:600 }
  .progress-sub{ font-size:12px; color:var(--muted); margin-left:6px }

  /* ===== ëª¨ë‹¬ ê³µí†µ ===== */
  .modal-back{
    position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; z-index:30;
    align-items:center; justify-content:center; padding:16px;
  }
  .modal{ background:#fff; border:1px solid var(--line); border-radius:12px; width:min(680px, 96vw); max-height:88vh; overflow:auto; box-shadow:0 20px 60px rgba(0,0,0,.18) }
  .modal .head{ padding:12px 16px; border-bottom:1px solid var(--line); font-weight:700 }
  .modal .body{ padding:12px 16px }
  .modal .foot{ padding:12px 16px; border-top:1px solid var(--line); display:flex; gap:8px; justify-content:flex-end }

  /* ë²ˆí˜¸ ê·¸ë¦¬ë“œ */
  .grid{
    display:grid; grid-template-columns:repeat(auto-fill, minmax(44px,1fr)); gap:8px;
  }
  .grid .dot{
    height:42px; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer; font-weight:700; display:grid; place-items:center;
  }
  .dot.answered{ background:#e9fbe7; border-color:#b7f4be }
  .dot.flag{ background:#fff3d6; border-color:#fde68a }
  .dot.active{ outline:2px solid var(--accent) }

  /* ===== ê²°ê³¼í‘œ ===== */
  .score-card{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; }
  .res-table{ width:100%; border-collapse:collapse; font-size:14px }
  .res-table th, .res-table td{ border-top:1px solid var(--line); padding:8px 6px; text-align:left }
  .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-weight:700; font-size:12px }
  .ok{ background:#e8f8ee; color:#166534 }
  .ng{ background:#fdecec; color:#991b1b }

  /* í•´ì„¤ íŒ¨ë„ */
  .side{ position:sticky; top:62px }
  .explain{ display:none; background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; }
  .explain h4{ margin:6px 0 10px 0 }
  .explain .content{ font-size:14px; line-height:1.5 }
  .muted{ color:var(--muted) }
</style>
</head>
<body>

<!-- ===== TOP BAR ===== -->
<div class="topbar">
  <div class="topbar-row">
    <div class="dir-zone">
      <div class="crumb" id="crumb">Section 2, Module 1: Math</div>
      <button class="dir-btn" id="dirToggle">Directions â–¾</button>
      <div class="dir-panel" id="dirPanel"></div>
    </div>
    <div class="timer-wrap">
      <span class="timer" id="timer">35:00</span>
      <button class="hide-btn" id="hideBtn">Hide</button>
    </div>
    <div class="controls">
      <button class="icon-btn">ğŸ”¢ Calculator</button>
      <button class="icon-btn">ğŸ“„ Reference</button>
      <button class="icon-btn">â‹¯ More</button>
    </div>
  </div>
  <div class="dash"></div>
</div>

<!-- ===== PAGE ===== -->
<div class="page">
  <main>
    <div class="qcard" style="margin-bottom:10px">
      <div class="loader" style="display:flex; gap:8px">
        <input id="path" type="text" value="./questions.json" style="width:340px; padding:7px 10px; border:1px solid var(--line); border-radius:8px"/>
        <button class="btn" id="loadBtn">Load set</button>
        <span id="modInfo" class="muted"></span>
      </div>
      <div id="loadError" class="score-card" style="display:none; color:#b42318; background:#fef3f2; border-color:#fecdca"></div>
    </div>

    <div class="qcard" id="card" style="display:none">
      <div class="qhead">
        <div class="qnum" id="qnum">1</div>
        <button id="flagBtn" class="flag-btn">Mark for Review</button>
        <div class="qtitle" id="qtitle" style="margin-left:auto"></div>
      </div>
      <div class="qstem" id="qstem"></div>
      <div class="choices" id="choices"></div>
    </div>

    <div id="scoreBox" style="margin:12px 0"></div>
  </main>

  <!-- í•´ì„¤ ì‚¬ì´ë“œ íŒ¨ë„ (ìµœì¢… ì œì¶œ í›„ë§Œ ë³´ì—¬ì¤Œ) -->
  <aside class="side" id="side">
    <div class="explain" id="explainBox">
      <h4 id="explainTitle">í•´ì„¤</h4>
      <div class="content" id="explainBody">ë¬¸ì œ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ë©´ í•´ì„¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>
  </aside>
</div>

<!-- ===== í•˜ë‹¨ ê³ ì • ë¦¬ë³¸ ===== -->
<div class="ribbon">
  <div class="ribbon-row">
    <div class="nav">
      <button class="btn" id="prevBtn">â† Prev</button>
      <button class="btn" id="nextBtn">Next â†’</button>
    </div>
    <div style="justify-self:center">
      <button class="progress-box" id="progressBtn"><span id="progressNow">1</span>/<span id="progressTotal">22</span> <span class="progress-sub">ë¬¸ì œ ëª©ë¡</span></button>
    </div>
    <div>
      <button class="btn primary" id="submitBtn">Submit</button>
    </div>
  </div>
</div>

<!-- ===== ì œì¶œ í™•ì¸ ëª¨ë‹¬ ===== -->
<div class="modal-back" id="confirmBack">
  <div class="modal">
    <div class="head">ì œì¶œí•˜ì‹œê² ì–´ìš”?</div>
    <div class="body">
      <div style="margin-bottom:8px">í˜„ì¬ <b id="confirmModLabel">Module 1</b>ì„(ë¥¼) ì œì¶œí•©ë‹ˆë‹¤.</div>
      <ul style="margin:0; padding-left:18px; color:var(--muted); font-size:14px">
        <li>ì œì¶œ í›„ì—ëŠ” í•´ë‹¹ ëª¨ë“ˆì˜ ë‹µì•ˆì„ ë” ì´ìƒ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
        <li>ëª¨ë“ˆ 1 ì œì¶œ ì‹œ ìë™ìœ¼ë¡œ ëª¨ë“ˆ 2ê°€ ì‹œì‘ë©ë‹ˆë‹¤.</li>
        <li>ëª¨ë“ˆ 2 ì œì¶œ ì‹œ ì¢…í•© ì •ì˜¤í‘œì™€ í•´ì„¤ íŒ¨ë„ì´ í‘œì‹œë©ë‹ˆë‹¤.</li>
      </ul>
    </div>
    <div class="foot">
      <button class="btn" id="confirmCancel">Cancel</button>
      <button class="btn primary" id="confirmOk">OK</button>
    </div>
  </div>
</div>

<!-- ===== ë²ˆí˜¸ íƒìƒ‰ ëª¨ë‹¬ ===== -->
<div class="modal-back" id="navBack">
  <div class="modal">
    <div class="head">ë¬¸ì œ ì´ë™ â€” <span id="navModTitle">Module 1</span></div>
    <div class="body">
      <div class="grid" id="navGrid"></div>
    </div>
    <div class="foot">
      <button class="btn" id="navClose">Close</button>
    </div>
  </div>
</div>

<script>
/* ===== ìƒíƒœ ===== */
let SET=null, modIdx=0, qIdx=0;
let flags=new Set(), answers={};
/* results: { [qid]: {correct:boolean, user:any, key:any, rationale?:string, module:number, index:number} } */
let results = {};
let timerSec=0, tickId=null;

/* ===== ìœ í‹¸ ===== */
const $ = s=>document.querySelector(s);
const bubbleABC = idx => "ABCD".charAt(idx);
const fmt = s => (s??"").replaceAll("\\n","<br>");
const fmtTime = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
const typeset = ()=> window.MathJax && MathJax.typesetPromise();
const injectImages = html =>
  (html||"").replace(/\[\[IMAGE:\s*([^|\]]+)(?:\|([^\]]+))?\]\]/g,
    (_m,src,alt)=>`<img src="./img/${src.trim()}" alt="${(alt||'problem image').trim()}" style="max-width:100%">`);

/* ===== Directions ===== */
const dirBtn=$('#dirToggle'), dirPanel=$('#dirPanel');
dirBtn.onclick=()=> dirPanel.style.display = dirPanel.style.display==='block'?'none':'block';
document.addEventListener('click',e=>{
  if(!dirPanel.contains(e.target) && e.target!==dirBtn) dirPanel.style.display='none';
});

/* ===== ë¡œë“œ ===== */
async function loadSet(path){
  try{
    const res = await fetch(path, {cache:'no-store'});
    SET = await res.json();
    $('#loadError').style.display='none';
  }catch(e){
    $('#loadError').textContent = `ë¡œë“œ ì‹¤íŒ¨: ${e.message}`;
    $('#loadError').style.display='block';
    return;
  }
  // ì´ˆê¸°í™”
  flags.clear(); answers={}; results={}; $('#scoreBox').innerHTML='';
  $('#explainBox').style.display='none'; $('#side').style.display='none';
  dirPanel.innerHTML = fmt(SET.metadata?.directions);
  $('#progressTotal').textContent = (SET.modules?.[0]?.questions?.length ?? 0);
  startModule(0);
}

/* ===== ëª¨ë“ˆ ì´ë™/íƒ€ì´ë¨¸ ===== */
function startModule(idx){
  modIdx = idx; qIdx = 0;
  const qsLen = SET.modules[modIdx].questions.length;
  $('#crumb').textContent = `${SET.metadata?.title || 'Math'} â€” Module ${modIdx+1}`;
  $('#modInfo').textContent = `Now: Module ${modIdx+1} / ${SET.modules.length} â€¢ ${qsLen}ë¬¸í•­`;
  $('#progressNow').textContent = 1;
  $('#progressTotal').textContent = qsLen;

  // íƒ€ì´ë¨¸ ì‹œì‘(ëª¨ë“ˆë³„)
  clearInterval(tickId);
  timerSec = (SET.metadata?.durationMinutesPerModule?.[modIdx] ?? 35) * 60;
  $('#timer').textContent = fmtTime(timerSec);
  tickId = setInterval(()=>{
    timerSec = Math.max(0, timerSec - 1);
    $('#timer').textContent = fmtTime(timerSec);
    if (timerSec === 0) { clearInterval(tickId); openConfirm(true); } // ì‹œê°„ ì¢…ë£Œ ì‹œ ìë™ ì œì¶œ í™•ì¸
  }, 1000);

  // UI í‘œì‹œ
  $('#card').style.display='block';
  renderQuestion();
}

/* ===== íŒ”ë ˆíŠ¸ â†’ ëª¨ë‹¬ ë‚´ ë²ˆí˜¸ ê·¸ë¦¬ë“œë¡œ ëŒ€ì²´ ===== */
function buildNavGrid(){
  const list = SET.modules[modIdx].questions;
  const grid = $('#navGrid'); grid.innerHTML='';
  list.forEach((q,i)=>{
    const b=document.createElement('button');
    b.className='dot';
    if(i===qIdx) b.classList.add('active');
    if(flags.has(q.id)) b.classList.add('flag');
    if(answers[q.id]!==undefined && answers[q.id]!=='' ) b.classList.add('answered');
    b.textContent=i+1;
    b.onclick=()=>{ qIdx=i; $('#navBack').style.display='none'; renderQuestion(); };
    grid.appendChild(b);
  });
}

/* ===== ë¬¸ì œ í‘œì‹œ ===== */
function renderQuestion(){
  const q = SET.modules[modIdx].questions[qIdx];
  $('#qnum').textContent = qIdx+1;
  $('#progressNow').textContent = qIdx+1;

  const fb=$('#flagBtn');
  const flagged=flags.has(q.id);
  fb.className = 'flag-btn' + (flagged?' flagged':'');
  fb.textContent = flagged ? 'Marked for Review' : 'Mark for Review';
  fb.onclick = ()=>{ flagged?flags.delete(q.id):flags.add(q.id); };

  $('#qtitle').innerHTML = q.title || '';
  $('#qstem').innerHTML  = injectImages(fmt(q.prompt));

  const area = $('#choices'); area.innerHTML='';
  if(q.type==='mcq'){
    q.choices.forEach((c,i)=>{
      const row=document.createElement('label'); row.className='choice';
      row.innerHTML = `
        <input type="radio" name="ans" value="${i}" ${String(answers[q.id])===String(i)?'checked':''}/>
        <div class="bubble">${bubbleABC(i)}</div>
        <div class="txt">${c}</div>`;
      if(String(answers[q.id])===String(i)) row.classList.add('selected');
      row.addEventListener('click',()=>{ answers[q.id]=i; renderQuestion(); });
      area.appendChild(row);
    });
  }else{ // grid-in
    const inp=document.createElement('input'); inp.className='gridin';
    inp.placeholder='Enter your answer'; inp.value=answers[q.id]??'';
    inp.oninput=e=>{ answers[q.id]=e.target.value.trim(); };
    area.appendChild(inp);
  }
  typeset();
}

/* ===== ì •ë‹µ ë¹„êµ ===== */
function gridinEqual(user,q){
  if(user===undefined || user==='') return false;
  if(q.answerNumeric!==undefined){
    const num = Number(user); if(!isNaN(num)){
      const tol = Number(q.tolerance||0);
      if(Math.abs(num-Number(q.answerNumeric))<=tol) return true;
    }
  }
  if(Array.isArray(q.altNumeric)){
    const s=String(user).replace(/\s/g,'');
    return q.altNumeric.some(v=> String(v).replace(/\s/g,'')===s );
  }
  return false;
}

/* ===== ëª¨ë“ˆ ì±„ì  (ê²°ê³¼ ëˆ„ì ) ===== */
function scoreModule(){
  const qs = SET.modules[modIdx].questions;
  let score=0;
  qs.forEach((q, i)=>{
    let ok=false, key=null, user=answers[q.id];
    if(q.type==='mcq'){ ok = Number(user)===Number(q.answer); key = q.answer; }
    else{ ok = gridinEqual(user, q); key = q.answerNumeric ?? q.altNumeric; }
    if(ok) score++;
    results[q.id] = {
      correct: ok, user, key,
      rationale: q.rationale || '',
      module: modIdx, index: i
    };
  });
  return {score, total:qs.length};
}

/* ===== ì œì¶œ í™•ì¸ ëª¨ë‹¬ ===== */
function openConfirm(autoFromTimer=false){
  $('#confirmModLabel').textContent = `Module ${modIdx+1}`;
  $('#confirmBack').style.display='flex';
  // íƒ€ì´ë¨¸ ì •ì§€(ëª¨ë‹¬ ë™ì•ˆ ì¼ì‹œ ì •ì§€)
  clearInterval(tickId);
  // auto submit í‘œì‹œë¥¼ ìœ„í•´ ë©”ì‹œì§€ë¥¼ ì‚´ì§ ë°”ê¿€ ìˆ˜ë„ ìˆì§€ë§Œ ê¸°ëŠ¥ìƒ ë™ì¼ ì²˜ë¦¬
}
function closeConfirm(){
  $('#confirmBack').style.display='none';
  // ëª¨ë“ˆ ì§„í–‰ ì¤‘ì´ë©´ íƒ€ì´ë¨¸ ì¬ê°œ
  if($('#card').style.display!=='none' && !isAllFinished()){
    tickId = setInterval(()=>{
      timerSec = Math.max(0, timerSec - 1);
      $('#timer').textContent = fmtTime(timerSec);
      if (timerSec === 0) { clearInterval(tickId); openConfirm(true); }
    }, 1000);
  }
}
$('#confirmCancel').onclick = closeConfirm;
$('#confirmOk').onclick = ()=>{
  $('#confirmBack').style.display='none';
  // ì±„ì /ë‹¤ìŒ ë‹¨ê³„
  const {score,total} = scoreModule();
  const isLast = (modIdx === SET.modules.length - 1);

  if(!isLast){
    // ëª¨ë“ˆ 1 ì œì¶œ â†’ ëª¨ë“ˆ 2 ì‹œì‘
    $('#scoreBox').innerHTML =
      `<div class="score-card"><b>Module ${modIdx+1} Score:</b> ${score} / ${total}<br><span class="muted">ë‹¤ìŒ ëª¨ë“ˆë¡œ ì´ë™í•©ë‹ˆë‹¤â€¦</span></div>`;
    setTimeout(()=>{ startModule(modIdx+1); $('#scoreBox').innerHTML=''; }, 200); // ë¶€ë“œëŸ½ê²Œ ì „í™˜
  }else{
    // ë§ˆì§€ë§‰ ëª¨ë“ˆ ì œì¶œ â†’ ì¢…í•© ê²°ê³¼
    finishExamAndShowSummary();
  }
};

/* ===== ì „ì²´ ì¢…ë£Œ & ì¢…í•© ì •ì˜¤í‘œ ===== */
function isAllFinished(){ return modIdx === SET.modules.length - 1 && $('#card').style.display==='none'; }

function finishExamAndShowSummary(){
  clearInterval(tickId);
  $('#card').style.display='none';
  // ì‚¬ì´ë“œ í•´ì„¤ íŒ¨ë„ í™œì„±í™”
  $('#side').style.display='block';
  $('#explainBox').style.display='block';

  // ëª¨ë“ˆ2ë„ ì±„ì  ëˆ„ë½ ì—†ë„ë¡ ì•ˆì „ì¥ì¹˜ (ì´ë¯¸ í–ˆì–´ë„ ë™ì¼ê°’)
  const {score:score2,total:total2} = scoreModule(); // í˜„ì¬ ëª¨ë“ˆ

  // ëª¨ë“ˆë³„ ì ìˆ˜ ì§‘ê³„
  let sums = SET.modules.map((_m,idx)=>{
    const list = _m.questions;
    let s=0;
    list.forEach(q=>{ if(results[q.id]?.correct) s++; });
    return {score:s, total:list.length};
  });

  // ê²°ê³¼í‘œ ê·¸ë¦¬ê¸°
  const tableRows = [];
  SET.modules.forEach((m, mi)=>{
    tableRows.push(
      `<tr><th colspan="5" style="background:#f9fafb">Module ${mi+1}</th></tr>`
    );
    m.questions.forEach((q, qi)=>{
      const r = results[q.id] || {};
      const badge = r.correct ? `<span class="badge ok">ì •ë‹µ</span>` : `<span class="badge ng">ì˜¤ë‹µ</span>`;
      tableRows.push(
        `<tr data-qid="${q.id}" class="res-row">
          <td style="width:70px">#${qi+1}</td>
          <td style="width:90px">${badge}</td>
          <td style="width:160px"><span class="muted">${q.type==='mcq'?'MCQ':'Grid-in'}</span></td>
          <td style="width:160px"><span class="muted">ë‚´ ë‹µ:</span> ${escapeHtml(String(r.user ?? ''))}</td>
          <td><button class="btn ghost mini" data-explain="${q.id}">í•´ì„¤ ë³´ê¸°</button></td>
        </tr>`
      );
    });
  });

  $('#scoreBox').innerHTML =
    `<div class="score-card">
       <div style="font-weight:700; margin-bottom:6px">ì¢…í•© ê²°ê³¼</div>
       <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px">
         ${sums.map((s,i)=>`<div>Module ${i+1}: <b>${s.score}/${s.total}</b></div>`).join('')}
       </div>
       <table class="res-table">
         <thead>
           <tr><th>ë¬¸í•­</th><th>ì •ì˜¤</th><th>í˜•ì‹</th><th>ì‘ë‹µ</th><th>í•´ì„¤</th></tr>
         </thead>
         <tbody>${tableRows.join('')}</tbody>
       </table>
       <div class="muted" style="margin-top:10px">í•´ì„¤ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì˜¤ë¥¸ìª½ íŒ¨ë„ì— í•´ì„¤ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
     </div>`;

  // ê²°ê³¼ í™”ë©´ìš© ì´ë²¤íŠ¸ ë°”ì¸ë”© (í•´ì„¤)
  document.querySelectorAll('[data-explain]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const qid = btn.getAttribute('data-explain');
      showExplanation(qid);
    });
  });
}

function showExplanation(qid){
  // í•´ë‹¹ ë¬¸ì œ ì°¾ê¸°
  let meta=null, prompt='', rat='';
  SET.modules.forEach((m,mi)=>{
    m.questions.forEach((q,qi)=>{
      if(q.id===qid){ meta={mi,qi}; prompt=q.prompt; rat=q.rationale||'í•´ì„¤ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'; }
    });
  });
  if(!meta) return;
  $('#explainTitle').textContent = `í•´ì„¤ â€” Module ${meta.mi+1} #${meta.qi+1}`;
  $('#explainBody').innerHTML = `
    <div style="margin-bottom:8px"><b>ë¬¸ì œ</b></div>
    <div class="muted" style="margin-bottom:10px">${injectImages(fmt(prompt))}</div>
    <div style="margin-bottom:8px"><b>í•´ì„¤</b></div>
    <div>${injectImages(fmt(rat))}</div>`;
  typeset();
}

/* ===== ë‚´ë¹„ê²Œì´ì…˜ ===== */
$('#prevBtn').onclick=()=>{ if(!SET) return; if(qIdx>0){ qIdx--; renderQuestion(); } };
$('#nextBtn').onclick=()=>{ if(!SET) return; const n=SET.modules[modIdx].questions.length; if(qIdx<n-1){ qIdx++; renderQuestion(); } };

/* ===== ì œì¶œ ë²„íŠ¼ â†’ í™•ì¸ ëª¨ë‹¬ ===== */
$('#submitBtn').onclick = ()=>{ if(!SET) return; openConfirm(false); };

/* ===== ë²ˆí˜¸ ëª¨ë‹¬ ===== */
$('#progressBtn').onclick = ()=>{ if(!SET) return; $('#navModTitle').textContent=`Module ${modIdx+1}`; buildNavGrid(); $('#navBack').style.display='flex'; };
$('#navClose').onclick = ()=>{ $('#navBack').style.display='none'; };

/* ===== ê¸°íƒ€ ===== */
$('#loadBtn').onclick=()=>loadSet($('#path').value);
$('#hideBtn').onclick=()=>{ const page=document.querySelector('.page'); page.style.display = page.style.display==='none'?'grid':'none'; };

/* ì•ˆì „í•œ text ì¶œë ¥ */
function escapeHtml(t){ return t.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }

/* ì´ˆê¸° ë¡œë“œ */
window.addEventListener('DOMContentLoaded',()=>loadSet($('#path').value));
</script>
</body>
</html>
