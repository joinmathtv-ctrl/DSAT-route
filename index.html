<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Digital SAT Practice</title>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; display:flex; }
    #sidebar { width: 220px; border-right: 1px solid #ccc; padding: 10px; }
    #content { flex:1; padding: 20px; }
    .question { margin-bottom: 20px; }
    .choices label { display:block; margin:5px 0; }
    .palette button { width:40px; height:40px; margin:2px; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>Questions</h3>
    <div id="palette" class="palette"></div>
    <hr>
    <input id="filePath" placeholder="./questions.json" value="./questions.json">
    <button onclick="loadQuestions()">Load</button>
  </div>
  <div id="content">
    <h2 id="title">Loading...</h2>
    <div id="question-container"></div>
    <div>
      <button onclick="prevQ()">Prev</button>
      <button onclick="nextQ()">Next</button>
      <button onclick="submitTest()">Submit</button>
    </div>
    <div id="result"></div>
  </div>

<script>
let data = null;
let current = 0;
let answers = {};

async function loadQuestions() {
  const path = document.getElementById('filePath').value;
  try {
    const res = await fetch(path);
    data = await res.json();
    document.getElementById('title').innerText = data.metadata.title || "DSAT Practice";
    current = 0;
    answers = {};
    renderPalette();
    showQ();
  } catch (e) {
    alert("로드 실패: " + e);
  }
}

function renderPalette(){
  const pal = document.getElementById('palette');
  pal.innerHTML = "";
  data.modules.forEach(m=>{
    m.questions.forEach((q,i)=>{
      const b = document.createElement("button");
      b.innerText = q.id;
      b.onclick = ()=>{currentQ(q.id);};
      pal.appendChild(b);
    });
  });
}

function currentQ(id){
  data.modules.forEach(m=>{
    m.questions.forEach((q,i)=>{
      if(q.id===id){ current = q; showQ(); }
    });
  });
}

function showQ(){
  const q = getCurrent();
  if(!q) return;
  const box = document.getElementById('question-container');
  box.innerHTML = "<div class='question'><b>"+q.prompt+"</b></div>";
  if(q.type==="mcq"){
    const choices = q.choices.map((c,i)=>
      `<label><input type='radio' name='ans' value='${i}' ${(answers[q.id]==i)?"checked":""}> ${c}</label>`
    ).join("");
    box.innerHTML += "<div class='choices'>"+choices+"</div>";
  } else {
    box.innerHTML += `<input type='text' id='gridin' value='${answers[q.id]||""}'>`;
  }
  MathJax.typesetPromise();
}

function getCurrent(){
  for(const m of data.modules){
    for(const q of m.questions){
      if(q.id===current.id || q===data.modules[0].questions[0] && !current){
        return q;
      }
    }
  }
  return null;
}

function prevQ(){ /* TODO: implement prev navigation */ }
function nextQ(){ /* TODO: implement next navigation */ }

function submitTest(){
  let score=0, total=0;
  data.modules.forEach(m=>{
    m.questions.forEach(q=>{
      total++;
      if(q.type==="mcq" && answers[q.id]==q.answer) score++;
      if(q.type==="gridin" && answers[q.id]==q.answerNumeric) score++;
    });
  });
  document.getElementById('result').innerText = "Score: "+score+"/"+total;
}
</script>
</body>
</html>
