<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DSAT Practice â€” Classic UI</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script defer id="MathJax-script"
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
  :root{
    --bg:#fafbfe; --card:#fff; --ink:#1f2937; --muted:#6b7280;
    --line:#e5e7eb; --accent:#2563eb; --accent-ghost:#e7f0ff;
    --flag:#ef9b0f; --choice:#f7f7fb; --choice-hover:#eef2ff;
    --ok:#16a34a; --bad:#ef4444;
  }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Arial,sans-serif; color:var(--ink); background:var(--bg) }

  /* ===== TOP BAR ===== */
  .topbar{
    position:sticky; top:0; z-index:5; background:#fff;
    border-bottom:1px solid var(--line);
  }
  .topbar-row{
    display:grid; grid-template-columns:1fr auto 1fr; align-items:center;
    gap:10px; padding:6px 14px;
  }
  .crumb{ font-weight:600; font-size:14px }
  .controls{ justify-self:end; display:flex; gap:8px }
  .icon-btn{ border:1px solid var(--line); background:#fff; padding:6px 10px; border-radius:8px; font-size:12px; cursor:pointer }
  .timer-wrap{ justify-self:center; display:flex; align-items:center; gap:8px }
  .timer{ font-weight:800; font-variant-numeric:tabular-nums }
  .hide-btn{ border:1px solid var(--line); background:#fff; padding:3px 8px; border-radius:6px; font-size:12px; cursor:pointer }
  .dir-zone{ display:flex; align-items:center; gap:10px }
  .dir-btn{ border:1px solid var(--line); background:#fff; padding:5px 10px; border-radius:8px; font-size:13px; cursor:pointer }
  .dir-panel{
    position:absolute; left:14px; top:44px; width:520px; background:#fff; border:1px solid var(--line);
    border-radius:12px; padding:12px; font-size:14px; line-height:1.45; box-shadow:0 12px 32px rgba(0,0,0,.08); display:none;
  }

  .dash{ height:6px; background:repeating-linear-gradient(90deg,
      #d9ead3 0 46px, #fff 46px 54px,
      #f9e1ae 54px 98px, #fff 98px 106px,
      #cfe2f3 106px 152px, #fff 152px 160px); opacity:.95 }

  /* ===== ë©”ì¸ ===== */
  .wrap{ max-width:1060px; margin:12px auto 88px; padding:0 14px } /* ë¦¬ë³¸ ë†’ì´ë§Œí¼ ì•„ë˜ ì—¬ë°± */
  .loader{ display:flex; gap:8px; margin:6px 0 12px 0 }
  input[type="text"]#path{ width:330px; padding:7px 10px; border:1px solid var(--line); border-radius:8px }
  .btn{ border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer }
  .btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent) }
  .btn.ghost{ background:#fff; }
  .alert{ background:#fef3f2; color:#b42318; border:1px solid #fecdca; padding:10px 12px; border-radius:10px; margin:8px 0; font-size:14px }

  /* ===== ë¬¸ì œ ì¹´ë“œ (ê³µí†µ) ===== */
  .qcard{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,.04) }
  .qhead{ display:flex; align-items:center; gap:10px; margin-bottom:6px }
  .qnum{ width:28px; height:28px; display:grid; place-items:center; font-weight:700; border:1px solid var(--line); border-radius:6px; }
  .flag-btn{ margin-left:4px; border:1px solid var(--line); background:#fff; border-radius:8px; padding:4px 10px; cursor:pointer; font-size:13px; color:var(--muted) }
  .flagged{ color:var(--flag); border-color:#fde68a; background:#fffaf0 }
  .qtitle{ text-align:center; color:#0f172a; font-size:14px; margin:4px 0 6px 0 }
  .qstem{ font-size:16px; line-height:1.55; margin:10px 0 12px 0 }
  .choices{ display:grid; gap:10px }

  .choice{ border:1px solid var(--line); background:var(--choice); border-radius:10px; padding:10px 12px; cursor:pointer;
           display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:flex-start; transition:background .15s, border-color .15s; }
  .choice:hover{ background:var(--choice-hover) }
  .bubble{ width:24px; height:24px; border:1px solid var(--line); border-radius:50%; display:grid; place-items:center; font-weight:700; background:#fff; user-select:none; font-size:13px; }
  .choice input{ display:none }
  .choice.selected{ border-color:#bfd3ff; background:#eef4ff }
  .choice.selected .bubble{ border-color:var(--accent); color:#fff; background:var(--accent) }

  .gridin{ width:260px; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-size:16px; background:#fff }

  /* ===== 2ë¶„í•  ë ˆì´ì•„ì›ƒ (RW/ê°€ì´ë“œ) ===== */
  .gridwrap{ display:grid; grid-template-columns:1.1fr 1.2fr; gap:14px; }
  .spr-left{ border:1px dashed var(--line); background:#fff; border-radius:12px; padding:12px; overflow:auto; max-height:60vh }
  .spr-right{}
  @media (max-width:900px){
    .gridwrap{ grid-template-columns:1fr; }
    .spr-left{ max-height:unset }
  }

  /* ===== ê³ ì • ë¦¬ë³¸ ===== */
  .ribbon{
    position:fixed; left:0; right:0; bottom:0; z-index:6;
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; padding:10px 12px; background:#fff; border-top:1px solid var(--line);
  }
  .r-left,.r-right{ display:flex; gap:20px; align-items:center }
  .r-center{ display:flex; justify-content:center; flex:1 }
  #navOpen{ min-width:120px; font-weight:700 }

  /* ë„¤ë¹„ íŒì—… (ë¦¬ë³¸ ë°”ë¡œ ìœ„ ì¤‘ì•™) */
  .nav-popup{
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:64px; z-index:7; background:#fff; border:1px solid var(--line);
    border-radius:12px; box-shadow:0 16px 36px rgba(0,0,0,.12); padding:12px; display:none; max-width:90vw;
  }
  .nav-grid{ display:grid; grid-template-columns:repeat(11, 36px); gap:6px }
  .dot{ width:36px; height:36px; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer; font-weight:600 }
  .dot.active{ outline:2px solid var(--accent) }
  .dot.answered{ background:#e9fbe7; border-color:#b7f4be }
  .dot.flag{ background:#fff3d6; border-color:#fde68a }

  /* ì œì¶œ í™•ì¸ ëª¨ë‹¬ */
  .modal-back{ position:fixed; inset:0; background:rgba(0,0,0,.36); display:none; z-index:20; }
  .modal{ width:min(560px, 92vw); margin:10vh auto; background:#fff; border-radius:14px; border:1px solid var(--line); padding:14px }
  .modal .head{ font-weight:800; font-size:18px; margin-bottom:6px }
  .modal .body{ font-size:14px; color:var(--ink) }
  .modal .foot{ display:flex; justify-content:flex-end; gap:8px; margin-top:12px }

  /* ê²°ê³¼/í•´ì„¤ ì˜¤ë²„ë ˆì´ (íŒì—…/ìŠ¤í¬ë¡¤ ê°€ëŠ¥) */
  .explain-back{ position:fixed; inset:0; background:rgba(0,0,0,.36); display:none; z-index:30; }
  .explain{ width:min(980px, 95vw); max-height:80vh; overflow:auto;
            margin:8vh auto; background:#fff; border-radius:14px; border:1px solid var(--line); padding:14px }
  .explain .x{ float:right; border:1px solid var(--line); background:#fff; padding:6px 10px; border-radius:8px; cursor:pointer }
  .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; color:#fff }
  .ok{ background:var(--ok) } .bad{ background:var(--bad) }

  /* ê²°ê³¼í‘œ */
  .result-title{ display:flex; justify-content:space-between; align-items:center; gap:8px }
  .result-section{ margin-top:14px }
  .result-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(36px,1fr)); gap:6px }
  .result-dot{ height:36px; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer; font-weight:700 }
  .result-dot.ok{ background:#e9fbe7; border-color:#b7f4be }
  .result-dot.bad{ background:#fee2e2; border-color:#fecaca }

  @media (max-width:560px){
    .nav-grid{ grid-template-columns:repeat(8, 36px) }
  }
</style>
</head>
<body>

<!-- ===== TOP BAR ===== -->
<div class="topbar">
  <div class="topbar-row">
    <div class="dir-zone">
      <div class="crumb" id="crumb">Section â€” Module</div>
      <button class="dir-btn" id="dirToggle">Directions â–¾</button>
      <div class="dir-panel" id="dirPanel"></div>
    </div>
    <div class="timer-wrap">
      <span class="timer" id="timer">35:00</span>
      <button class="hide-btn" id="hideBtn">Hide</button>
    </div>
    <div class="controls">
      <button class="icon-btn">ğŸ”¢ Calculator</button>
      <button class="icon-btn">ğŸ“„ Reference</button>
      <button class="icon-btn">â‹¯ More</button>
    </div>
  </div>
  <div class="dash"></div>
</div>

<div class="wrap">
  <div class="loader">
    <input id="path" type="text" value="./questions.json" />
    <button class="btn" id="loadBtn">Load set</button>
    <!-- ë¡œì»¬ JSON íŒŒì¼ë¡œ ì„¸íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° (ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©) -->
    <input id="file" type="file" accept=".json,application/json" style="margin-left:10px"/>
  </div>
  <div id="loadError" class="alert" style="display:none"></div>

  <!-- ë¬¸ì œ ì¹´ë“œ -->
  <div class="qcard" id="card" style="display:none">
    <div class="qhead">
      <div class="qnum" id="qnum">1</div>
      <button id="flagBtn" class="flag-btn">Mark for Review</button>
    </div>
    <div class="qtitle" id="qtitle"></div>
    <div id="qcontainer"></div>
  </div>

  <div id="scoreBox"></div>
</div>

<!-- ===== í•˜ë‹¨ ê³ ì • ë¦¬ë³¸ ===== -->
<div class="ribbon" id="ribbon" style="display:none">
  <div class="r-left">
    <button class="btn" id="prevBtn">â† Prev</button>
  </div>
  <div class="r-center">
    <button class="btn ghost" id="navOpen">1 / 22 â–¾</button>
  </div>
  <div class="r-right">
    <button class="btn" id="nextBtn">Next â†’</button>
  </div>
</div>

<!-- ë„¤ë¹„ íŒì—… -->
<div class="nav-popup" id="navPopup">
  <div style="font-weight:700; margin-bottom:8px"><span id="navSection">Section</span> Â· Module <span id="navMod">1</span></div>
  <div class="nav-grid" id="navGrid"></div>
</div>

<!-- ===== ì œì¶œ í™•ì¸ ëª¨ë‹¬ ===== -->
<div class="modal-back" id="confirmBack">
  <div class="modal">
    <div class="head">Submit now?</div>
    <div class="body">
      <div style="margin-bottom:8px">You are submitting <b id="confirmModLabel">Section Â· Module</b>.</div>
      <ul style="margin:0; padding-left:18px; color:var(--muted); font-size:14px">
        <li>After submission, answers for this module can no longer be changed.</li>
        <li>If this is Module 1 in a section, Module 2 in the same section will start automatically.</li>
        <li>After the final module (Math Module 2), a combined report and explanations will be shown.</li>
      </ul>
    </div>
    <div class="foot">
      <button class="btn" id="confirmCancel">Cancel</button>
      <button class="btn primary" id="confirmOk">OK</button>
    </div>
  </div>
</div>

<!-- ===== í•´ì„¤ íŒì—… ===== -->
<div class="explain-back" id="explainBack">
  <div class="explain">
    <button class="x" id="explainClose">Close</button>
    <div id="explainBody"></div>
  </div>
</div>

<script>
/* ===== ìƒíƒœ ===== */
let SET=null, modIdx=0, qIdx=0;
let flags=new Set(), answers={};
let timerSec=0, tickId=null;

/* ===== Auto-Save (localStorage) ===== */
let RESTORE_CACHE = null; // ë³µì›ìš© ìºì‹œ(ë¡œë“œ ì§í›„ 1íšŒ ì‚¬ìš©)

function storageKey(){
  // ì„¸íŠ¸ ì‹ë³„ì: ë©”íƒ€ì— idê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ title ê¸°ë°˜
  const id = (SET?.metadata?.id || SET?.id || SET?.metadata?.title || 'default').toString();
  return `dsat_autosave:${id}`;
}

function saveState(){
  try{
    const payload = {
      modIdx,               // í˜„ì¬ ëª¨ë“ˆ ì¸ë±ìŠ¤
      qIdx,                 // í˜„ì¬ ë¬¸í•­ ì¸ë±ìŠ¤
      answers,              // ë¬¸í•­ë³„ ë‚´ ë‹µ
      timers: { [String(modIdx)]: timerSec } // í˜„ì¬ ëª¨ë“ˆ ë‚¨ì€ ì‹œê°„(ì„ íƒ)
    };
    localStorage.setItem(storageKey(), JSON.stringify(payload));
  }catch(e){ /* ë¬´ì‹œ */ }
}

function tryRestore(){
  try{
    const raw = localStorage.getItem(storageKey());
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(_e){ return null; }
}

function clearState(){
  try{ localStorage.removeItem(storageKey()); }catch(_e){}
}


/* ===== ìœ í‹¸ ===== */
const $ = s=>document.querySelector(s);
const bubbleABC = idx => "ABCD".charAt(idx);
const fmt = s => (s??"").replaceAll("\\n","<br>");
const fmtTime = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
const typeset = ()=> window.MathJax && MathJax.typesetPromise();
const injectImages = html =>
  (html||"").replace(/\[\[IMAGE:\s*([^|\]]+)(?:\|([^\]]+))?\]\]/g,
    (_m,src,alt)=>`<img src="./img/${src.trim()}" alt="${(alt||'problem image').trim()}" style="max-width:100%">`);

/* RW ì§€ë¬¸ í†µí•© ìˆ˜ì§‘ */
function getPassageHTML(q){
  const base = q.passageHtml || q.passage || q.passageText || "";
  const imgOne = q.passageImage ? `[[IMAGE: ${q.passageImage}]]` : "";
  const imgMany = Array.isArray(q.passageImages)
    ? q.passageImages.map(fn=>`[[IMAGE: ${fn}]]`).join("<br>")
    : "";
  const all = base + (imgOne || imgMany ? `<div>${imgOne}${imgMany}</div>` : "");
  return injectImages(fmt(all));
}

/* ì„¹ì…˜ ë¼ë²¨/íƒ€ì´ë¨¸ */
function sectionLabel(key){
  const k=(key||'').toLowerCase();
  if(k==='rw'||k==='readingwriting'||k==='reading & writing') return 'Reading & Writing';
  if(k==='math') return 'Math';
  return key || 'Section';
}
function getDurationFor(idx){
  const m = SET.modules[idx] || {};
  const md = SET.metadata?.durationMinutesPerModule;
  if(Array.isArray(md)) return md[idx] ?? 35;
  if(md && typeof md==='object'){
    const key=(m.section||'').toLowerCase();
    const arr=md[key];
    const mi=(m.module? m.module-1 : 0);
    if(Array.isArray(arr)) return arr[mi] ?? 35;
  }
  return 35;
}
function totalQ(mod){ return SET.modules[mod].questions.length; }
function currentQ(){ return SET.modules[modIdx].questions[qIdx]; }

/* ===== Directions ===== */
const dirBtn=$('#dirToggle'), dirPanel=$('#dirPanel');
dirBtn.onclick=()=> dirPanel.style.display = dirPanel.style.display==='block'?'none':'block';
document.addEventListener('click',e=>{
  if(!dirPanel.contains(e.target) && e.target!==dirBtn) dirPanel.style.display='none';
});

/* ===== ë¡œë“œ (URL/íŒŒì¼/ëœë”© ì—°ë™) ===== */
async function loadSet(path){
  try{
    const res = await fetch(path, {cache:'no-store'});
    SET = await res.json();
    $('#loadError').style.display='none';
  }catch(e){
    $('#loadError').textContent = `ë¡œë“œ ì‹¤íŒ¨: ${e.message}`;
    $('#loadError').style.display='block';
    return;
  }

  flags.clear(); answers={}; $('#scoreBox').innerHTML='';
  dirPanel.innerHTML = fmt(SET.metadata?.directions);

  // ì €ì¥ë³¸ ë¶ˆëŸ¬ì˜¤ê¸°
  RESTORE_CACHE = tryRestore();
  if(RESTORE_CACHE){
    answers = RESTORE_CACHE.answers || {};
    const restoreMod = Math.min(RESTORE_CACHE.modIdx ?? 0, SET.modules.length-1);
    startModule(restoreMod);

    // ê°™ì€ ëª¨ë“ˆì˜ ë‚¨ì€ ì‹œê°„ ë³µì›(ì„ íƒ)
    const savedSec = RESTORE_CACHE.timers?.[String(restoreMod)];
    if(typeof savedSec === 'number' && !Number.isNaN(savedSec)){
      timerSec = Math.max(0, savedSec|0);
      $('#timer').textContent = fmtTime(timerSec);
    }

    // ê°™ì€ ë¬¸í•­ìœ¼ë¡œ ì´ë™
    qIdx = Math.min(RESTORE_CACHE.qIdx ?? 0, totalQ(modIdx)-1);
    renderQuestion(); renderNavButton();
  } else {
    startModule(0);
  }
}

// ëœë”©ì—ì„œ ë„˜ê¸´ ë¡œì»¬ íŒŒì¼(JSON í…ìŠ¤íŠ¸)ë¡œ ì‹œì‘
function bootFromBlob(){
  const key = 'dsat_launch_blob';
  const text = localStorage.getItem(key);
  if(!text){
    $('#loadError').textContent = 'No pending set. Please start from the landing page.';
    $('#loadError').style.display = 'block';
    return;
  }
  try{
    SET = JSON.parse(text);
    localStorage.removeItem(key); // 1íšŒ ì‚¬ìš© í›„ ì œê±°

    $('#loadError').style.display='none';
    flags.clear(); answers={}; $('#scoreBox').innerHTML='';
    dirPanel.innerHTML = fmt(SET.metadata?.directions);

    RESTORE_CACHE = tryRestore();
    if(RESTORE_CACHE){
      answers = RESTORE_CACHE.answers || {};
      const restoreMod = Math.min(RESTORE_CACHE.modIdx ?? 0, (SET.modules?.length||1)-1);
      startModule(restoreMod);
      const savedSec = RESTORE_CACHE.timers?.[String(restoreMod)];
      if(typeof savedSec === 'number' && !Number.isNaN(savedSec)){
        timerSec = Math.max(0, savedSec|0);
        $('#timer').textContent = fmtTime(timerSec);
      }
      qIdx = Math.min(RESTORE_CACHE.qIdx ?? 0, totalQ(modIdx)-1);
      renderQuestion(); renderNavButton();
    } else {
      startModule(0);
    }
  }catch(e){
    $('#loadError').textContent = 'Failed to parse set from landing page: ' + e.message;
    $('#loadError').style.display='block';
  }
}

/* ===== ëª¨ë“ˆ/íƒ€ì´ë¨¸ ===== */
function startModule(idx){
  modIdx = idx; qIdx = 0;
  const m=SET.modules[modIdx];
  const secTxt = sectionLabel(m.section);
  $('#crumb').textContent = `${SET.metadata?.title || 'DSAT Practice'} â€” ${secTxt} Â· Module ${m.module||1}`;
  clearInterval(tickId);
  timerSec = getDurationFor(modIdx) * 60;
  $('#timer').textContent = fmtTime(timerSec);
  tickId = setInterval(()=>{
    timerSec = Math.max(0, timerSec - 1);
    $('#timer').textContent = fmtTime(timerSec);
    if (timerSec % 5 === 0) saveState(); // 5ì´ˆë§ˆë‹¤ ìŠ¤ëƒ…ìƒ· ì €ì¥
    if (timerSec === 0) { clearInterval(tickId); openSubmitConfirm(); }
  }, 1000);

  $('#card').style.display='block';
  $('#ribbon').style.display='flex';
  renderQuestion();
  renderNavButton();
  hideNavPopup();
  $('#scoreBox').innerHTML='';
}
function gotoNextModule(){
  const last = SET.modules.length - 1;
  if (modIdx < last){
    startModule(modIdx + 1);
  } else {
    showFinalReport();
  }
}

/* ===== ë¬¸ì œ í‘œì‹œ ===== */
function renderQuestion(){
  const q = currentQ();
  $('#qnum').textContent = qIdx+1;

  const fb=$('#flagBtn');
  const flagged=flags.has(q.id);
  fb.className = 'flag-btn' + (flagged?' flagged':'');
  fb.textContent = flagged ? 'Marked for Review' : 'Mark for Review';
  fb.onclick = ()=>{ flagged?flags.delete(q.id):flags.add(q.id); renderQuestion(); };

  $('#qtitle').innerHTML = q.title || '';

  const qc = $('#qcontainer');
  qc.innerHTML = '';

  const hasPassage = !!(q.passageHtml || q.passage || q.passageText || q.passageImage || (q.passageImages && q.passageImages.length));
  const hasGridGuide = (q.type==='gridin') && !!(q.gridGuideHtml || q.gridGuideImage);
  const needSplit = (q.layout === 'split') || hasPassage || hasGridGuide;

  if(needSplit){
    const wrap = document.createElement('div');
    wrap.className='gridwrap';

    const left = document.createElement('div'); left.className='spr-left';
    if(hasPassage){
      left.innerHTML = getPassageHTML(q);
    }else if(hasGridGuide){
      left.innerHTML = q.gridGuideHtml
        ? injectImages(fmt(q.gridGuideHtml))
        : injectImages(`[[IMAGE: ${q.gridGuideImage}|grid guide]]`);
    }else{
      left.innerHTML = `<div style="color:var(--muted)">No passage</div>`;
    }

    const right = document.createElement('div'); right.className='spr-right';
    const stem = document.createElement('div'); stem.className='qstem';
    stem.innerHTML = injectImages(fmt(q.prompt));
    right.appendChild(stem);

    const area = document.createElement('div'); area.className='choices';
    if(q.type==='mcq'){
      (q.choices||[]).forEach((c,i)=>{
        const row=document.createElement('label'); row.className='choice';
        row.innerHTML = `
          <input type="radio" name="ans" value="${i}" ${String(answers[q.id])===String(i)?'checked':''}/>
          <div class="bubble">${bubbleABC(i)}</div>
          <div class="txt">${c}</div>`;
        if(String(answers[q.id])===String(i)) row.classList.add('selected');
        row.addEventListener('click',()=>{
          answers[q.id]=i;
          saveState();
          renderQuestion(); renderNavButton();
        });
        area.appendChild(row);
      });
    }else{
      const inp=document.createElement('input'); inp.className='gridin';
      inp.placeholder='Enter your answer'; inp.value=answers[q.id]??'';
      inp.oninput=e=>{
        answers[q.id]=e.target.value.trim();
        saveState();
        renderNavButton();
      };
      area.appendChild(inp);
    }
    right.appendChild(area);

    wrap.appendChild(left); wrap.appendChild(right);
    qc.appendChild(wrap);
  }else{
    const stem = document.createElement('div'); stem.className='qstem';
    stem.innerHTML = injectImages(fmt(q.prompt));
    qc.appendChild(stem);

    const area = document.createElement('div'); area.className='choices';
    if(q.type==='mcq'){
      (q.choices||[]).forEach((c,i)=>{
        const row=document.createElement('label'); row.className='choice';
        row.innerHTML = `
          <input type="radio" name="ans" value="${i}" ${String(answers[q.id])===String(i)?'checked':''}/>
          <div class="bubble">${bubbleABC(i)}</div>
          <div class="txt">${c}</div>`;
        if(String(answers[q.id])===String(i)) row.classList.add('selected');
        row.addEventListener('click',()=>{
          answers[q.id]=i;
          saveState();
          renderQuestion(); renderNavButton();
        });
        area.appendChild(row);
      });
    }else{
      const inp=document.createElement('input'); inp.className='gridin';
      inp.placeholder='Enter your answer'; inp.value=answers[q.id]??'';
      inp.oninput=e=>{
        answers[q.id]=e.target.value.trim();
        saveState();
        renderNavButton();
      };
      area.appendChild(inp);
    }
    qc.appendChild(area);
  }

  typeset();
  renderNavButton();
}

/* ===== ë„¤ë¹„ ë¦¬ë³¸ & íŒì—… ===== */
function renderNavButton(){
  const total = totalQ(modIdx);
  $('#navOpen').textContent = `${qIdx+1} / ${total} â–¾`;
  const m=SET.modules[modIdx];
  $('#navSection').textContent = sectionLabel(m.section);
  $('#navMod').textContent = (m.module || 1);
}
const navPopup = $('#navPopup');
$('#navOpen').onclick = ()=>{
  if(navPopup.style.display==='block') hideNavPopup();
  else showNavPopup();
};
function showNavPopup(){
  const grid = $('#navGrid'); grid.innerHTML='';
  const list = SET.modules[modIdx].questions;
  list.forEach((q,i)=>{
    const b=document.createElement('button');
    b.className='dot';
    if(i===qIdx) b.classList.add('active');
    if(flags.has(q.id)) b.classList.add('flag');
    if(answers[q.id]!==undefined && answers[q.id]!=='' ) b.classList.add('answered');
    b.textContent=i+1;
    b.onclick=()=>{ qIdx=i; renderQuestion(); showNavPopup(); };
    grid.appendChild(b);
  });
  navPopup.style.display='block';
}
function hideNavPopup(){ navPopup.style.display='none'; }

/* ===== ì œì¶œ(ëª¨ë“ˆ ê²½ê³„) ===== */
const confirmBack = $('#confirmBack');
function openSubmitConfirm(){
  const m=SET.modules[modIdx];
  $('#confirmModLabel').textContent = `${sectionLabel(m.section)} â€” Module ${m.module||1}`;
  confirmBack.style.display='block';
}
$('#confirmCancel').onclick = ()=> confirmBack.style.display='none';
$('#confirmOk').onclick = ()=>{
  confirmBack.style.display='none';
  saveState(); // ì œì¶œ ì§ì „ ìŠ¤ëƒ…ìƒ·
  gotoNextModule();
};

/* ===== ë²„íŠ¼ ì•¡ì…˜ ===== */
$('#prevBtn').onclick=()=>{ if(qIdx>0){ qIdx--; saveState(); renderQuestion(); } hideNavPopup(); };
$('#nextBtn').onclick=()=>{
  const n=totalQ(modIdx);
  if(qIdx<n-1){ qIdx++; saveState(); renderQuestion(); hideNavPopup(); }
  else{ openSubmitConfirm(); }
};

/* ===== ì±„ì  ===== */
function gridinEqual(user,q){
  if(user===undefined || user==='') return false;
  if(q.answerNumeric!==undefined){
    const num = Number(user); if(!isNaN(num)){
      const tol = Number(q.tolerance||0);
      if(Math.abs(num-Number(q.answerNumeric))<=tol) return true;
    }
  }
  if(Array.isArray(q.altNumeric)){
    const s=String(user).replace(/\s/g,'');
    return q.altNumeric.some(v=> String(v).replace(/\s/g,'')===s );
  }
  return false;
}
function isCorrect(q){
  if(q.type==='mcq') return Number(answers[q.id])===Number(q.answer);
  return gridinEqual(answers[q.id], q);
}
/* ===== ìŠ¤í‚¬ ìš”ì•½ ìœ í‹¸ ===== */
// ê° ë¬¸í•­ì˜ ìŠ¤í‚¬ ì½”ë“œ ë°°ì—´ì„ ì¶”ì¶œ (ì—†ìœ¼ë©´ ë¹ˆë°°ì—´)
// ì‚¬ìš© ê°€ëŠ¥í•œ í‚¤: q.skills | q.tags | q.topics
function getSkillCodes(q){
  const raw = q.skills || q.tags || q.topics || [];
  if (!Array.isArray(raw)) return [];
  return raw.map(s=>String(s).trim()).filter(Boolean);
}

// ì „ì²´ ì„¸íŠ¸ì˜ ìŠ¤í‚¬ë³„ {correct,total} ì§‘ê³„
function collectSkillStats(){
  const stats = {}; // code -> {correct,total}
  (SET.modules || []).forEach(m=>{
    (m.questions || []).forEach(q=>{
      const codes = getSkillCodes(q);
      if(!codes.length) return;
      const ok = isCorrect(q);
      codes.forEach(code=>{
        if(!stats[code]) stats[code] = {correct:0,total:0};
        stats[code].total += 1;
        if(ok) stats[code].correct += 1;
      });
    });
  });
  return stats;
}

// Top3/Bottom3 ì¹´ë“œ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
function buildSkillSummaryCard(minCount){
  const stats = collectSkillStats();
  const entries = Object.entries(stats).map(([code, v])=>({
    code,
    correct: v.correct,
    total: v.total,
    acc: v.total ? v.correct / v.total : 0
  }));
  const eligible = entries.filter(e=> e.total >= minCount).sort((a,b)=> b.acc - a.acc);

  const wrap = document.createElement('div');
  wrap.className = 'qcard';
  const headNote = `<span style="color:var(--muted); font-size:13px">Â· ìµœì†Œ ${minCount}ë¬¸í•­ ê¸°ì¤€</span>`;

  if(eligible.length === 0){
    wrap.innerHTML = `
      <div class="result-title">
        <div><b>Skill Summary</b> ${headNote}</div>
      </div>
      <div style="margin-top:6px; color:var(--muted); font-size:14px">
        ìŠ¤í‚¬ íƒœê·¸ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¬¸í•­ JSONì— <code>"skills": ["FUNC_LINEAR","RATIO"]</code> í˜•íƒœë¡œ íƒœê·¸ë¥¼ ì¶”ê°€í•˜ë©´ ìš”ì•½ì´ í‘œì‹œë©ë‹ˆë‹¤.
      </div>`;
    return wrap;
  }

  const strengths = eligible.slice(0,3);
  const weaknesses = eligible.slice(-3).reverse();

  const li = (e)=> `
    <li style="display:flex; justify-content:space-between; gap:10px; border:1px solid var(--line);
               border-radius:10px; padding:8px 10px; background:#fff">
      <span>${e.code}</span>
      <span style="font-variant-numeric:tabular-nums">${Math.round(e.acc*100)}% <span style="color:var(--muted)">(${e.correct}/${e.total})</span></span>
    </li>`;

  wrap.innerHTML = `
    <div class="result-title">
      <div><b>Skill Summary</b> ${headNote}</div>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px">
      <div>
        <div style="font-weight:700; color:#065f46; margin-bottom:6px">Top strengths</div>
        <ul style="list-style:none; margin:0; padding:0; display:grid; gap:6px">
          ${strengths.map(li).join('')}
        </ul>
      </div>
      <div>
        <div style="font-weight:700; color:#991b1b; margin-bottom:6px">Needs work</div>
        <ul style="list-style:none; margin:0; padding:0; display:grid; gap:6px">
          ${weaknesses.map(li).join('')}
        </ul>
      </div>
    </div>`;
  return wrap;
}


/* ===== ìµœì¢… ê²°ê³¼í‘œ & í•´ì„¤ íŒì—… ===== */
function showFinalReport(){
  clearInterval(tickId);
  clearState(); // ì´ ì„¸íŠ¸ì˜ ìë™ ì €ì¥ë³¸ ì œê±°(ì„ íƒ)
  $('#card').style.display='none';
  $('#ribbon').style.display='none';
  hideNavPopup();

  // ê²°ê³¼ ìƒë‹¨ ë„êµ¬ ëª¨ìŒ (CSV)
  const box = $('#scoreBox'); box.innerHTML='';
  const tool = document.createElement('div');
  tool.className = 'qcard';
  tool.innerHTML = `
    <div class="result-title">
      <div><b>${SET.metadata?.title || 'DSAT Practice'} â€” Combined Report</b></div>
      <div><button class="btn" id="csvBtn">Download CSV</button></div>
    </div>`;
  box.appendChild(tool);
  $('#csvBtn').onclick = downloadCSV;

// ìŠ¤í‚¬ ìš”ì•½ ì¹´ë“œ(Top3/Bottom3) â€” ìµœì†Œ 2ë¬¸í•­ ì´ìƒì¸ ìŠ¤í‚¬ë§Œ ì§‘ê³„
box.appendChild( buildSkillSummaryCard(2) );

  // ì„¹ì…˜ë³„ ê·¸ë£¹í™” (rw, math)
  const groups = {};
  SET.modules.forEach((m,mi)=>{
    const key=(m.section||'misc').toLowerCase();
    if(!groups[key]) groups[key]=[];
    groups[key].push({mi, module:m.module||1, questions:m.questions});
  });

  // ì„¹ì…˜ ìˆœì„œ ë³´ì¡´ (rw -> math -> ê¸°íƒ€)
  const order = Object.keys(groups).sort((a,b)=>{
    const rank = k => (k==='rw'?1 : k==='math'?2 : 9);
    return rank(a)-rank(b);
  });

  // ì„¹ì…˜ë³„ ë Œë”ë§
  order.forEach(secKey=>{
    const secName = sectionLabel(secKey);
    const mods = groups[secKey].sort((a,b)=>a.module-b.module);
    // ì„¹ì…˜ ì´ê³„
    let secTotal=0, secCorrect=0;
    const perModule=[];
    mods.forEach(m=>{
      const detail = m.questions.map((q,qi)=>({
        id:q.id, number:qi+1, ok:isCorrect(q), q
      }));
      const corr = detail.filter(d=>d.ok).length;
      perModule.push({module:m.module, total:m.questions.length, correct:corr, detail});
      secTotal += m.questions.length; secCorrect += corr;
    });

    // ì„¹ì…˜ í—¤ë” + ì„¹ì…˜ ì •ì˜¤í‘œ(ëª¨ë“ˆ1,2)
    const header = document.createElement('div');
    header.className='qcard';
    header.style.marginTop='10px';
    header.innerHTML = `
      <div class="result-title">
        <div><b>${secName} â€” Total:</b> ${secCorrect} / ${secTotal}</div>
        <div><span class="badge ok">Correct</span> <span class="badge bad" style="margin-left:8px">Wrong</span></div>
      </div>
      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap">
        ${perModule.map(pm=>`
          <div class="qcard" style="flex:1; min-width:180px">
            <div><b>Module ${pm.module}</b></div>
            <div style="margin-top:6px">${pm.correct} / ${pm.total}</div>
          </div>`).join('')}
      </div>`;
    box.appendChild(header);

    // ëª¨ë“ˆë³„ ì •ì˜¤í‘œ
    perModule.forEach(pm=>{
      const wrap=document.createElement('div'); wrap.className='qcard result-section';
      const cells = pm.detail.map(d=>{
        const cls = d.ok ? 'ok' : 'bad';
        const flag = flags.has(d.id) ? ' flag' : '';
        return `<button class="result-dot ${cls}${flag}" data-section="${secKey}" data-module="${pm.module}" data-num="${d.number}" title="${secName} Â· Module ${pm.module} Â· Q${d.number}">${d.number}</button>`;
      }).join('');
      wrap.innerHTML = `
        <b>${secName} â€” Module ${pm.module} Â· ì •ì˜¤í‘œ</b>
        <div class="result-grid" style="margin-top:10px">${cells}</div>`;
      box.appendChild(wrap);
    });
  });

  // í´ë¦­ ë°”ì¸ë”© (í•´ì„¤ íŒì—…)
  document.querySelectorAll('.result-dot').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const secKey=btn.getAttribute('data-section');
      const modNo=Number(btn.getAttribute('data-module'));
      const num=Number(btn.getAttribute('data-num'));
      const modRec = SET.modules.find(m => (m.section||'').toLowerCase()===secKey && Number(m.module||1)===modNo);
      if(!modRec) return;
      const mi = SET.modules.indexOf(modRec);
      const q = SET.modules[mi].questions[num-1];
      openExplain(sectionLabel(secKey), modNo, num, q, isCorrect(q));
    });
  });
}

const explainBack = $('#explainBack');
const explainBody = $('#explainBody');
$('#explainClose').onclick = ()=>{ explainBack.style.display='none'; explainBody.innerHTML=''; };

function openExplain(secName, modNo, idx, q, ok){
  const your = answers[q.id];
  const yourDisp = (q.type==='mcq' && your!==undefined) ? q.choices[Number(your)] : (your ?? '');
  const correctDisp = (q.type==='mcq') ? (Array.isArray(q.choices)? q.choices[q.answer] : q.answer) : (q.answerNumeric ?? q.altNumeric?.[0] ?? '');
  const badge = ok?'<span class="badge ok">Correct</span>':'<span class="badge bad">Wrong</span>';

  const passageBlock = (q.passageHtml || q.passage || q.passageText || q.passageImage || (q.passageImages&&q.passageImages.length)) ? `
    <div class="qcard" style="margin-bottom:10px">
      <div style="font-weight:700; margin-bottom:6px">Passage</div>
      <div class="qstem">${getPassageHTML(q)}</div>
    </div>` : '';

  const choicesBlock = (q.type==='mcq')
    ? `<div class="choices" style="margin-top:8px">${q.choices.map((c,i)=>`
        <div class="choice" style="pointer-events:none; ${i===q.answer?'border-color:#b7f4be;background:#e9fbe7':''}">
          <div class="bubble">${bubbleABC(i)}</div><div class="txt">${c}</div>
        </div>`).join('')}</div>`
    : '';

  explainBody.innerHTML = `
    <div style="margin-bottom:8px; font-weight:800">${secName} Â· Module ${modNo} Â· Question ${idx} ${badge}</div>
    <div style="margin-bottom:10px; color:var(--muted); font-size:13px">${q.type==='mcq'?'Multiple Choice':'Student-Produced Response'}</div>
    ${passageBlock}
    <div class="qcard" style="margin-bottom:10px">
      <div class="qstem">${injectImages(fmt(q.prompt))}</div>
      ${choicesBlock}
    </div>
    <div class="qcard" style="margin-bottom:10px">
      <div><b>Correct Answer:</b> ${correctDisp}</div>
      <div style="margin-top:6px"><b>Your Answer:</b> ${yourDisp===''||yourDisp===undefined?'<i>(blank)</i>':yourDisp}</div>
    </div>
    ${q.rationale ? `<div class="qcard"><b>Explanation</b><div style="margin-top:6px">${fmt(q.rationale)}</div></div>`:''}
  `;
  explainBack.style.display='block';
  typeset();
}

/* ===== ê¸°íƒ€: ìˆ˜ë™ ë¡œë“œ/íŒŒì¼ ë¡œë“œ/ë¶€íŠ¸ìŠ¤íŠ¸ë© ===== */
$('#loadBtn').onclick=()=>loadSet($('#path').value);
$('#hideBtn').onclick=()=>{ const w=$('.wrap'); w.style.display = w.style.display==='none'?'block':'none'; };

// íŒŒì¼ë¡œ ì„¸íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°(ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©)
async function loadSetFromFile(file){
  try{
    const text = await file.text();
    SET = JSON.parse(text);
    $('#loadError').style.display='none';

    // loadSet() ì´í›„ì™€ ë™ì¼ ì´ˆê¸°í™”
    flags.clear(); answers={}; $('#scoreBox').innerHTML='';
    dirPanel.innerHTML = fmt(SET.metadata?.directions);

    RESTORE_CACHE = tryRestore();
    if(RESTORE_CACHE){
      answers = RESTORE_CACHE.answers || {};
      const restoreMod = Math.min(RESTORE_CACHE.modIdx ?? 0, SET.modules.length-1);
      startModule(restoreMod);
      const savedSec = RESTORE_CACHE.timers?.[String(restoreMod)];
      if(typeof savedSec === 'number' && !Number.isNaN(savedSec)){
        timerSec = Math.max(0, savedSec|0);
        $('#timer').textContent = fmtTime(timerSec);
      }
      qIdx = Math.min(RESTORE_CACHE.qIdx ?? 0, totalQ(modIdx)-1);
      renderQuestion(); renderNavButton();
    } else {
      startModule(0);
    }
  }catch(e){
    $('#loadError').textContent = `íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: ${e.message}`;
    $('#loadError').style.display='block';
  }
}
$('#file').addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(f) loadSetFromFile(f);
});

// ===== CSV ë‚´ë³´ë‚´ê¸° =====
function csvEscape(v){
  const s = (v===undefined || v===null) ? '' : String(v);
  return `"${s.replace(/"/g, '""')}"`;
}
function userAnswerDisplay(q){
  const your = answers[q.id];
  if(q.type==='mcq'){
    if(your===undefined || your==='') return '';
    const idx = Number(your);
    const txt = Array.isArray(q.choices) ? q.choices[idx] : '';
    return `${"ABCD".charAt(idx)}. ${txt??''}`;
  }
  return your ?? '';
}
function correctAnswerDisplay(q){
  if(q.type==='mcq'){
    const txt = Array.isArray(q.choices) ? q.choices[q.answer] : q.answer;
    return `${"ABCD".charAt(Number(q.answer))}. ${txt??''}`;
  }
  return (q.answerNumeric ?? (Array.isArray(q.altNumeric)? q.altNumeric[0] : '')) ?? '';
}
function buildCSV(){
  const header = ['Section','Module','Number','QuestionID','Type','Correct','YourAnswer','CorrectAnswer','Flagged'];
  const rows = [header];

  // ì„¹ì…˜ë³„ ê·¸ë£¹í™”
  const groups = {};
  SET.modules.forEach((m,mi)=>{
    const key=(m.section||'misc').toLowerCase();
    if(!groups[key]) groups[key]=[];
    groups[key].push({mi, module:m.module||1, questions:m.questions});
  });
  const order = Object.keys(groups).sort((a,b)=>{
    const rank = k => (k==='rw'?1 : k==='math'?2 : 9);
    return rank(a)-rank(b);
  });

  order.forEach(secKey=>{
    const secName = sectionLabel(secKey);
    const mods = groups[secKey].sort((a,b)=>a.module-b.module);
    mods.forEach(m=>{
      m.questions.forEach((q,qi)=>{
        rows.push([
          secName,
          m.module,
          qi+1,
          q.id,
          q.type,
          isCorrect(q) ? 'Y' : 'N',
          userAnswerDisplay(q),
          correctAnswerDisplay(q),
          flags.has(q.id) ? 'Y' : 'N'
        ]);
      });
    });
  });

  return rows.map(r=> r.map(csvEscape).join(',')).join('\r\n');
}
function downloadCSV(){
  const csv = buildCSV();
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const base = (SET.metadata?.title || 'dsat_set').replace(/[^\w\-]+/g,'_');
  a.download = `${base}_results.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// íŒì—… ì™¸ë¶€ í´ë¦­ ë‹«ê¸° (ë„¤ë¹„)
document.addEventListener('click', (e)=>{
  if(!$('#navPopup').contains(e.target) && e.target!==$('#navOpen')) hideNavPopup();
});

/* ===== ë¶€íŠ¸ìŠ¤íŠ¸ë©: ëœë”©/ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ê¸°ì¤€ìœ¼ë¡œë§Œ ì‹œì‘ ===== */
window.addEventListener('DOMContentLoaded', ()=>{
  const qs = new URLSearchParams(location.search);
  const url = qs.get('set');
  const src = qs.get('source');

  if (url) {
    // URL ëª¨ë“œ: ì¿¼ë¦¬ì˜ set= ì„ ì‚¬ìš©
    $('#path').value = url;
    document.querySelector('.loader')?.style && (document.querySelector('.loader').style.display='none');
    loadSet(url);
  } else if (src === 'blob') {
    // íŒŒì¼ ëª¨ë“œ: ëœë”©ì—ì„œ ë„˜ê¸´ JSON í…ìŠ¤íŠ¸ ì‚¬ìš©
    document.querySelector('.loader')?.style && (document.querySelector('.loader').style.display='none');
    bootFromBlob();
  } else {
    // ì•„ë¬´ ê²ƒë„ ìë™ ì‹œì‘í•˜ì§€ ì•ŠìŒ(ëœë”©ì—ì„œë§Œ ì§„ì…í•˜ë„ë¡)
    // ê°œë°œ í¸ì˜ë¥¼ ìœ„í•´ ìƒë‹¨ ë¡œë”ëŠ” ë‚¨ê²¨ë‘ 
  }
});
</script>
</body>
</html>
