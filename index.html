<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DSAT Practice — Classic UI</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script defer id="MathJax-script"
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
  :root{
    --bg:#fafbfe; --card:#fff; --ink:#1f2937; --muted:#6b7280;
    --line:#e5e7eb; --accent:#2563eb; --accent-ghost:#e7f0ff;
    --flag:#ef9b0f; --choice:#f7f7fb; --choice-hover:#eef2ff;
    --ok:#e9fbe7; --ok-border:#b7f4be; --bad:#ffe6e6; --bad-border:#f3b0b0;
  }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Arial,sans-serif; color:var(--ink); background:var(--bg) }

  /* ===== TOP BAR ===== */
  .topbar{
    position:sticky; top:0; z-index:5; background:#fff;
    border-bottom:1px solid var(--line);
  }
  .topbar-row{
    display:grid; grid-template-columns:1fr auto 1fr; align-items:center;
    gap:10px; padding:6px 14px;
  }
  .crumb{ font-weight:600; font-size:14px }
  .controls{ justify-self:end; display:flex; gap:8px }
  .icon-btn{ border:1px solid var(--line); background:#fff; padding:6px 10px; border-radius:8px; font-size:12px; cursor:pointer }
  .timer-wrap{ justify-self:center; display:flex; align-items:center; gap:8px }
  .timer{ font-weight:800; font-variant-numeric:tabular-nums }
  .hide-btn{ border:1px solid var(--line); background:#fff; padding:3px 8px; border-radius:6px; font-size:12px; cursor:pointer }

  /* Directions */
  .dir-zone{ display:flex; align-items:center; gap:10px }
  .dir-btn{ border:1px solid var(--line); background:#fff; padding:5px 10px; border-radius:8px; font-size:13px; cursor:pointer }
  .dir-panel{
    position:absolute; left:14px; top:44px; width:520px; background:#fff; border:1px solid var(--line);
    border-radius:12px; padding:12px; font-size:14px; line-height:1.45; box-shadow:0 12px 32px rgba(0,0,0,.08); display:none;
  }

  .dash{ height:6px; background:repeating-linear-gradient(90deg,
      #d9ead3 0 46px, #fff 46px 54px,
      #f9e1ae 54px 98px, #fff 98px 106px,
      #cfe2f3 106px 152px, #fff 152px 160px); opacity:.95 }

  /* ===== 메인 ===== */
  .wrap{ max-width:1160px; margin:12px auto; padding:0 14px; display:grid; grid-template-columns: 1fr 320px; gap:16px }
  .loader{ grid-column:1 / -1; display:flex; gap:8px; margin:6px 0 12px 0 }
  input[type="text"]#path{ width:330px; padding:7px 10px; border:1px solid var(--line); border-radius:8px }
  .btn{ border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer }
  .btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent) }
  .alert{ background:#fef3f2; color:#b42318; border:1px solid #fecdca; padding:10px 12px; border-radius:10px; margin:8px 0; font-size:14px }

  /* 문제 카드 */
  .qcard{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,.04) }
  .qhead{ display:flex; align-items:center; gap:10px; margin-bottom:6px }
  .qnum{ width:28px; height:28px; display:grid; place-items:center; font-weight:700; border:1px solid var(--line); border-radius:6px; }
  .flag-btn{ margin-left:4px; border:1px solid var(--line); background:#fff; border-radius:8px; padding:4px 10px; cursor:pointer; font-size:13px; color:var(--muted) }
  .flagged{ color:var(--flag); border-color:#fde68a; background:#fffaf0 }
  .qtitle{ text-align:center; color:#0f172a; font-size:14px; margin:4px 0 6px 0 }
  .qstem{ font-size:16px; line-height:1.55; margin:10px 0 12px 0 }
  .choices{ display:grid; gap:10px }

  /* 선택지 */
  .choice{ border:1px solid var(--line); background:var(--choice); border-radius:10px; padding:10px 12px; cursor:pointer;
           display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:flex-start; transition:background .15s, border-color .15s; }
  .choice:hover{ background:var(--choice-hover) }
  .bubble{ width:24px; height:24px; border:1px solid var(--line); border-radius:50%; display:grid; place-items:center; font-weight:700; background:#fff; user-select:none; font-size:13px; }
  .choice input{ display:none }
  .choice.selected{ border-color:#bfd3ff; background:#eef4ff }
  .choice.selected .bubble{ border-color:var(--accent); color:#fff; background:var(--accent) }

  /* grid-in */
  .gridin{ width:260px; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-size:16px; background:#fff }

  /* 하단 컨트롤 & 팔레트 */
  .footer{ display:flex; align-items:center; justify-content:space-between; margin:14px 0 }
  .nav{ display:flex; gap:8px }
  .palette{ display:flex; flex-wrap:wrap; gap:6px; padding:8px 0 }
  .dot{ width:36px; height:36px; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer; font-weight:600 }
  .dot.active{ outline:2px solid var(--accent) }
  .dot.answered{ background:#e9fbe7; border-color:#b7f4be }
  .dot.flag{ background:#fff3d6; border-color:#fde68a }
  .dot.correct{ background:var(--ok); border-color:var(--ok-border) }
  .dot.incorrect{ background:var(--bad); border-color:var(--bad-border) }

  /* 좌측=문제/팔레트, 우측=해설 패널 */
  .left-col{ grid-column:1 / 2 }
  .right-col{ grid-column:2 / 3 }
  .side{ position:sticky; top:64px; }
  .panel{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:12px; box-shadow:0 10px 24px rgba(0,0,0,.05) }
  .panel h4{ margin:0 0 8px 0; font-size:15px }
  .panel .muted{ color:var(--muted); font-size:13px }
  .scorebox .summary{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px }
  .pill{ border:1px solid var(--line); border-radius:999px; padding:4px 10px; background:#fff }
</style>
</head>
<body>

<!-- ===== TOP BAR ===== -->
<div class="topbar">
  <div class="topbar-row">
    <div class="dir-zone">
      <div class="crumb" id="crumb">Section 2, Module 1: Math</div>
      <button class="dir-btn" id="dirToggle">Directions ▾</button>
      <div class="dir-panel" id="dirPanel"></div>
    </div>
    <div class="timer-wrap">
      <span class="timer" id="timer">35:00</span>
      <button class="hide-btn" id="hideBtn">Hide</button>
    </div>
    <div class="controls">
      <button class="icon-btn">🔢 Calculator</button>
      <button class="icon-btn">📄 Reference</button>
      <button class="icon-btn">⋯ More</button>
    </div>
  </div>
  <div class="dash"></div>
</div>

<div class="wrap">
  <div class="loader">
    <input id="path" type="text" value="./questions.json" />
    <button class="btn" id="loadBtn">Load set</button>
  </div>
  <div id="loadError" class="alert" style="display:none"></div>

  <!-- 좌측: 문제/팔레트/점수 -->
  <div class="left-col">
    <!-- 문제 카드 -->
    <div class="qcard" id="card" style="display:none">
      <div class="qhead">
        <div class="qnum" id="qnum">1</div>
        <button id="flagBtn" class="flag-btn">Mark for Review</button>
      </div>
      <div class="qtitle" id="qtitle"></div>
      <div class="qstem" id="qstem"></div>
      <div class="choices" id="choices"></div>
    </div>

    <div class="footer" id="footer" style="display:none">
      <div class="nav">
        <button class="btn" id="prevBtn">← Prev</button>
        <button class="btn" id="nextBtn">Next →</button>
      </div>
      <button class="btn primary" id="submitBtn">Submit</button>
    </div>

    <div class="palette" id="palette" style="display:none"></div>
    <div id="scoreBox" class="scorebox"></div>
  </div>

  <!-- 우측: 해설 사이드패널 -->
  <div class="right-col">
    <div class="side">
      <div class="panel" id="explainPanel">
        <h4>해설 패널</h4>
        <div class="muted">종합 결과에서 문항 번호를 클릭하면 이곳에 해설이 표시됩니다.</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== 상태 ===== */
let SET=null, modIdx=0, qIdx=0;
let flags=new Set(), answers={};
let timerSec=0, tickId=null;
// 종합 결과 저장
const RESULTS = { moduleScores:[], perQuestion:{} };

/* ===== 유틸 ===== */
const $ = s=>document.querySelector(s);
const bubbleABC = idx => "ABCD".charAt(idx);
const fmt = s => (s??"").replaceAll("\\n","<br>");
const fmtTime = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
const typeset = ()=> window.MathJax && MathJax.typesetPromise();
// [[IMAGE: file.png|alt]] -> <img ...>
const injectImages = html =>
  (html||"").replace(/\[\[IMAGE:\s*([^|\]]+)(?:\|([^\]]+))?\]\]/g,
    (_m,src,alt)=>`<img src="./img/${src.trim()}" alt="${(alt||'problem image').trim()}" style="max-width:100%">`);

/* ===== Directions ===== */
const dirBtn=$('#dirToggle'), dirPanel=$('#dirPanel');
dirBtn.onclick=()=> dirPanel.style.display = dirPanel.style.display==='block'?'none':'block';
document.addEventListener('click',e=>{
  if(!dirPanel.contains(e.target) && e.target!==dirBtn) dirPanel.style.display='none';
});

/* ===== 로드 ===== */
async function loadSet(path){
  try{
    const res = await fetch(path, {cache:'no-store'});
    SET = await res.json();
    $('#loadError').style.display='none';
  }catch(e){
    $('#loadError').textContent = `로드 실패: ${e.message}`;
    $('#loadError').style.display='block';
    return;
  }
  // 전역 초기화
  flags.clear(); Object.keys(answers).forEach(k=>delete answers[k]);
  RESULTS.moduleScores.length = 0;
  RESULTS.perQuestion = {};
  $('#scoreBox').innerHTML=''; $('#explainPanel').innerHTML='<h4>해설 패널</h4><div class="muted">종합 결과에서 문항 번호를 클릭하면 이곳에 해설이 표시됩니다.</div>';
  dirPanel.innerHTML = fmt(SET.metadata?.directions);
  startModule(0); // 항상 첫 모듈부터
}

/* ===== 모듈 이동/타이머 ===== */
function startModule(idx){
  modIdx = idx; qIdx = 0;
  $('#crumb').textContent = `${SET.metadata?.title || 'Math'} — Module ${modIdx+1}`;
  // 타이머 시작(모듈별)
  clearInterval(tickId);
  timerSec = (SET.metadata?.durationMinutesPerModule?.[modIdx] ?? 35) * 60;
  $('#timer').textContent = fmtTime(timerSec);
  tickId = setInterval(()=>{
    timerSec = Math.max(0, timerSec - 1);
    $('#timer').textContent = fmtTime(timerSec);
    if (timerSec === 0) { clearInterval(tickId); gotoNextModule(); }
  }, 1000);

  // UI 표시
  $('#card').style.display='block';
  $('#footer').style.display='flex';
  $('#palette').style.display='flex';
  renderPalette();
  renderQuestion();
  $('#scoreBox').innerHTML = '';
}

function gotoNextModule(){
  const last = SET.modules.length - 1;
  if (modIdx < last){
    startModule(modIdx + 1);
  } else {
    // 모든 모듈 완료
    showFinalReport();
  }
}

/* ===== 팔레트 ===== */
function renderPalette(){
  const list = SET.modules[modIdx].questions;
  const box = $('#palette'); box.innerHTML='';
  list.forEach((q,i)=>{
    const b=document.createElement('button');
    b.className='dot';
    if(i===qIdx) b.classList.add('active');
    if(flags.has(q.id)) b.classList.add('flag');
    if(answers[q.id]!==undefined && answers[q.id]!=='' ) b.classList.add('answered');
    b.textContent=i+1;
    b.onclick=()=>{ qIdx=i; renderPalette(); renderQuestion(); };
    box.appendChild(b);
  });
}

/* ===== 문제 표시 ===== */
function renderQuestion(){
  const q = SET.modules[modIdx].questions[qIdx];
  $('#qnum').textContent = qIdx+1;

  const fb=$('#flagBtn');
  const flagged=flags.has(q.id);
  fb.className = 'flag-btn' + (flagged?' flagged':'');
  fb.textContent = flagged ? 'Marked for Review' : 'Mark for Review';
  fb.onclick = ()=>{ flagged?flags.delete(q.id):flags.add(q.id); renderPalette(); renderQuestion(); };

  $('#qtitle').innerHTML = q.title || '';
  $('#qstem').innerHTML  = injectImages(fmt(q.prompt));

  const area = $('#choices'); area.innerHTML='';
  if(q.type==='mcq'){
    q.choices.forEach((c,i)=>{
      const row=document.createElement('label'); row.className='choice';
      row.innerHTML = `
        <input type="radio" name="ans" value="${i}" ${String(answers[q.id])===String(i)?'checked':''}/>
        <div class="bubble">${bubbleABC(i)}</div>
        <div class="txt">${c}</div>`;
      if(String(answers[q.id])===String(i)) row.classList.add('selected');
      row.addEventListener('click',()=>{ answers[q.id]=i; renderQuestion(); renderPalette(); });
      area.appendChild(row);
    });
  }else{ // grid-in
    const inp=document.createElement('input'); inp.className='gridin';
    inp.placeholder='Enter your answer'; inp.value=answers[q.id]??'';
    inp.oninput=e=>{ answers[q.id]=e.target.value.trim(); renderPalette(); };
    area.appendChild(inp);
  }
  typeset();
}

/* ===== 정답 판별 ===== */
function gridinEqual(user,q){
  if(user===undefined || user==='') return false;
  // 숫자 비교(+허용 오차)
  if(q.answerNumeric!==undefined){
    const num = Number(user); if(!isNaN(num)){
      const tol = Number(q.tolerance||0);
      if(Math.abs(num-Number(q.answerNumeric))<=tol) return true;
    }
  }
  // 대체 표현(분수/문자열) 비교
  if(Array.isArray(q.altNumeric)){
    const s=String(user).replace(/\s/g,'');
    return q.altNumeric.some(v=> String(v).replace(/\s/g,'')===s );
  }
  return false;
}

/* ===== 제출 ===== */
function submitScore(){
  const qs = SET.modules[modIdx].questions;
  let score=0;
  qs.forEach((q,i)=>{
    let correct=false;
    if(q.type==='mcq'){
      correct = Number(answers[q.id])===Number(q.answer);
    }else{
      correct = gridinEqual(answers[q.id], q);
    }
    if(correct) score++;
    // 종합 저장(모듈 번호, 문항 번호, 정오/해설)
    RESULTS.perQuestion[q.id] = {
      correct,
      rationale: q.rationale || '(해설 없음)',
      module: modIdx+1,
      index: i+1,
      type: q.type,
      user: answers[q.id],
      answer: q.type==='mcq' ? q.answer : (q.answerNumeric ?? q.altNumeric?.[0])
    };
  });
  RESULTS.moduleScores[modIdx] = { score, total: qs.length };

  // 모듈 1이면 즉시 모듈 2 시작(요청사항)
  const last = SET.modules.length - 1;
  if(modIdx < last){
    startModule(modIdx + 1);
  }else{
    showFinalReport();
  }
}
$('#submitBtn').onclick=submitScore;

/* ===== 종합 결과 ===== */
function showFinalReport(){
  clearInterval(tickId);
  $('#card').style.display='none';
  $('#footer').style.display='none';
  $('#palette').style.display='none';

  // 총점 집계
  const totals = RESULTS.moduleScores.reduce((acc,m)=>({score:acc.score+m.score,total:acc.total+m.total}),{score:0,total:0});
  const sb = $('#scoreBox');
  sb.innerHTML =
    `<div class="qcard">
      <b>All Modules — Summary</b>
      <div class="summary" style="margin-top:6px">
        <span class="pill">Total: <b>${totals.score}</b> / ${totals.total}</span>
        ${RESULTS.moduleScores.map((m,i)=>`<span class="pill">Module ${i+1}: <b>${m.score}</b> / ${m.total}</span>`).join('')}
      </div>
      <div style="margin-top:12px"><b>문항별 정오표</b></div>
     </div>`;

  // 모듈별 정오 버튼 팔레트 + 클릭 시 해설 패널
  SET.modules.forEach((mod, mIdx)=>{
    const box = document.createElement('div');
    box.className='qcard';
    box.style.marginTop='10px';
    const title = document.createElement('div');
    title.innerHTML = `<b>Module ${mIdx+1}</b>`;
    const list = document.createElement('div');
    list.className = 'palette';
    mod.questions.forEach((q,i)=>{
      const info = RESULTS.perQuestion[q.id];
      const b = document.createElement('button');
      b.className = 'dot ' + (info?.correct ? 'correct' : 'incorrect');
      b.textContent = (i+1);
      b.title = info?.correct ? '정답' : '오답';
      b.onclick = ()=> showExplanation(q.id);
      list.appendChild(b);
    });
    box.appendChild(title);
    box.appendChild(list);
    sb.appendChild(box);
  });

  // 해설 패널 안내
  $('#explainPanel').innerHTML =
    `<h4>해설 패널</h4>
     <div class="muted">오른쪽 정오표에서 문항 번호를 클릭하세요. 선택한 문항의 해설이 여기에 표시됩니다.</div>`;
  typeset();
}

function showExplanation(qid){
  // SET에서 문항 찾기
  let found=null, modNo=0, number=0;
  for(let m=0;m<SET.modules.length;m++){
    const idx = SET.modules[m].questions.findIndex(q=>q.id===qid);
    if(idx>=0){ found = SET.modules[m].questions[idx]; modNo=m+1; number=idx+1; break; }
  }
  if(!found){ return; }
  const info = RESULTS.perQuestion[qid];
  const panel = $('#explainPanel');
  panel.innerHTML =
    `<h4>Module ${modNo} — Q${number} (${info?.correct?'정답':'오답'})</h4>
     <div style="font-size:14px; margin:6px 0 8px 0"><b>문항</b></div>
     <div class="muted" style="margin-bottom:8px">${injectImages(fmt(found.prompt))}</div>
     <div style="font-size:14px; margin:6px 0 8px 0"><b>해설</b></div>
     <div>${fmt(found.rationale || '(해설 없음)')}</div>
     <div class="summary" style="margin-top:10px">
       ${info?.type==='mcq'
         ? `<span class="pill">정답 선택지: ${String.fromCharCode(65+Number(found.answer))}</span>`
         : `<span class="pill">정답: ${found.answer}</span>`
       }
       ${info?.user!==undefined ? `<span class="pill">내 답: ${info.user}</span>`:''}
     </div>`;
  typeset();
}

/* ===== 기타 ===== */
$('#loadBtn').onclick=()=>loadSet($('#path').value);
$('#hideBtn').onclick=()=>{ const w=$('.wrap'); w.style.display = w.style.display==='none'?'grid':'none'; };
window.addEventListener('DOMContentLoaded',()=>loadSet($('#path').value));
</script>
</body>
</html>
