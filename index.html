<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DSAT Practice ‚Äî Classic UI</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script defer id="MathJax-script"
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<style>
  :root{
    --bg:#fafbfe; --card:#fff; --ink:#1f2937; --muted:#6b7280;
    --line:#e5e7eb; --accent:#2563eb; --accent-ghost:#e7f0ff;
    --flag:#ef9b0f; --choice:#f7f7fb; --choice-hover:#eef2ff;
    --good:#16a34a; --bad:#dc2626;
  }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Arial,sans-serif; color:var(--ink); background:var(--bg) }

  /* ===== TOP BAR ===== */
  .topbar{
    position:sticky; top:0; z-index:5; background:#fff;
    border-bottom:1px solid var(--line);
  }
  .topbar-row{
    display:grid; grid-template-columns:1fr auto 1fr; align-items:center;
    gap:10px; padding:6px 14px;
  }
  .crumb{ font-weight:600; font-size:14px }
  .controls{ justify-self:end; display:flex; gap:8px }
  .icon-btn{ border:1px solid var(--line); background:#fff; padding:6px 10px; border-radius:8px; font-size:12px; cursor:pointer }
  .timer-wrap{ justify-self:center; display:flex; align-items:center; gap:8px }
  .timer{ font-weight:800; font-variant-numeric:tabular-nums }
  .hide-btn{ border:1px solid var(--line); background:#fff; padding:3px 8px; border-radius:6px; font-size:12px; cursor:pointer }

  /* ÏÉÅÎã® Directions ÎìúÎ°≠Îã§Ïö¥ */
  .dir-zone{ display:flex; align-items:center; gap:10px }
  .dir-btn{ border:1px solid var(--line); background:#fff; padding:5px 10px; border-radius:8px; font-size:13px; cursor:pointer }
  .dir-panel{
    position:absolute; left:14px; top:44px; width:520px; background:#fff; border:1px solid var(--line);
    border-radius:12px; padding:12px; font-size:14px; line-height:1.45; box-shadow:0 12px 32px rgba(0,0,0,.08); display:none;
  }
  .dash{ height:6px; background:repeating-linear-gradient(90deg,
      #d9ead3 0 46px, #fff 46px 54px,
      #f9e1ae 54px 98px, #fff 98px 106px,
      #cfe2f3 106px 152px, #fff 152px 160px); opacity:.95 }

  /* ===== Î©îÏù∏ ===== */
  .wrap{ max-width:1060px; margin:12px auto; padding:0 14px }
  .loader{ display:flex; gap:8px; margin:6px 0 12px 0 }
  input[type="text"]#path{ width:330px; padding:7px 10px; border:1px solid var(--line); border-radius:8px }
  .btn{ border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer }
  .btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent) }
  .alert{ background:#fef3f2; color:#b42318; border:1px solid #fecdca; padding:10px 12px; border-radius:10px; margin:8px 0; font-size:14px }

  /* ===== Î¨∏Ï†ú Ïπ¥Îìú ===== */
  .qcard{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 6px 20px rgba(0,0,0,.04); margin-bottom:14px }
  .qhead{ display:flex; align-items:center; gap:10px; margin-bottom:6px }
  .qnum{ width:28px; height:28px; display:grid; place-items:center; font-weight:700; border:1px solid var(--line); border-radius:6px; }
  .flag-btn{ margin-left:4px; border:1px solid var(--line); background:#fff; border-radius:8px; padding:4px 10px; cursor:pointer; font-size:13px; color:var(--muted) }
  .flagged{ color:var(--flag); border-color:#fde68a; background:#fffaf0 }
  .qtitle{ text-align:center; color:#0f172a; font-size:14px; margin:4px 0 6px 0 }
  .qstem{ font-size:16px; line-height:1.55; margin:10px 0 12px 0 }
  .choices{ display:grid; gap:10px }
  .choice{ border:1px solid var(--line); background:var(--choice); border-radius:10px; padding:10px 12px; cursor:pointer;
           display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:flex-start; transition:background .15s, border-color .15s; }
  .choice:hover{ background:var(--choice-hover) }
  .bubble{ width:24px; height:24px; border:1px solid var(--line); border-radius:50%; display:grid; place-items:center; font-weight:700; background:#fff; user-select:none; font-size:13px; }
  .choice input{ display:none }
  .choice.selected{ border-color:#bfd3ff; background:#eef4ff }
  .choice.selected .bubble{ border-color:var(--accent); color:#fff; background:var(--accent) }
  .gridin{ width:260px; padding:10px 12px; border:1px solid var(--line); border-radius:10px; font-size:16px; background:#fff }

  /* ===== ÌïòÎã® Í≥†Ï†ï Î¶¨Î≥∏ ===== */
  .ribbon{
    position:fixed; left:0; right:0; bottom:0; z-index:4;
    background:#fff; border-top:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between;
    padding:8px 12px; gap:10px;
  }
  .spacer-bottom{ height:64px } /* Î¶¨Î≥∏Ïóê Í∞ÄÎ¶¨ÏßÄ ÏïäÎèÑÎ°ù Ïó¨Î∞± */
  .nav{ display:flex; gap:8px }
  .progress{
    display:flex; align-items:center; gap:8px;
    border:1px solid var(--line); border-radius:10px; padding:6px 10px; background:#fff;
    font-weight:600;
  }
  .progress button{ border:1px solid var(--line); border-radius:8px; background:#fff; padding:6px 10px; cursor:pointer }
  .progress .light{ color:var(--muted); font-weight:500 }

  /* ===== Ï†êÌîÑ Î™®Îã¨(Î≤àÌò∏ ÏÑ†ÌÉù) ===== */
  .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10; }
  .modal.show{ display:flex }
  .modal .back{ position:absolute; inset:0; background:rgba(0,0,0,.28) }
  .modal .panel{ position:relative; width:min(760px,90vw); max-height:80vh; overflow:auto;
                 background:#fff; border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:0 18px 42px rgba(0,0,0,.16) }
  .grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(48px,1fr)); gap:8px }
  .num{
    height:42px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer;
    font-weight:700; display:grid; place-items:center;
  }
  .num.answered{ background:#e9fbe7; border-color:#b7f4be }
  .num.flag{ background:#fff3d6; border-color:#fde68a }
  .num.active{ outline:2px solid var(--accent) }

  /* ===== Í≤∞Í≥º ÏöîÏïΩ / Ìï¥ÏÑ§ Ìå®ÎÑê ===== */
  .summary{ display:flex; gap:14px; flex-wrap:wrap }
  .tag{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:#fff }
  .pill{ padding:2px 8px; border-radius:999px; font-weight:700; font-variant-numeric:tabular-nums }
  .good{ color:#065f46; background:#dcfce7; border:1px solid #bbf7d0 }
  .bad{ color:#991b1b; background:#fee2e2; border:1px solid #fecaca }

  .result-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(44px,1fr)); gap:8px }
  .cell{
    height:40px; border:1px solid var(--line); border-radius:10px; display:grid; place-items:center; cursor:pointer; font-weight:700;
  }
  .cell.ok{ background:#e9fbe7; border-color:#b7f4be }
  .cell.ng{ background:#fee2e2; border-color:#fecaca }
  .cell.flag{ outline:2px dashed #f59e0b }

  .exp-drawer{
    position:fixed; top:64px; right:12px; bottom:76px; width:min(380px, 90vw); z-index:6;
    background:#fff; border:1px solid var(--line); border-radius:14px; padding:12px; box-shadow:0 18px 42px rgba(0,0,0,.12); overflow:auto;
  }
  .exp-title{ font-weight:700; margin-bottom:6px }
  .exp-body{ font-size:14px; line-height:1.45 }
</style>
</head>
<body>

<!-- ===== TOP BAR ===== -->
<div class="topbar">
  <div class="topbar-row">
    <div class="dir-zone">
      <div class="crumb" id="crumb">Section 2, Module 1: Math</div>
      <button class="dir-btn" id="dirToggle">Directions ‚ñæ</button>
      <div class="dir-panel" id="dirPanel"></div>
    </div>
    <div class="timer-wrap">
      <span class="timer" id="timer">35:00</span>
      <button class="hide-btn" id="hideBtn">Hide</button>
    </div>
    <div class="controls">
      <button class="icon-btn">üî¢ Calculator</button>
      <button class="icon-btn">üìÑ Reference</button>
      <button class="icon-btn">‚ãØ More</button>
    </div>
  </div>
  <div class="dash"></div>
</div>

<div class="wrap">
  <div class="loader">
    <input id="path" type="text" value="./questions.json" />
    <button class="btn" id="loadBtn">Load set</button>
  </div>
  <div id="loadError" class="alert" style="display:none"></div>

  <!-- Î¨∏Ï†ú Ïπ¥Îìú -->
  <div class="qcard" id="card" style="display:none">
    <div class="qhead">
      <div class="qnum" id="qnum">1</div>
      <button id="flagBtn" class="flag-btn">Mark for Review</button>
    </div>
    <div class="qtitle" id="qtitle"></div>
    <div class="qstem" id="qstem"></div>
    <div class="choices" id="choices"></div>
  </div>

  <!-- Ï†êÏàò/Í≤∞Í≥º ÌëúÏãú -->
  <div id="scoreBox"></div>
</div>

<!-- ÌïòÎã® Í≥†Ï†ï Î¶¨Î≥∏ -->
<div class="ribbon" id="ribbon" style="display:none">
  <div class="progress">
    <span id="progLabel" class="light">Q 1 / 1</span>
    <button id="jumpBtn">Î¨∏Ìï≠ Ïù¥Îèô</button>
  </div>
  <div class="nav">
    <button class="btn" id="prevBtn">‚Üê Prev</button>
    <button class="btn" id="nextBtn">Next ‚Üí</button>
    <button class="btn primary" id="submitBtn">Submit</button>
  </div>
</div>
<div class="spacer-bottom" aria-hidden="true"></div>

<!-- Î≤àÌò∏ Ï†êÌîÑ Î™®Îã¨ -->
<div class="modal" id="jumpModal" aria-hidden="true">
  <div class="back" id="jumpBack"></div>
  <div class="panel">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
      <div><b>Î¨∏Ìï≠ Ïù¥Îèô</b> ‚Äî Module <span id="jumpMod">1</span></div>
      <button class="btn" id="jumpClose">Close</button>
    </div>
    <div class="grid" id="jumpGrid"></div>
  </div>
</div>

<script>
/* ===== ÏÉÅÌÉú ===== */
let SET=null, modIdx=0, qIdx=0;
let flags=new Set(), answers={};         // answers[qid] = choiceIndex or gridin string
let perModuleScore=[];                   // [{correct, total}]
let timerSec=0, tickId=null;

/* ===== Ïú†Ìã∏ ===== */
const $ = s=>document.querySelector(s);
const fmt = s => (s??"").replaceAll("\\n","<br>");
const fmtTime = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
const typeset = ()=> window.MathJax && MathJax.typesetPromise();
const injectImages = html =>
  (html||"").replace(/\[\[IMAGE:\s*([^|\]]+)(?:\|([^\]]+))?\]\]/g,
    (_m,src,alt)=>`<img src="./img/${src.trim()}" alt="${(alt||'problem image').trim()}" style="max-width:100%">`);

/* ===== Directions ===== */
const dirBtn=$('#dirToggle'), dirPanel=$('#dirPanel');
dirBtn.onclick=()=> dirPanel.style.display = dirPanel.style.display==='block'?'none':'block';
document.addEventListener('click',e=>{
  if(!dirPanel.contains(e.target) && e.target!==dirBtn) dirPanel.style.display='none';
});

/* ===== Î°úÎìú ===== */
async function loadSet(path){
  try{
    const res = await fetch(path, {cache:'no-store'});
    SET = await res.json();
    $('#loadError').style.display='none';
  }catch(e){
    $('#loadError').textContent = `Î°úÎìú Ïã§Ìå®: ${e.message}`;
    $('#loadError').style.display='block';
    return;
  }
  // Ï¥àÍ∏∞Ìôî
  flags.clear(); answers={}; perModuleScore=[];
  $('#scoreBox').innerHTML='';
  $('#card').style.display='block';
  $('#ribbon').style.display='flex';
  dirPanel.innerHTML = fmt(SET.metadata?.directions);
  startModule(0);
}

/* ===== Î™®Îìà Ïù¥Îèô/ÌÉÄÏù¥Î®∏ ===== */
function startModule(idx){
  // Ïó∞Ïäµ Ï§ëÏóêÎäî Ìï¥ÏÑ§ Ìå®ÎÑê DOMÏù¥ Ï°¥Ïû¨ÌïòÏßÄ ÏïäÎèÑÎ°ù Î≥¥Ïû•
  removeExplainDrawer();

  modIdx = idx; qIdx = 0;
  $('#crumb').textContent = `Section 2, Module ${modIdx+1}: Math`;

  // ÌÉÄÏù¥Î®∏ ÏãúÏûë(Î™®ÎìàÎ≥Ñ)
  clearInterval(tickId);
  timerSec = (SET.metadata?.durationMinutesPerModule?.[modIdx] ?? 35) * 60;
  $('#timer').textContent = fmtTime(timerSec);
  tickId = setInterval(()=>{
    timerSec = Math.max(0, timerSec - 1);
    $('#timer').textContent = fmtTime(timerSec);
    if (timerSec === 0) { clearInterval(tickId); handleSubmitModule(true); }
  }, 1000);

  renderQuestion();
  renderProgress();
}

function gotoNextModule(){
  const last = SET.modules.length - 1;
  if (modIdx < last){
    startModule(modIdx + 1); // Î™®Îìà2 1Î≤àÎ∂ÄÌÑ∞, ÌÉÄÏù¥Î®∏ ÏÉàÎ°ú ÏãúÏûë
    $('#scoreBox').innerHTML='';
  } else {
    showCombinedResults();
  }
}

/* ===== ÏßÑÌñâ/Ï†êÌîÑ ===== */
function renderProgress(){
  const n = SET.modules[modIdx].questions.length;
  $('#progLabel').textContent = `Q ${qIdx+1} / ${n}`;
  buildJumpGrid(); // Î™®Îã¨Ïö© Î≤àÌò∏ Í∞±Ïã†
}
function openJumpModal(){ $('#jumpModal').classList.add('show'); $('#jumpModal').setAttribute('aria-hidden','false'); }
function closeJumpModal(){ $('#jumpModal').classList.remove('show'); $('#jumpModal').setAttribute('aria-hidden','true'); }
$('#jumpBtn').onclick=openJumpModal;
$('#jumpBack').onclick=closeJumpModal;
$('#jumpClose').onclick=closeJumpModal;

function buildJumpGrid(){
  $('#jumpMod').textContent = (modIdx+1);
  const list = SET.modules[modIdx].questions;
  const box = $('#jumpGrid'); box.innerHTML='';
  list.forEach((q,i)=>{
    const b=document.createElement('button');
    b.className='num';
    if(i===qIdx) b.classList.add('active');
    if(flags.has(q.id)) b.classList.add('flag');
    if(answers[q.id]!==undefined && answers[q.id]!=='' ) b.classList.add('answered');
    b.textContent=i+1;
    b.onclick=()=>{ qIdx=i; renderQuestion(); renderProgress(); closeJumpModal(); };
    box.appendChild(b);
  });
}

/* ===== Î¨∏Ï†ú ÌëúÏãú ===== */
function renderQuestion(){
  const q = SET.modules[modIdx].questions[qIdx];
  $('#qnum').textContent = qIdx+1;

  const fb=$('#flagBtn');
  const flagged=flags.has(q.id);
  fb.className = 'flag-btn' + (flagged?' flagged':'');
  fb.textContent = flagged ? 'Marked for Review' : 'Mark for Review';
  fb.onclick = ()=>{ flagged?flags.delete(q.id):flags.add(q.id); renderProgress(); };

  $('#qtitle').innerHTML = q.title || '';
  $('#qstem').innerHTML  = injectImages(fmt(q.prompt));

  const area = $('#choices'); area.innerHTML='';
  if(q.type==='mcq'){
    q.choices.forEach((c,i)=>{
      const row=document.createElement('label'); row.className='choice';
      row.innerHTML = `
        <input type="radio" name="ans" value="${i}" ${String(answers[q.id])===String(i)?'checked':''}/>
        <div class="bubble">${"ABCD".charAt(i)}</div>
        <div class="txt">${c}</div>`;
      if(String(answers[q.id])===String(i)) row.classList.add('selected');
      row.addEventListener('click',()=>{ answers[q.id]=i; renderQuestion(); renderProgress(); });
      area.appendChild(row);
    });
  }else{ // grid-in
    const inp=document.createElement('input'); inp.className='gridin';
    inp.placeholder='Enter your answer'; inp.value=answers[q.id]??'';
    inp.oninput=e=>{ answers[q.id]=e.target.value.trim(); renderProgress(); };
    area.appendChild(inp);
  }
  typeset();
}

/* ===== ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò ===== */
$('#prevBtn').onclick=()=>{ if(qIdx>0){ qIdx--; renderQuestion(); renderProgress(); } };
$('#nextBtn').onclick=()=>{
  const n=SET.modules[modIdx].questions.length;
  if(qIdx<n-1){ qIdx++; renderQuestion(); renderProgress(); }
  else{ // ÎßàÏßÄÎßâ Î¨∏Ìï≠ÏóêÏÑú Next ‚Üí Îã§Ïùå Î™®Îìà
    gotoNextModule();
  }
};

/* ===== Ï±ÑÏ†ê ===== */
function gridinEqual(user,q){
  if(user===undefined || user==='') return false;
  if(q.answerNumeric!==undefined){
    const num = Number(user); if(!isNaN(num)){
      const tol = Number(q.tolerance||0);
      if(Math.abs(num-Number(q.answerNumeric))<=tol) return true;
    }
  }
  if(Array.isArray(q.altNumeric)){
    const s=String(user).replace(/\s/g,'');
    return q.altNumeric.some(v=> String(v).replace(/\s/g,'')===s );
  }
  return false;
}

function scoreModule(idx){
  const qs = SET.modules[idx].questions;
  let correct=0;
  const detail = qs.map((q,qi)=>{
    let ok=false, user=answers[q.id];
    if(q.type==='mcq'){ ok = Number(user)===Number(q.answer); }
    else{ ok = gridinEqual(user, q); }
    if(ok) correct++;
    return {id:q.id, ok, user, q, number:qi+1};
  });
  return {correct, total:qs.length, detail};
}

/* ===== Ï†úÏ∂ú Ï≤òÎ¶¨ ===== */
function handleSubmitModule(fromTimer=false){
  if(!fromTimer){
    const ok = window.confirm(`Module ${modIdx+1}ÏùÑ(Î•º) Ï†úÏ∂úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`);
    if(!ok) return;
  }
  clearInterval(tickId);
  const result = scoreModule(modIdx);
  perModuleScore[modIdx]= {correct:result.correct, total:result.total, detail:result.detail};

  // Î™®Îìà1Ïù¥Î©¥ ÏûêÎèôÏúºÎ°ú Î™®Îìà2 ÏãúÏûë
  const last = SET.modules.length - 1;
  if(modIdx < last){
    // Í∞ÑÎã® Ï†êÏàò ÏïàÎÇ¥Îßå Î≥¥Ïó¨Ï£ºÍ≥† Î∞îÎ°ú Î™®Îìà2 ÏãúÏûë
    $('#scoreBox').innerHTML =
      `<div class="qcard" style="margin-top:10px">
         <b>Module ${modIdx+1} Score:</b> ${result.correct} / ${result.total}<br>Îã§Ïùå Î™®ÎìàÏùÑ ÏãúÏûëÌï©ÎãàÎã§.
       </div>`;
    gotoNextModule();
  }else{
    showCombinedResults(); // ÎßàÏßÄÎßâ Î™®Îìà
  }
}
$('#submitBtn').onclick=()=>handleSubmitModule(false);

/* ===== Í≤∞Í≥º Ìï¥ÏÑ§ Ìå®ÎÑê ===== */
function removeExplainDrawer(){
  const ex = document.getElementById('expDrawer');
  if(ex) ex.remove();
}
function ensureExplainDrawer(){
  let ex = document.getElementById('expDrawer');
  if(!ex){
    ex = document.createElement('aside');
    ex.id = 'expDrawer';
    ex.className = 'exp-drawer';
    ex.innerHTML = `<div class="exp-title" id="expTitle">Ìï¥ÏÑ§</div>
                    <div class="exp-body" id="expBody">Ï¢åÏ∏° Î≤àÌò∏Î•º ÏÑ†ÌÉùÌïòÎ©¥ Ìï¥ÏÑ§Ïù¥ ÌëúÏãúÎê©ÎãàÎã§.</div>`;
    document.body.appendChild(ex);
  }
  return ex;
}
function showExplanation(mod, number){
  const m = SET.modules[mod-1];
  const q = m.questions[number-1];
  ensureExplainDrawer();
  $('#expTitle').innerHTML = `Module ${mod} ¬∑ Q${number}`;
  const body = q.rationale ? injectImages(fmt(q.rationale)) : 'Ìï¥ÏÑ§Ïù¥ ÏóÜÏäµÎãàÎã§.';
  $('#expBody').innerHTML = body;
  typeset();
}

/* ===== Ï†ÑÏ≤¥ Í≤∞Í≥º(Î™®Îìà2 Ï†úÏ∂ú ÌõÑ) ===== */
function showCombinedResults(){
  clearInterval(tickId);

  // Ïó∞Ïäµ UI Ïà®ÍπÄ, Î¶¨Î≥∏ Ïà®ÍπÄ
  $('#card').style.display='none';
  $('#ribbon').style.display='none';

  // Ï†ÑÏ≤¥ Ï±ÑÏ†ê(ÌòπÏãú detail ÎàÑÎùΩ Î≥¥ÏôÑ)
  SET.modules.forEach((_,mi)=>{
    if(!perModuleScore[mi]){
      const sc = scoreModule(mi);
      perModuleScore[mi] = {correct:sc.correct, total:sc.total, detail:sc.detail};
    }
  });

  const grand = perModuleScore.reduce((a,b)=>({correct:a.correct+b.correct, total:a.total+b.total}), {correct:0,total:0});

  // Í≤∞Í≥º ÏöîÏïΩ
  const sumHTML = `
    <div class="qcard">
      <div class="summary">
        <div class="tag">Ï¥ùÏ†ê <span class="pill ${grand.correct>=(grand.total/2)?'good':'bad'}">${grand.correct} / ${grand.total}</span></div>
        <div class="tag">Module 1 <span class="pill">${perModuleScore[0].correct} / ${perModuleScore[0].total}</span></div>
        <div class="tag">Module 2 <span class="pill">${perModuleScore[1].correct} / ${perModuleScore[1].total}</span></div>
      </div>
    </div>`;

  // Î™®ÎìàÎ≥Ñ Ï†ïÏò§Ìëú Í∑∏Î¶¨Îìú
  function moduleResultPanel(mi){
    const det = perModuleScore[mi].detail;
    const cells = det.map(d=>{
      const cls = d.ok ? 'ok' : 'ng';
      const flag = flags.has(d.id) ? ' flag' : '';
      return `<button class="cell ${cls}${flag}" data-mod="${mi+1}" data-num="${d.number}" title="Module ${mi+1} ¬∑ Q${d.number}">
                ${d.number}
              </button>`;
    }).join('');
    return `
      <div class="qcard">
        <b>Module ${mi+1} ‚Äî Ï†ïÏò§Ìëú</b>
        <div class="result-grid" style="margin-top:10px">${cells}</div>
      </div>`;
  }

  $('#scoreBox').innerHTML = sumHTML + moduleResultPanel(0) + moduleResultPanel(1);

  // Í≤∞Í≥º ÌôîÎ©¥ÏóêÎßå Ìï¥ÏÑ§ Ìå®ÎÑê ÏÉùÏÑ±
  ensureExplainDrawer();

  // ÌÅ¥Î¶≠ Ïãú Ìï¥ÏÑ§ ÌëúÏãú
  $('#scoreBox').querySelectorAll('.cell').forEach(btn=>{
    btn.addEventListener('click', e=>{
      const mod = Number(e.currentTarget.getAttribute('data-mod'));
      const num = Number(e.currentTarget.getAttribute('data-num'));
      showExplanation(mod, num);
    });
  });
}

/* ===== Í∏∞ÌÉÄ ===== */
$('#loadBtn').onclick=()=>loadSet($('#path').value);
$('#hideBtn').onclick=()=>{ const w=$('.wrap'); w.style.display = w.style.display==='none'?'block':'none'; };
window.addEventListener('DOMContentLoaded',()=>loadSet($('#path').value));
</script>
</body>
</html>
