<script>
/* ===== 상태 ===== */
let SET=null, modIdx=0, qIdx=0;
let flags=new Set(), answers={};
let timerSec=0, tickId=null;

/* ===== 유틸 ===== */
const $ = s=>document.querySelector(s);
const bubbleABC = idx => "ABCD".charAt(idx);
const fmt = s => (s??"").replaceAll("\\n","<br>");
const fmtTime = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
const typeset = ()=> window.MathJax && MathJax.typesetPromise();
// [[IMAGE: file.png|optional alt]] -> <img ...>
const injectImages = html =>
  (html||"").replace(/\[\[IMAGE:\s*([^|\]]+)(?:\|([^\]]+))?\]\]/g,
    (_m,src,alt)=>`<img src="./img/${src.trim()}" alt="${(alt||'problem image').trim()}" style="max-width:100%">`);

/* ===== Directions ===== */
const dirBtn=$('#dirToggle'), dirPanel=$('#dirPanel');
dirBtn.onclick=()=> dirPanel.style.display = dirPanel.style.display==='block'?'none':'block';
document.addEventListener('click',e=>{
  if(!dirPanel.contains(e.target) && e.target!==dirBtn) dirPanel.style.display='none';
});

/* ===== 로드 ===== */
async function loadSet(path){
  try{
    const res = await fetch(path, {cache:'no-store'});
    SET = await res.json();
    $('#loadError').style.display='none';
  }catch(e){
    $('#loadError').textContent = `로드 실패: ${e.message}`;
    $('#loadError').style.display='block';
    return;
  }
  // 전역 초기화
  flags.clear(); answers={}; $('#scoreBox').innerHTML='';
  dirPanel.innerHTML = fmt(SET.metadata?.directions);
  startModule(0); // 항상 첫 모듈부터
}

/* ===== 모듈 이동/타이머 ===== */
function startModule(idx){
  modIdx = idx; qIdx = 0;
  $('#crumb').textContent = `Section 2, Module ${modIdx+1}: Math`;
  // 타이머 시작(모듈별)
  clearInterval(tickId);
  timerSec = (SET.metadata?.durationMinutesPerModule?.[modIdx] ?? 35) * 60;
  $('#timer').textContent = fmtTime(timerSec);
  tickId = setInterval(()=>{
    timerSec = Math.max(0, timerSec - 1);
    $('#timer').textContent = fmtTime(timerSec);
    if (timerSec === 0) { clearInterval(tickId); gotoNextModule(); }
  }, 1000);

  // UI 표시
  $('#card').style.display='block';
  $('#footer').style.display='flex';
  $('#palette').style.display='flex';
  renderPalette();
  renderQuestion();
}

function gotoNextModule(){
  const last = SET.modules.length - 1;
  if (modIdx < last){
    startModule(modIdx + 1);        // 다음 모듈로
    $('#scoreBox').innerHTML='';    // 이전 점수 박스 초기화
  } else {
    finishExam();
  }
}

function finishExam(){
  clearInterval(tickId);
  $('#card').style.display='none';
  $('#footer').style.display='none';
  $('#palette').style.display='none';
  $('#scoreBox').innerHTML =
    `<div class="qcard" style="margin-top:10px">
       <b>All modules completed.</b><br>
       Thanks for practicing!
     </div>`;
}

/* ===== 팔레트 ===== */
function renderPalette(){
  const list = SET.modules[modIdx].questions;
  const box = $('#palette'); box.innerHTML='';
  list.forEach((q,i)=>{
    const b=document.createElement('button');
    b.className='dot';
    if(i===qIdx) b.classList.add('active');
    if(flags.has(q.id)) b.classList.add('flag');
    if(answers[q.id]!==undefined && answers[q.id]!=='' ) b.classList.add('answered');
    b.textContent=i+1;
    b.onclick=()=>{ qIdx=i; renderPalette(); renderQuestion(); };
    box.appendChild(b);
  });
}

/* ===== 문제 표시 ===== */
function renderQuestion(){
  const q = SET.modules[modIdx].questions[qIdx];
  $('#qnum').textContent = qIdx+1;

  const fb=$('#flagBtn');
  const flagged=flags.has(q.id);
  fb.className = 'flag-btn' + (flagged?' flagged':'');
  fb.textContent = flagged ? 'Marked for Review' : 'Mark for Review';
  fb.onclick = ()=>{ flagged?flags.delete(q.id):flags.add(q.id); renderPalette(); renderQuestion(); };

  $('#qtitle').innerHTML = q.title || '';
  // 수식/이미지 플레이스홀더 처리
  $('#qstem').innerHTML  = injectImages(fmt(q.prompt));

  const area = $('#choices'); area.innerHTML='';
  if(q.type==='mcq'){
    q.choices.forEach((c,i)=>{
      const row=document.createElement('label'); row.className='choice';
      row.innerHTML = `
        <input type="radio" name="ans" value="${i}" ${String(answers[q.id])===String(i)?'checked':''}/>
        <div class="bubble">${bubbleABC(i)}</div>
        <div class="txt">${c}</div>`;
      if(String(answers[q.id])===String(i)) row.classList.add('selected');
      row.addEventListener('click',()=>{ answers[q.id]=i; renderQuestion(); renderPalette(); });
      area.appendChild(row);
    });
  }else{ // grid-in
    const inp=document.createElement('input'); inp.className='gridin';
    inp.placeholder='Enter your answer'; inp.value=answers[q.id]??'';
    inp.oninput=e=>{ answers[q.id]=e.target.value.trim(); renderPalette(); };
    area.appendChild(inp);
  }
  typeset();
}

/* ===== 내비게이션 / 제출 ===== */
$('#prevBtn').onclick=()=>{ if(qIdx>0){ qIdx--; renderPalette(); renderQuestion(); } };
$('#nextBtn').onclick=()=>{
  const n=SET.modules[modIdx].questions.length;
  if(qIdx<n-1){ qIdx++; renderPalette(); renderQuestion(); }
  else{ gotoNextModule(); } // 모듈 경계 처리
};

function gridinEqual(user,q){
  if(user===undefined || user==='') return false;
  // 숫자 비교(+허용 오차)
  if(q.answerNumeric!==undefined){
    const num = Number(user); if(!isNaN(num)){
      const tol = Number(q.tolerance||0);
      if(Math.abs(num-Number(q.answerNumeric))<=tol) return true;
    }
  }
  // 대체 표현(분수/문자열) 비교
  if(Array.isArray(q.altNumeric)){
    const s=String(user).replace(/\s/g,'');
    return q.altNumeric.some(v=> String(v).replace(/\s/g,'')===s );
  }
  return false;
}

function submitScore(){
  const qs = SET.modules[modIdx].questions;
  let score=0;
  qs.forEach(q=>{
    if(q.type==='mcq'){ if(Number(answers[q.id])===Number(q.answer)) score++; }
    else{ if(gridinEqual(answers[q.id], q)) score++; }
  });
  $('#scoreBox').innerHTML =
    `<div class="qcard" style="margin-top:10px">
       <b>Module ${modIdx+1} Score:</b> ${score} / ${qs.length}
     </div>`;
}
$('#submitBtn').onclick=submitScore;

/* ===== 기타 ===== */
$('#loadBtn').onclick=()=>loadSet($('#path').value);
$('#hideBtn').onclick=()=>{ const w=$('.wrap'); w.style.display = w.style.display==='none'?'block':'none'; };
window.addEventListener('DOMContentLoaded',()=>loadSet($('#path').value));
</script>
