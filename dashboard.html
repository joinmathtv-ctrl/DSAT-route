<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DSAT Dashboard — Extended</title>

<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- 공통 스타일 & 프리셋 -->
<link rel="stylesheet" href="./assets/style.css">
<script src="./assets/curves.presets.js"></script>

<style>
  /* ▼ 페이지 전용 스타일만 유지 (공통 style.css와 중복 제거 완료) */
  .r{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
  textarea.code{ width:100%; min-height:180px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace }
  input[type="date"]{
    border:1px solid var(--line);
    background:#fff;
    padding:8px 12px;
    border-radius:10px;
    cursor:pointer;
    font-size:14px;
  }
  /* ▼ 토스트 (대시보드 내 최소 스타일) */
  .toast{
    position:fixed; bottom:12px; left:50%; transform:translateX(-50%);
    background:#222; color:#fff; padding:8px 12px; border-radius:8px;
    opacity:.95; transition:opacity .2s; z-index:9999;
  }
  .toast.ok{ background:#16a34a }
  .toast.err{ background:#dc2626 }
</style>
</head>
<body>
<div class="topbar">
  <div class="toprow">
    <div style="font-weight:800">📈 DSAT Dashboard — Extended</div>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
      <a class="back" href="./index.html">← Back to Practice</a>
      <span class="muted">|</span>
      <button class="btn" id="clearBtn">Clear All Logs</button>
      <button class="btn" id="importBtn">Import</button>
      <button class="btn" id="exportBtn">Export</button>
      <button class="btn" id="printBtn">Print / Save (PDF)</button>
    </div>
  </div>
</div>

<!-- Mode buttons -->
<div id="modeLegend" style="display: flex; justify-content: center; gap: 15px; margin-top: 10px;">
  <button id="modeAll" class="mode-btn" data-mode="all">All</button>
  <button id="modeFull" class="mode-btn" data-mode="full">Full</button>
  <button id="modeRW" class="mode-btn" data-mode="rw">RW</button>
  <button id="modeMath" class="mode-btn" data-mode="math">Math</button>
</div>

<!-- Sync Panel (UI 영어 / 설명 한글 허용) -->
<div class="card" id="syncCard" data-sync-panel style="margin-top:12px">
  <div class="head"><div class="title">Sync</div></div>
  <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
    <button class="btn" id="btnSyncNow">Sync Now</button>
    <button class="btn" id="btnPush">Push Only</button>
    <button class="btn" id="btnPull">Pull Only</button>
    <!-- 더티 배지: DSAT_SYNC 동작 시 업데이트 -->
    <span id="syncBadge" class="pill" style="display:none"></span>
    <span class="muted" id="syncStatus">—</span>
  </div>
</div>

<div class="wrap">
  <!-- Filters · Curves · Defaults -->
  <div class="card">
    <div class="head">
      <div class="title">Filters · Curves · Defaults</div>
      <div class="r">
        <label class="muted">Set:</label>
        <select id="baseSelect"></select>
        <label class="muted">View:</label>
        <select id="kindSelect">
          <option value="">All</option>
          <option value="base">Base</option>
          <option value="review">Review</option>
        </select>
        <label class="muted">Curve Preset (recalc display):</label>
        <select id="presetSelect"></select>
        <button class="btn" id="saveDefaultPresetBtn" title="해당 세트에 기본 프리셋 기억(로컬)">Save as Default for This Set</button>
        <span id="countInfo" class="pill muted"></span>
      </div>
    </div>

    <div class="r">
      <button class="btn ghost" id="openCurveEditor">Edit/Add Presets</button>
      <span class="muted" style="font-size:13px">
        * 보기 프리셋은 <b>표시만 재계산</b>합니다. 실제 기록 시 사용된 프리셋은 연습페이지의 <code>SET.metadata.curvePreset</code> 값입니다.
      </span>
    </div>

    <!-- Review deeplink -->
    <div class="r" style="margin-top:8px">
      <button class="btn" id="startWrongReviewBtn">Start Review: Wrong Only</button>
      <button class="btn" id="startFlaggedReviewBtn">Start Review: Flagged Only</button>
      <span class="muted" style="font-size:12px">* Runs in the current set on index.html.</span>
    </div>

    <!-- Date range + aggregation -->
    <div class="r" style="margin-top:8px">
      <label class="muted">Date:</label>
      <input type="date" id="fromDate"/>
      <span class="muted">~</span>
      <input type="date" id="toDate"/>
      <span class="muted" style="margin-left:10px">Aggregate:</span>
      <select id="aggMode" title="요약 집계 모드">
        <option value="">None</option>
        <option value="byPreset">By Preset</option>
        <option value="bySet">By Set</option>
      </select>
    </div>
  </div>

  <!-- Top metrics -->
  <div class="row" style="margin-top:14px">
    <div class="card">
      <div class="head"><div class="title">Total Score Trend (SAT)</div></div>
      <canvas id="satLine" height="160"></canvas>
    </div>
    <div class="card">
      <div class="head"><div class="title">Section Scaled Scores</div></div>
      <canvas id="sectionBar" height="160"></canvas>
    </div>
  </div>

  <!-- Skill trend & heatmap -->
  <div class="row" style="margin-top:14px">
    <div class="card">
      <div class="head">
        <div class="title">Skill Trend (Accuracy %)</div>
        <div class="r">
          <select id="skillSelect"></select>
          <button class="btn" id="skillAllBtn">Recommend Top-Change Skills</button>
          <button class="btn" id="startSkillReviewBtn">Start Review for Skill</button>
        </div>
      </div>
      <canvas id="skillLine" height="160"></canvas>
    </div>
    <div class="card">
      <div class="head">
        <div class="title">Skill Heatmap (Accuracy %)</div>
        <div class="legend">
          <span class="cell c-0">0</span>0–50
          <span class="cell c-50">50</span>50–70
          <span class="cell c-70">70</span>70–85
          <span class="cell c-85">85</span>85–95
          <span class="cell c-95">95</span>95–100
        </div>
      </div>
      <div id="heatHdr" class="heatmap" style="grid-template-rows:auto"></div>
      <div id="heatBody" class="heatmap"></div>
    </div>
  </div>

  <!-- Attempt comparison -->
  <div class="card" style="margin-top:14px">
    <div class="head">
      <div class="title">Attempt Comparison</div>
      <div class="r">
        <select id="cmpA"></select>
        <span class="muted">vs</span>
        <select id="cmpB"></select>
        <button class="btn" id="cmpBtn">Compare</button>
        <button class="btn ghost" id="openDetailA">Detail A</button>
        <button class="btn ghost" id="openDetailB">Detail B</button>
      </div>
    </div>
    <div id="cmpOut" class="cmp-grid"></div>
  </div>

  <!-- Aggregation result -->
  <div class="card" id="aggCard" style="margin-top:14px; display:none">
    <div class="head">
      <div class="title">Aggregate Summary</div>
      <div class="muted" id="aggCaption" style="font-size:13px"></div>
    </div>
    <div id="aggOut"></div>
  </div>

  <!-- Attempt list -->
  <div class="card" style="margin-top:14px">
    <div class="head">
      <div class="title">Attempt Log</div>
    </div>
    <div class="muted" style="font-size:13px; margin-bottom:8px">Newest first · Click a row for details</div>
    <table id="attemptTable">
      <thead>
        <tr>
          <th style="width:160px">Date/Time</th>
          <th>Set Title</th>
          <th>Type</th>
          <th class="right">RW (Raw/Scaled)</th>
          <th class="right">Math (Raw/Scaled)</th>
          <th class="right">Total</th>
          <th class="right">Preset</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- ===== Modal: Attempt Detail ===== -->
<div class="backdrop" id="detailBack">
  <div class="modal">
    <button class="x" id="detailClose">Close</button>
    <div id="detailBody"></div>
  </div>
</div>

<!-- ===== Modal: Curve Editor (설명 한글 허용) ===== -->
<div class="backdrop" id="curveBack">
  <div class="modal">
    <button class="x" id="curveClose">Close</button>
    <div class="head"><div class="title">Curve Presets — Edit/Add</div></div>
    <div class="r" style="margin-bottom:8px">
      <label class="muted">Select Preset:</label>
      <select id="editPreset"></select>
      <input id="newPresetName" type="text" placeholder="New preset name"/>
      <button class="btn" id="dupBtn">Duplicate → New Name</button>
      <button class="btn bad" id="delBtn">Delete</button>
    </div>
    <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
      <div>
        <div class="muted" style="margin-bottom:6px">RW Points (JSON, e.g., [[0,200],[20,300],...])</div>
        <textarea id="rwPoints" class="code"></textarea>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">Math Points (JSON)</div>
        <textarea id="mathPoints" class="code"></textarea>
      </div>
    </div>
    <div class="r" style="margin-top:10px">
      <button class="btn" id="saveCurveBtn">Save</button>
      <span class="muted">※ x≤100 → 정답률(%), x>100 → 맞힌개수 도메인</span>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast" aria-live="polite" aria-atomic="true" role="status"></div>

<script>window.SYNC_API_BASE = "http://localhost:4311";</script>

<!-- Sync module (order matters: sync.js → dashboard.js) -->
<script src="./sync.js"></script>
<script src="./assets/dashboard.js"></script>

<!-- Firebase SDKs (optional) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

</body>
</html>
