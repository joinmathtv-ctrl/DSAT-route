<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DSAT Dashboard â€” Extended</title>

<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="./curves.presets.js"></script>

<style>
  :root{ --bg:#fafbfe; --card:#fff; --ink:#1f2937; --muted:#6b7280; --line:#e5e7eb; --accent:#2563eb; --ok:#16a34a; --bad:#ef4444 }
  *{ box-sizing:border-box }
  body{ margin:0; background:var(--bg); color:var(--ink); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif }
  .wrap{ max-width:1180px; margin:16px auto 96px; padding:0 14px }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:14px }
  @media (max-width:980px){ .row{ grid-template-columns:1fr } }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:0 6px 20px rgba(0,0,0,.04) }
  .head{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px }
  .title{ font-weight:800 }
  .muted{ color:var(--muted) }
  .btn, select, input[type="number"], input[type="text"], input[type="date"], textarea{ border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer }
  .btn.ghost{ background:#fff }
  .pill{ padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#fff }
  table{ width:100%; border-collapse:collapse; font-size:14px }
  th,td{ border-bottom:1px solid var(--line); padding:8px 6px; text-align:left; vertical-align:top }
  th{ color:#111827 }
  .right{ text-align:right }
  .topbar{ position:sticky; top:0; z-index:5; background:#fff; border-bottom:1px solid var(--line) }
  .toprow{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 14px }
  a.back{ text-decoration:none; color:var(--accent) }
  .grid{ display:grid; gap:6px }
  .heatmap{ --cell:34px; display:grid; grid-template-columns:160px repeat(auto-fill,var(--cell)); overflow:auto }
  .heat-row{ display:contents }
  .skill-name{ position:sticky; left:0; background:#fff; border-right:1px solid var(--line); padding-right:6px; white-space:nowrap; font-size:13px }
  .cell{ width:var(--cell); height:var(--cell); border:1px solid var(--line); display:grid; place-items:center; font-variant-numeric:tabular-nums; font-size:12px }
  .c-0{ background:#fee2e2 } .c-50{ background:#fde68a } .c-70{ background:#fef9c3 } .c-85{ background:#dcfce7 } .c-95{ background:#bbf7d0 }
  .legend{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; font-size:12px }
  .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; color:#fff }
  .ok{ background:var(--ok) } .bad{ background:var(--bad) }

  /* Modal */
  .backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.36); display:none; z-index:50 }
  .modal{ width:min(720px, 95vw); margin:8vh auto; background:#fff; border:1px solid var(--line); border-radius:14px; padding:14px }
  .modal .x{ float:right; border:1px solid var(--line); background:#fff; padding:6px 10px; border-radius:8px; cursor:pointer }
  .r{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
  textarea.code{ width:100%; min-height:180px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace }
</style>
</head>
<body>
<div class="topbar">
  <div class="toprow">
    <div style="font-weight:800">ğŸ“ˆ DSAT Dashboard â€” Extended</div>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
      <a class="back" href="./index.html">â† ì—°ìŠµìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
      <span class="muted">|</span>
      <button class="btn" id="clearBtn">ì „ì²´ ë¡œê·¸ ì‚­ì œ</button>
      <button class="btn" id="importBtn">Import</button>
      <button class="btn" id="exportBtn">Export</button>
      <button class="btn" id="printBtn">ì¸ì‡„/ì €ì¥(PDF)</button>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- í•„í„° + í”„ë¦¬ì…‹ ìŠ¤ìœ„ì²˜ + ê¸°ë³¸ í”„ë¦¬ì…‹ ì €ì¥ -->
  <div class="card">
    <div class="head">
      <div class="title">í•„í„° Â· ì»¤ë¸Œ Â· ê¸°ë³¸ê°’</div>
      <div class="r">
        <label class="muted">ì„¸íŠ¸:</label>
        <select id="baseSelect"></select>
        <label class="muted">ë³´ê¸°:</label>
        <select id="kindSelect">
          <option value="">ì „ì²´</option>
          <option value="base">Base</option>
          <option value="review">Review</option>
        </select>
        <label class="muted">ì»¤ë¸Œ í”„ë¦¬ì…‹(ë³´ê¸° ì¬ê³„ì‚°):</label>
        <select id="presetSelect"></select>
        <button class="btn" id="saveDefaultPresetBtn" title="í•´ë‹¹ ì„¸íŠ¸ì— ê¸°ë³¸ í”„ë¦¬ì…‹ ê¸°ì–µ(ë¡œì»¬)">ì´ ì„¸íŠ¸ ê¸°ë³¸ í”„ë¦¬ì…‹ìœ¼ë¡œ ì €ì¥</button>
        <span id="countInfo" class="pill muted"></span>
      </div>
    </div>

    <div class="r">
      <button class="btn ghost" id="openCurveEditor">í”„ë¦¬ì…‹ í¸ì§‘/ì¶”ê°€</button>
      <span class="muted" style="font-size:13px">
        * ë³´ê¸° í”„ë¦¬ì…‹ì€ <b>í‘œì‹œë§Œ ì¬ê³„ì‚°</b>í•©ë‹ˆë‹¤. ì‹¤ì œ ê¸°ë¡ ì‹œ ì‚¬ìš©ëœ í”„ë¦¬ì…‹ì€ ì—°ìŠµí˜ì´ì§€ì˜ <code>SET.metadata.curvePreset</code> ê°’ì…ë‹ˆë‹¤.
      </span>
    </div>

    <!-- â–¼ ë¦¬ë·° ë”¥ë§í¬ ë²„íŠ¼ -->
    <div class="r" style="margin-top:8px">
      <button class="btn" id="startWrongReviewBtn">ì˜¤ë‹µë§Œ ë¦¬ë·° ì‹œì‘</button>
      <button class="btn" id="startFlaggedReviewBtn">í”Œë˜ê·¸ë§Œ ë¦¬ë·° ì‹œì‘</button>
      <span class="muted" style="font-size:12px">* index.htmlì˜ í˜„ì¬ ì„¸íŠ¸ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.</span>
    </div>

    <!-- â–¼ ë‚ ì§œ ë²”ìœ„ + ì§‘ê³„ ëª¨ë“œ (ì¶”ê°€) -->
    <div class="r" style="margin-top:8px">
      <label class="muted">ë‚ ì§œ:</label>
      <input type="date" id="fromDate"/>
      <span class="muted">~</span>
      <input type="date" id="toDate"/>
      <span class="muted" style="margin-left:10px">ì§‘ê³„:</span>
      <select id="aggMode" title="ìš”ì•½ ì§‘ê³„ ëª¨ë“œ">
        <option value="">ì§‘ê³„ ì—†ìŒ</option>
        <option value="byPreset">í”„ë¦¬ì…‹ë³„ ì§‘ê³„</option>
        <option value="bySet">ì„¸íŠ¸ë³„ ì§‘ê³„</option>
      </select>
    </div>
  </div>

  <!-- ìƒë‹¨ ë©”íŠ¸ë¦­ -->
  <div class="row" style="margin-top:14px">
    <div class="card">
      <div class="head"><div class="title">ì´ì  ì¶”ì´ (SAT)</div></div>
      <canvas id="satLine" height="160"></canvas>
    </div>
    <div class="card">
      <div class="head"><div class="title">ì„¹ì…˜ë³„ í™˜ì‚° ì ìˆ˜</div></div>
      <canvas id="sectionBar" height="160"></canvas>
    </div>
  </div>

  <!-- ìŠ¤í‚¬ ì¶”ì´ & íˆíŠ¸ë§µ -->
  <div class="row" style="margin-top:14px">
    <div class="card">
      <div class="head">
        <div class="title">ìŠ¤í‚¬ ì¶”ì´ (ì •í™•ë„ %)</div>
        <div class="r">
          <select id="skillSelect"></select>
          <button class="btn" id="skillAllBtn">Top-ë³€ë™ ìŠ¤í‚¬ ì¶”ì²œ</button>
          <button class="btn" id="startSkillReviewBtn">ì´ ìŠ¤í‚¬ë¡œ ë¦¬ë·° ì‹œì‘</button>
        </div>
      </div>
      <canvas id="skillLine" height="160"></canvas>
    </div>
    <div class="card">
      <div class="head">
        <div class="title">ìŠ¤í‚¬ íˆíŠ¸ë§µ (ì •í™•ë„ %)</div>
        <div class="legend">
          <span class="cell c-0">0</span>0â€“50
          <span class="cell c-50">50</span>50â€“70
          <span class="cell c-70">70</span>70â€“85
          <span class="cell c-85">85</span>85â€“95
          <span class="cell c-95">95</span>95â€“100
        </div>
      </div>
      <div id="heatHdr" class="heatmap" style="grid-template-rows:auto"></div>
      <div id="heatBody" class="heatmap"></div>
    </div>
  </div>

  <!-- ì‹œë„ ë¹„êµ + ìƒì„¸ -->
  <div class="card" style="margin-top:14px">
    <div class="head">
      <div class="title">ì‹œë„ ë¹„êµ</div>
      <div class="r">
        <select id="cmpA"></select>
        <span class="muted">vs</span>
        <select id="cmpB"></select>
        <button class="btn" id="cmpBtn">ë¹„êµ</button>
        <button class="btn ghost" id="openDetailA">A ìƒì„¸</button>
        <button class="btn ghost" id="openDetailB">B ìƒì„¸</button>
      </div>
    </div>
    <div id="cmpOut" class="grid" style="grid-template-columns:1fr 1fr; gap:12px"></div>
  </div>

  <!-- ì§‘ê³„ ê²°ê³¼ (ì¶”ê°€) -->
  <div class="card" id="aggCard" style="margin-top:14px; display:none">
    <div class="head">
      <div class="title">ì§‘ê³„ ìš”ì•½</div>
      <div class="muted" id="aggCaption" style="font-size:13px"></div>
    </div>
    <div id="aggOut"></div>
  </div>

  <!-- ì‹œë„ ëª©ë¡ -->
  <div class="card" style="margin-top:14px">
    <div class="head">
      <div class="title">ì‹œë„ ëª©ë¡</div>
    </div>
    <div class="muted" style="font-size:13px; margin-bottom:8px">ìµœì‹ ìˆœ Â· í–‰ í´ë¦­ ì‹œ ìƒì„¸</div>
    <table id="attemptTable">
      <thead>
        <tr>
          <th style="width:160px">ì¼ì‹œ</th>
          <th>ì„¸íŠ¸ ì œëª©</th>
          <th>ì¢…ë¥˜</th>
          <th class="right">RW (ì›/í™˜ì‚°)</th>
          <th class="right">Math (ì›/í™˜ì‚°)</th>
          <th class="right">ì´ì </th>
          <th class="right">í”„ë¦¬ì…‹</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- ===== ëª¨ë‹¬: ì‹œë„ ìƒì„¸ ===== -->
<div class="backdrop" id="detailBack">
  <div class="modal">
    <button class="x" id="detailClose">ë‹«ê¸°</button>
    <div id="detailBody"></div>
  </div>
</div>

<!-- ===== ëª¨ë‹¬: ì»¤ë¸Œ ì—ë””í„° ===== -->
<div class="backdrop" id="curveBack">
  <div class="modal">
    <button class="x" id="curveClose">ë‹«ê¸°</button>
    <div class="head"><div class="title">ì»¤ë¸Œ í”„ë¦¬ì…‹ í¸ì§‘/ì¶”ê°€</div></div>
    <div class="r" style="margin-bottom:8px">
      <label class="muted">í”„ë¦¬ì…‹ ì„ íƒ:</label>
      <select id="editPreset"></select>
      <input id="newPresetName" type="text" placeholder="ìƒˆ í”„ë¦¬ì…‹ ì´ë¦„"/>
      <button class="btn" id="dupBtn">ë³µì‚¬â†’ìƒˆì´ë¦„</button>
      <button class="btn bad" id="delBtn">ì‚­ì œ</button>
    </div>
    <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
      <div>
        <div class="muted" style="margin-bottom:6px">RW í¬ì¸íŠ¸ (JSON, ì˜ˆ: [[0,200],[20,300],...])</div>
        <textarea id="rwPoints" class="code"></textarea>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">Math í¬ì¸íŠ¸ (JSON)</div>
        <textarea id="mathPoints" class="code"></textarea>
      </div>
    </div>
    <div class="r" style="margin-top:10px">
      <button class="btn" id="saveCurveBtn">ì €ì¥</button>
      <span class="muted">â€» xâ‰¤100 â†’ ì •ë‹µë¥ (%), x>100 â†’ ë§íŒê°œìˆ˜ ë„ë©”ì¸</span>
    </div>
  </div>
</div>

<script>
/* ===== ì €ì¥/ê³µí†µ ===== */
const ATTEMPT_KEY='dsat_attempts_v1';
function loadAttempts(){ try{ return JSON.parse(localStorage.getItem(ATTEMPT_KEY)||'[]'); }catch(_e){ return []; } }
function saveAttempts(a){ try{ localStorage.setItem(ATTEMPT_KEY, JSON.stringify(a)); }catch(_e){} }

/* ì„¸íŠ¸ë³„ ê¸°ë³¸ í”„ë¦¬ì…‹(ë³´ê¸°ìš©) ë¡œì»¬ ì €ì¥ */
const PRESET_DEFAULT_KEY = 'dsat_preset_defaults';
function loadPresetDefaults(){ try{ return JSON.parse(localStorage.getItem(PRESET_DEFAULT_KEY)||'{}'); }catch(_e){ return {}; } }
function savePresetDefaults(obj){ try{ localStorage.setItem(PRESET_DEFAULT_KEY, JSON.stringify(obj)); }catch(_e){} }

/* ê³¡ì„  ê³„ì‚° */
function interp(points,x){
  const pts=[...points].sort((a,b)=>a[0]-b[0]); if(!pts.length) return 0;
  if(x<=pts[0][0]) return Math.round(pts[0][1]);
  if(x>=pts[pts.length-1][0]) return Math.round(pts[pts.length-1][1]);
  for(let i=1;i<pts.length;i++){ const [x0,y0]=pts[i-1],[x1,y1]=pts[i]; if(x<=x1){ const t=(x-x0)/(x1-x0); return Math.round(y0+t*(y1-y0)); } }
  return Math.round(pts[pts.length-1][1]);
}
function scaledFromCurve(points, correct, total){
  const maxX=Math.max(...points.map(p=>p[0]));
  const x=(maxX<=100)?(total? correct/total*100 : 0):correct;
  return interp(points,x);
}
function chooseCurves(presetName, attempt){
  const PRESETS=(window.CURVE_PRESETS||{});
  if(presetName && PRESETS[presetName]) return PRESETS[presetName];
  if(attempt?.curvePreset && PRESETS[attempt.curvePreset]) return PRESETS[attempt.curvePreset];
  return PRESETS.default || { rw:[[0,200],[100,800]], math:[[0,200],[100,800]] };
}
function ensureScaled(attempt, viewPreset){
  const curves = chooseCurves(viewPreset, attempt);
  let rw = {correct:0,total:0,scaled:0};
  let math = {correct:0,total:0,scaled:0};
  if(attempt.sections){
    rw.correct   = attempt.sections.rw?.correct ?? 0;
    rw.total     = attempt.sections.rw?.total ?? 0;
    math.correct = attempt.sections.math?.correct ?? 0;
    math.total   = attempt.sections.math?.total ?? 0;
  }
  rw.scaled   = scaledFromCurve(curves.rw,   rw.correct,   rw.total);
  math.scaled = scaledFromCurve(curves.math, math.correct, math.total);
  const sat_total = rw.scaled + math.scaled;
  return { ...attempt, sections:{ rw, math }, sat_total };
}

/* ===== UI ìš”ì†Œ ===== */
const $base   = document.getElementById('baseSelect');
const $kind   = document.getElementById('kindSelect');
const $preset = document.getElementById('presetSelect');
const $count  = document.getElementById('countInfo');
const $tbody  = document.querySelector('#attemptTable tbody');
const $cmpA   = document.getElementById('cmpA');
const $cmpB   = document.getElementById('cmpB');
const $cmpOut = document.getElementById('cmpOut');
const $skillSel = document.getElementById('skillSelect');
const $from  = document.getElementById('fromDate');
const $to    = document.getElementById('toDate');
const $agg   = document.getElementById('aggMode');
const $aggCard = document.getElementById('aggCard');
const $aggOut  = document.getElementById('aggOut');
const $aggCaption = document.getElementById('aggCaption');
let LINE=null, BAR=null, SKILL_LINE=null;

/* ===== ì˜µì…˜ êµ¬ì„± ===== */
function groupBaseOptions(list){
  const map=new Map();
  list.forEach(a=>{
    if(!map.has(a.baseId)) map.set(a.baseId,{ baseId:a.baseId, titleSet:new Set(), lastTs:0 });
    const rec=map.get(a.baseId);
    if(a.title) rec.titleSet.add(a.title);
    rec.lastTs = Math.max(rec.lastTs,a.ts);
  });
  return [...map.values()].sort((a,b)=> b.lastTs-a.lastTs).map(rec=>{
    const label = rec.titleSet.size? [...rec.titleSet].pop() : rec.baseId;
    return { value: rec.baseId, label };
  });
}
function fillBase(list){
  $base.innerHTML='';
  groupBaseOptions(list).forEach(opt=>{
    const o=document.createElement('option'); o.value=opt.value; o.textContent=opt.label; $base.appendChild(o);
  });

  // ì„¸íŠ¸ë³„ ê¸°ë³¸ í”„ë¦¬ì…‹ ìë™ ì„ íƒ
  const def=loadPresetDefaults(); const baseId=$base.value;
  if(def[baseId] && ($preset.querySelector(`option[value="${def[baseId]}"]`))){
    $preset.value=def[baseId];
  }
}
function fillPreset(){
  const PRESETS = window.CURVE_PRESETS||{};
  $preset.innerHTML='';
  Object.keys(PRESETS).forEach(name=>{
    const o=document.createElement('option'); o.value=name; o.textContent=name; $preset.appendChild(o);
  });
  if(PRESETS.default) $preset.value='default';
}
function fmtDate(ts){
  const d=new Date(ts), z=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`;
}

/* ===== ë‚ ì§œ/í•„í„° ìœ í‹¸ ===== */
function parseDateInput(v){
  if(!v) return null;
  const t = Date.parse(v + 'T00:00:00');
  return Number.isFinite(t) ? t : null;
}
function endOfDay(ts){ return ts + 24*60*60*1000 - 1; }

/* ===== ë°ì´í„° í˜„ì¬ ë·° ===== */
function currentRows(){
  const all = loadAttempts().sort((a,b)=> b.ts-a.ts);
  if(!$base.options.length) fillBase(all);
  if(!$preset.options.length) fillPreset();

  const baseId = $base.value || (all[0]?.baseId ?? '');
  const kind = $kind.value;

  // ë‚ ì§œ í•„í„°
  const fromTs = parseDateInput($from.value);
  const toTsRaw = parseDateInput($to.value);
  const toTs = toTsRaw!==null ? endOfDay(toTsRaw) : null;

  // ì„¸íŠ¸ë³„ ê¸°ë³¸ í”„ë¦¬ì…‹ ìš°ì„  â†’ ì—†ìœ¼ë©´ ì„ íƒê°’
  const def=loadPresetDefaults(); const basePreset = def[baseId];
  const presetName = basePreset || $preset.value || null;

  const filtered = all.filter(a=>{
    if(a.baseId!==baseId) return false;
    if(kind && a.kind!==kind) return false;
    if(fromTs!==null && a.ts < fromTs) return false;
    if(toTs!==null && a.ts > toTs) return false;
    return true;
  });

  $count.textContent = `${filtered.length} attempts`;
  return { rows: filtered.map(a=> ensureScaled(a, presetName)), presetName, baseId, fromTs, toTs };
}

/* ===== í‘œ/ì°¨íŠ¸ ===== */
function renderTable(rows){
  $tbody.innerHTML='';
  rows.forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${fmtDate(a.ts)}</td>
      <td>${a.title||a.baseId||''}</td>
      <td>${a.kind}</td>
      <td class="right">${a.sections.rw.correct}/${a.sections.rw.total} Â· <b>${a.sections.rw.scaled}</b></td>
      <td class="right">${a.sections.math.correct}/${a.sections.math.total} Â· <b>${a.sections.math.scaled}</b></td>
      <td class="right"><b>${a.sat_total}</b></td>
      <td class="right">${a.curvePreset||'â€”'}</td>`;
    tr.style.cursor='pointer';
    tr.addEventListener('click', ()=> openAttemptDetail(a));
    $tbody.appendChild(tr);
  });
}
function renderCharts(rows){
  const chronological = [...rows].sort((a,b)=> a.ts-b.ts);
  const labels = chronological.map(a=> new Date(a.ts).toLocaleDateString());
  const totalSAT = chronological.map(a=> a.sat_total);
  const rwScaled = chronological.map(a=> a.sections.rw.scaled);
  const mScaled  = chronological.map(a=> a.sections.math.scaled);

  const c1=document.getElementById('satLine'); if(LINE) LINE.destroy();
  LINE = new Chart(c1,{ type:'line', data:{ labels, datasets:[{label:'Total SAT', data:totalSAT, tension:.25}]},
    options:{ responsive:true, scales:{ y:{ suggestedMin:200, suggestedMax:1600 } } } });

  const c2=document.getElementById('sectionBar'); if(BAR) BAR.destroy();
  BAR = new Chart(c2,{ type:'bar', data:{ labels, datasets:[
      { label:'RW',   data:rwScaled, stack:'sat' },
      { label:'Math', data:mScaled,  stack:'sat' }
    ]},
    options:{ responsive:true, scales:{ y:{ suggestedMin:200, suggestedMax:1600, stacked:true }, x:{ stacked:true } } } });
}

/* ===== ìŠ¤í‚¬ ===== */
function allSkillNames(rows){
  const s=new Set();
  rows.forEach(a=> Object.keys(a.skills||{}).forEach(k=> s.add(k)));
  return [...s].sort();
}
function fillSkillSelect(rows){
  const skills = allSkillNames(rows);
  $skillSel.innerHTML='';
  skills.forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; $skillSel.appendChild(o); });
}
function classForPct(p){ if(p>=95) return 'c-95'; if(p>=85) return 'c-85'; if(p>=70) return 'c-70'; if(p>=50) return 'c-50'; return 'c-0'; }
function renderHeatmap(rows){
  const heatHdr=document.getElementById('heatHdr');
  const heatBody=document.getElementById('heatBody');
  heatHdr.innerHTML=''; heatBody.innerHTML='';

  const skills = allSkillNames(rows);
  // í—¤ë”
  const hdrRow=document.createElement('div'); hdrRow.className='heat-row';
  const left=document.createElement('div'); left.className='skill-name'; left.style.fontWeight='700'; left.textContent='Skill';
  hdrRow.appendChild(left);
  rows.forEach((a,i)=>{
    const d=document.createElement('div'); d.className='cell'; d.style.fontWeight='700';
    d.title=fmtDate(a.ts); d.textContent=String(i+1);
    hdrRow.appendChild(d);
  });
  heatHdr.appendChild(hdrRow);

  // ë°”ë””
  skills.forEach(sk=>{
    const row=document.createElement('div'); row.className='heat-row';
    const name=document.createElement('div'); name.className='skill-name'; name.textContent=sk;
    row.appendChild(name);
    rows.forEach(a=>{
      const s=a.skills?.[sk];
      const acc = s && s.total ? Math.round((s.correct/s.total)*100) : null;
      const cell=document.createElement('div'); cell.className='cell ' + (acc===null?'':classForPct(acc));
      cell.textContent = acc===null ? 'â€”' : String(acc);
      cell.title = acc===null ? `${sk}: data none` : `${sk}: ${s.correct}/${s.total} (${acc}%)`;
      row.appendChild(cell);
    });
    heatBody.appendChild(row);
  });
}
function renderSkillTrend(rows){
  const key=$skillSel.value;
  const chronological = [...rows].sort((a,b)=> a.ts-b.ts);
  const labels = chronological.map(a=> new Date(a.ts).toLocaleDateString());
  const data = chronological.map(a=>{
    const s=a.skills?.[key]; return (s && s.total)? Math.round((s.correct/s.total)*100) : null;
  });

  const d = data.map(v=> (v===null? null : v));
  const c=document.getElementById('skillLine'); if(SKILL_LINE) SKILL_LINE.destroy();
  SKILL_LINE = new Chart(c,{ type:'line', data:{ labels, datasets:[{label:key||'Skill', data:d, spanGaps:true, tension:.2}]},
    options:{ responsive:true, scales:{ y:{ suggestedMin:0, suggestedMax:100 } } } });
}

/* ===== ë¹„êµ/ìƒì„¸ ===== */
function fillCompare(rows){
  const opts = rows.map((a,i)=>({ key:String(a.ts), label:`#${i+1} â€¢ ${fmtDate(a.ts)} â€¢ ${a.kind} â€¢ ${a.sat_total}` }));
  [$cmpA,$cmpB].forEach(sel=>{
    sel.innerHTML=''; opts.forEach(o=>{ const op=document.createElement('option'); op.value=o.key; op.textContent=o.label; sel.appendChild(op); });
  });
  if(opts.length>=2){ $cmpA.selectedIndex=0; $cmpB.selectedIndex=1; }
}
function renderCompare(rows){
  $cmpOut.innerHTML='';
  const keyA=$cmpA.value, keyB=$cmpB.value;
  const A=rows.find(a=> String(a.ts)===keyA);
  const B=rows.find(a=> String(a.ts)===keyB);
  if(!A||!B){ $cmpOut.innerHTML='<div class="muted">ë¹„êµí•˜ë ¤ë©´ ë‘ ì‹œë„ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>'; return; }

  function card(title, aVal, bVal, fmt=(v)=>v){
    const delta = (typeof aVal==='number' && typeof bVal==='number') ? (bVal-aVal) : null;
    const sign = delta===null ? '' : (delta>0? '+' : '');
    const color = delta===null ? '' : (delta>=0 ? 'ok' : 'bad');
    return `
      <div class="card">
        <div class="head"><div class="title">${title}</div></div>
        <div style="display:flex; justify-content:space-between; gap:8px">
          <div><div class="muted">A</div><div><b>${fmt(aVal)}</b></div></div>
          <div><div class="muted">B</div><div><b>${fmt(bVal)}</b></div></div>
          <div><div class="muted">Î”</div><div><span class="badge ${color}">${delta===null?'â€”': sign + delta}</span></div></div>
        </div>
      </div>`;
  }

  $cmpOut.innerHTML = [
    card('Total SAT', A.sat_total, B.sat_total),
    card('RW (Scaled)', A.sections.rw.scaled, B.sections.rw.scaled),
    card('Math (Scaled)', A.sections.math.scaled, B.sections.math.scaled),
    card('RW Raw', A.sections.rw.correct, B.sections.rw.correct),
    card('Math Raw', A.sections.math.correct, B.sections.math.correct)
  ].join('');
}

/* ===== ì§‘ê³„ ë Œë”ëŸ¬ ===== */
function renderAggregations(rows){
  const mode = $agg.value;
  if(!mode){
    $aggCard.style.display='none';
    $aggOut.innerHTML='';
    return;
  }

  const keyFn = (a)=> mode==='byPreset' ? (a.curvePreset || 'â€”') : a.baseId;

  const groups = new Map();
  rows.forEach(a=>{
    const k = keyFn(a);
    if(!groups.has(k)) groups.set(k, []);
    groups.get(k).push(a);
  });

  const stats = [...groups.entries()].map(([k,arr])=>{
    const n = arr.length;
    const avg = (list, pick)=> Math.round(list.reduce((s,x)=> s + pick(x), 0) / n);
    const rwScaledAvg   = avg(arr, x=> x.sections.rw.scaled);
    const mathScaledAvg = avg(arr, x=> x.sections.math.scaled);
    const satAvg        = avg(arr, x=> x.sat_total);
    const rwRawAvg   = Math.round(arr.reduce((s,x)=> s + (x.sections.rw.correct / (x.sections.rw.total||1)), 0) / n * 100);
    const mathRawAvg = Math.round(arr.reduce((s,x)=> s + (x.sections.math.correct / (x.sections.math.total||1)), 0) / n * 100);
    const latestTs = Math.max(...arr.map(x=> x.ts));
    return { key:k, n, satAvg, rwScaledAvg, mathScaledAvg, rwRawAvg, mathRawAvg, latestTs };
  });

  stats.sort((a,b)=>{
    if(b.n!==a.n) return b.n - a.n;
    if(b.satAvg!==a.satAvg) return b.satAvg - a.satAvg;
    return String(a.key).localeCompare(String(b.key));
  });

  const thMode = (mode==='byPreset') ? 'í”„ë¦¬ì…‹' : 'ì„¸íŠ¸';
  const rowsHTML = stats.map(s=>`
    <tr>
      <td>${s.key}</td>
      <td class="right">${s.n}</td>
      <td class="right"><b>${s.satAvg}</b></td>
      <td class="right">${s.rwScaledAvg}</td>
      <td class="right">${s.mathScaledAvg}</td>
      <td class="right">${s.rwRawAvg}%</td>
      <td class="right">${s.mathRawAvg}%</td>
      <td>${new Date(s.latestTs).toLocaleDateString()}</td>
    </tr>
  `).join('');

  $aggOut.innerHTML = `
    <div class="muted" style="font-size:13px; margin-bottom:6px">
      í‰ê· ì€ ìœ„ì˜ ëª¨ë“  í•„í„°(ì„¸íŠ¸/ë³´ê¸°/ë‚ ì§œ/í”„ë¦¬ì…‹ ì¬ê³„ì‚°) ì ìš© í›„ ë‚¨ì€ ì‹œë„ë§Œ í¬í•¨ë©ë‹ˆë‹¤.
    </div>
    <table style="width:100%; border-collapse:collapse; font-size:14px">
      <thead>
        <tr>
          <th style="text-align:left">${thMode}</th>
          <th class="right">ì‹œë„ìˆ˜</th>
          <th class="right">ì´ì  í‰ê· </th>
          <th class="right">RW Scaled í‰ê· </th>
          <th class="right">Math Scaled í‰ê· </th>
          <th class="right">RW ì •ë‹µë¥ </th>
          <th class="right">Math ì •ë‹µë¥ </th>
          <th style="text-align:left">ìµœê·¼ ì¼ì</th>
        </tr>
      </thead>
      <tbody>${rowsHTML}</tbody>
    </table>
  `;

  $aggCaption.textContent = (mode==='byPreset') ? 'í”„ë¦¬ì…‹ë³„ ì§‘ê³„' : 'ì„¸íŠ¸ë³„ ì§‘ê³„';
  $aggCard.style.display = 'block';
}

/* ===== ì‹œë„ ìƒì„¸ ëª¨ë‹¬ ===== */
const detailBack=document.getElementById('detailBack');
const detailBody=document.getElementById('detailBody');
document.getElementById('detailClose').onclick=()=>{ detailBack.style.display='none'; detailBody.innerHTML=''; };

function openAttemptDetail(a){
  const skills = Object.entries(a.skills||{}).map(([k,v])=>{
    const acc = v.total? Math.round((v.correct/v.total)*100) : 0;
    return { k, correct:v.correct, total:v.total, acc };
  }).sort((x,y)=> y.acc - x.acc);
  const top = skills.slice(0,5), bottom = skills.slice(-5);

  detailBody.innerHTML = `
    <div class="head"><div class="title">ì‹œë„ ìƒì„¸ â€” ${fmtDate(a.ts)}</div></div>
    <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
      <div class="card">
        <div class="head"><div class="title">ìš”ì•½</div></div>
        <div>ì„¸íŠ¸: <b>${a.title||a.baseId||''}</b></div>
        <div>ì¢…ë¥˜: <b>${a.kind}</b></div>
        <div style="margin-top:6px">RW: <b>${a.sections.rw.correct}/${a.sections.rw.total}</b> â†’ <b>${a.sections.rw.scaled}</b></div>
        <div>Math: <b>${a.sections.math.correct}/${a.sections.math.total}</b> â†’ <b>${a.sections.math.scaled}</b></div>
        <div style="margin-top:6px">ì´ì : <b>${a.sat_total}</b></div>
        <div class="muted" style="margin-top:6px">í”„ë¦¬ì…‹(ì‹¤ì œ ê¸°ë¡): ${a.curvePreset||'â€”'}</div>
      </div>
      <div class="card">
        <div class="head"><div class="title">ìŠ¤í‚¬ Top/Bottom</div></div>
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
          <div>
            <div class="muted" style="margin-bottom:6px">Top 5</div>
            ${top.map(s=>`<div>${s.k} â€” <b>${s.acc}%</b> <span class="muted">(${s.correct}/${s.total})</span></div>`).join('') || '<div class="muted">ë°ì´í„° ì—†ìŒ</div>'}
          </div>
          <div>
            <div class="muted" style="margin-bottom:6px">Bottom 5</div>
            ${bottom.map(s=>`<div>${s.k} â€” <b>${s.acc}%</b> <span class="muted">(${s.correct}/${s.total})</span></div>`).join('') || '<div class="muted">ë°ì´í„° ì—†ìŒ</div>'}
          </div>
        </div>
      </div>
    </div>`;
  detailBack.style.display='block';
}

/* ===== ì»¤ë¸Œ ì—ë””í„° ===== */
const curveBack=document.getElementById('curveBack');
const curveClose=document.getElementById('curveClose');
const editPreset=document.getElementById('editPreset');
const newPresetName=document.getElementById('newPresetName');
const rwPoints=document.getElementById('rwPoints');
const mathPoints=document.getElementById('mathPoints');

curveClose.onclick=()=>{ curveBack.style.display='none'; };

function openCurveEditor(){
  const PRESETS = window.CURVE_PRESETS||{};
  editPreset.innerHTML='';
  Object.keys(PRESETS).forEach(name=>{
    const o=document.createElement('option'); o.value=name; o.textContent=name; editPreset.appendChild(o);
  });
  editPreset.value = $preset.value || 'default';
  loadPresetToForm(editPreset.value);
  curveBack.style.display='block';
}
function loadPresetToForm(name){
  const PRESETS = window.CURVE_PRESETS||{};
  const p = PRESETS[name] || PRESETS.default;
  rwPoints.value = JSON.stringify(p.rw||[], null, 2);
  mathPoints.value = JSON.stringify(p.math||[], null, 2);
}
document.getElementById('openCurveEditor').onclick=openCurveEditor;
editPreset.addEventListener('change', ()=> loadPresetToForm(editPreset.value));

document.getElementById('dupBtn').onclick=()=>{
  const name = (newPresetName.value||'').trim();
  if(!name){ alert('ìƒˆ í”„ë¦¬ì…‹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const PRESETS=window.CURVE_PRESETS||{};
  try{
    PRESETS[name] = {
      rw: JSON.parse(rwPoints.value||'[]'),
      math: JSON.parse(mathPoints.value||'[]')
    };
    alert(`í”„ë¦¬ì…‹ "${name}" ì¶”ê°€ë¨`);
    fillPreset(); $preset.value=name;
    openCurveEditor();
  }catch(e){ alert('JSON íŒŒì‹± ì‹¤íŒ¨: '+e.message); }
};
document.getElementById('delBtn').onclick=()=>{
  const name = editPreset.value;
  if(!name || name==='default'){ alert('defaultëŠ” ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
  if(confirm(`í”„ë¦¬ì…‹ "${name}"ì„(ë¥¼) ì‚­ì œí• ê¹Œìš”?`)){
    delete window.CURVE_PRESETS[name];
    fillPreset(); openCurveEditor();
  }
};
document.getElementById('saveCurveBtn').onclick=()=>{
  const name = editPreset.value;
  try{
    const rw=JSON.parse(rwPoints.value||'[]');
    const mh=JSON.parse(mathPoints.value||'[]');
    window.CURVE_PRESETS[name] = { rw, math: mh };
    alert(`"${name}" ì €ì¥ë¨`);
    fillPreset();
  }catch(e){ alert('JSON íŒŒì‹± ì‹¤íŒ¨: '+e.message); }
};

/* ===== Export/Import/Print ===== */
document.getElementById('exportBtn').onclick = ()=>{
  const all = loadAttempts().sort((a,b)=> b.ts-a.ts);
  const blob = new Blob([JSON.stringify(all,null,2)],{type:'application/json;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download='dsat_attempts.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};
document.getElementById('importBtn').onclick=()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    try{
      const text=await f.text(); const arr=JSON.parse(text);
      if(!Array.isArray(arr)) throw new Error('ë°°ì—´ JSONì´ ì•„ë‹˜');
      saveAttempts(arr); renderAll();
      alert('ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ');
    }catch(err){ alert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: '+err.message); }
  };
  inp.click();
};
document.getElementById('printBtn').onclick=()=> window.print();

/* ===== ë”¥ë§í¬: ì—°ìŠµí˜ì´ì§€ì—ì„œ ë¦¬ë·° ìë™ ì‹œì‘ ===== */
function goPractice(url){ location.href = url; }
document.getElementById('startSkillReviewBtn').addEventListener('click', ()=>{
  const key = document.getElementById('skillSelect').value;
  if(!key){ alert('ìŠ¤í‚¬ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.'); return; }
  goPractice(`./index.html?review=skill&value=${encodeURIComponent(key)}`);
});
document.getElementById('startWrongReviewBtn').addEventListener('click', ()=>{
  goPractice('./index.html?review=wrong');
});
document.getElementById('startFlaggedReviewBtn').addEventListener('click', ()=>{
  goPractice('./index.html?review=flagged');
});

/* ===== ë™ì‘ ===== */
function renderAll(){
  const { rows } = currentRows();
  renderTable(rows);
  renderCharts(rows);
  renderHeatmap(rows);
  fillCompare(rows);
  renderCompare(rows);
  fillSkillSelect(rows);
  renderSkillTrend(rows);
  renderAggregations(rows); // â˜… ì§‘ê³„ ì¶”ê°€
}
$base.addEventListener('change', renderAll);
$kind.addEventListener('change', renderAll);
$preset.addEventListener('change', renderAll);
document.getElementById('cmpBtn').addEventListener('click', ()=> renderAll());
document.getElementById('openDetailA').addEventListener('click', ()=>{
  const { rows } = currentRows(); const A=rows.find(r=> String(r.ts)===$cmpA.value); if(A) openAttemptDetail(A);
});
document.getElementById('openDetailB').addEventListener('click', ()=>{
  const { rows } = currentRows(); const B=rows.find(r=> String(r.ts)===$cmpB.value); if(B) openAttemptDetail(B);
});
$skillSel.addEventListener('change', ()=>{ const { rows } = currentRows(); renderSkillTrend(rows); });

// ë‚ ì§œ/ì§‘ê³„ ì´ë²¤íŠ¸
const onDateOrAggChange = ()=> renderAll();
document.getElementById('fromDate').addEventListener('change', onDateOrAggChange);
document.getElementById('toDate').addEventListener('change', onDateOrAggChange);
document.getElementById('aggMode').addEventListener('change', onDateOrAggChange);

// ì „ì²´ ë¡œê·¸ ì‚­ì œ(ì•ˆì „ í™•ì¸)
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(confirm('ë¡œì»¬ì— ì €ì¥ëœ ëª¨ë“  ì‹œë„ ë¡œê·¸ë¥¼ ì‚­ì œí• ê¹Œìš”?')){
    saveAttempts([]);
    renderAll();
  }
});

/* ì¶”ì²œ: ë³€ë™ í° ìŠ¤í‚¬ ìë™ ì„ íƒ */
document.getElementById('skillAllBtn').onclick=()=>{
  const { rows } = currentRows();
  const last = rows.slice(0,5).reverse(); // ê³¼ê±°â†’í˜„ì¬
  const accs = {};
  last.forEach(a=>{
    Object.entries(a.skills||{}).forEach(([k,v])=>{
      if(!accs[k]) accs[k]=[];
      accs[k].push(v.total? (v.correct/v.total*100) : null);
    });
  });
  const varList = Object.entries(accs).map(([k,arr])=>{
    const vals = arr.filter(x=> x!==null);
    if(vals.length<2) return [k,-1];
    const avg = vals.reduce((s,x)=>s+x,0)/vals.length;
    const v = vals.reduce((s,x)=>s+(x-avg)**2,0)/vals.length;
    return [k,v];
  }).filter(([,v])=> v>=0).sort((a,b)=> b[1]-a[1]);
  if(!varList.length){ alert('ë³€ë™ì„ ê³„ì‚°í•  ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.'); return; }
  $skillSel.value = varList[0][0];
  renderSkillTrend(rows);
};

/* ì´ˆê¸° ë Œë” */
renderAll();

/* ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ë‹«ê¸° */
[document.getElementById('detailBack'), document.getElementById('curveBack')].forEach(back=>{
  back.addEventListener('click', (e)=>{ if(e.target===back) back.style.display='none'; });
});
</script>
</body>
</html>
