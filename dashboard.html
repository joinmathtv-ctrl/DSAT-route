<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DSAT Dashboard</title>

<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- 커브 프리셋 (연습페이지와 동일 파일) -->
<script src="./curves.presets.js"></script>

<style>
  :root{
    --bg:#fafbfe; --card:#fff; --ink:#1f2937; --muted:#6b7280;
    --line:#e5e7eb; --accent:#2563eb;
  }
  *{ box-sizing:border-box }
  body{ margin:0; background:var(--bg); color:var(--ink); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif }
  .wrap{ max-width:1100px; margin:20px auto 56px; padding:0 14px }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:14px }
  @media (max-width:900px){ .row{ grid-template-columns:1fr } }
  .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:0 6px 20px rgba(0,0,0,.04) }
  .head{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px }
  .title{ font-weight:800 }
  .muted{ color:var(--muted) }
  .btn{ border:1px solid var(--line); background:#fff; padding:8px 12px; border-radius:10px; cursor:pointer }
  .pill{ padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#fff }
  select{ padding:7px 10px; border:1px solid var(--line); border-radius:10px; background:#fff }
  table{ width:100%; border-collapse:collapse; font-size:14px }
  th,td{ border-bottom:1px solid var(--line); padding:8px 6px; text-align:left; vertical-align:top }
  th{ color:#111827 }
  .right{ text-align:right }
  .topbar{
    position:sticky; top:0; z-index:5; background:#fff; border-bottom:1px solid var(--line);
  }
  .toprow{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 14px }
  a.back{ text-decoration:none; color:var(--accent) }
</style>
</head>
<body>
<div class="topbar">
  <div class="toprow">
    <div style="font-weight:800">📈 DSAT Dashboard</div>
    <div style="display:flex; gap:8px; align-items:center">
      <a class="back" href="./index.html">← 연습으로 돌아가기</a>
      <span class="muted">|</span>
      <button class="btn" id="clearBtn">전체 로그 삭제</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="card">
    <div class="head">
      <div class="title">필터</div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
        <label class="muted">세트:</label>
        <select id="baseSelect"></select>
        <label class="muted">보기:</label>
        <select id="kindSelect">
          <option value="">전체</option>
          <option value="base">Base</option>
          <option value="review">Review</option>
        </select>
        <span id="countInfo" class="pill muted"></span>
      </div>
    </div>
    <div class="muted" style="font-size:13px">연습 페이지에서 저장된 시도(로컬)의 집계입니다.</div>
  </div>

  <div class="row" style="margin-top:14px">
    <div class="card">
      <div class="head">
        <div class="title">총점 추이 (SAT)</div>
      </div>
      <canvas id="satLine" height="160"></canvas>
    </div>
    <div class="card">
      <div class="head">
        <div class="title">섹션별 환산 점수</div>
      </div>
      <canvas id="sectionBar" height="160"></canvas>
    </div>
  </div>

  <div class="card" style="margin-top:14px">
    <div class="head">
      <div class="title">시도 목록</div>
      <div>
        <button class="btn" id="exportBtn">CSV 내보내기</button>
      </div>
    </div>
    <div class="muted" style="font-size:13px; margin-bottom:8px">최신순</div>
    <table id="attemptTable">
      <thead>
        <tr>
          <th style="width:160px">일시</th>
          <th>세트 제목</th>
          <th>종류</th>
          <th class="right">RW (원/환산)</th>
          <th class="right">Math (원/환산)</th>
          <th class="right">총점</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const ATTEMPT_KEY = 'dsat_attempts_v1';

function loadAttempts(){
  try{ return JSON.parse(localStorage.getItem(ATTEMPT_KEY) || '[]'); }catch(_e){ return []; }
}
function saveAttempts(a){ try{ localStorage.setItem(ATTEMPT_KEY, JSON.stringify(a)); }catch(_e){} }

// 커브 도우미 (연습페이지와 동일 로직의 경량판)
function interp(points, x){
  const pts=[...points].sort((a,b)=>a[0]-b[0]);
  if(!pts.length) return 0;
  if(x<=pts[0][0]) return Math.round(pts[0][1]);
  if(x>=pts[pts.length-1][0]) return Math.round(pts[pts.length-1][1]);
  for(let i=1;i<pts.length;i++){
    const [x0,y0]=pts[i-1],[x1,y1]=pts[i];
    if(x<=x1){ const t=(x-x0)/(x1-x0); return Math.round(y0+t*(y1-y0)); }
  }
  return Math.round(pts[pts.length-1][1]);
}
function scaledFromCurve(points, correct, total){
  const maxX = Math.max(...points.map(p=>p[0]));
  const x = (maxX<=100)? (total? correct/total*100 : 0) : correct;
  return interp(points, x);
}
function chooseCurvesFromAttempt(attempt){
  const PRESETS = (window.CURVE_PRESETS||{});
  if (attempt.curvePreset && PRESETS[attempt.curvePreset]) return PRESETS[attempt.curvePreset];
  return PRESETS.default || { rw:[[0,200],[100,800]], math:[[0,200],[100,800]] };
}
function ensureScaled(attempt){
  // 과거 로그 호환: sections 없으면 추정/재계산
  if (attempt.sections && typeof attempt.sat_total === 'number') return attempt;

  const curves = chooseCurvesFromAttempt(attempt);
  // overall만 있을 수도 있으니 일단 0으로
  let rw = {correct:0,total:0,scaled:0};
  let math = {correct:0,total:0,scaled:0};
  if (attempt.sections){
    rw.correct = attempt.sections.rw?.correct ?? 0;
    rw.total   = attempt.sections.rw?.total ?? 0;
    math.correct = attempt.sections.math?.correct ?? 0;
    math.total   = attempt.sections.math?.total ?? 0;
  }
  rw.scaled   = scaledFromCurve(curves.rw,   rw.correct,   rw.total);
  math.scaled = scaledFromCurve(curves.math, math.correct, math.total);
  attempt.sections = { rw, math };
  attempt.sat_total = rw.scaled + math.scaled;
  return attempt;
}

// UI
const $base = document.getElementById('baseSelect');
const $kind = document.getElementById('kindSelect');
const $count= document.getElementById('countInfo');
const $tbody= document.querySelector('#attemptTable tbody');
let LINE=null, BAR=null;

function groupBaseIds(list){
  const map=new Map();
  list.forEach(a=>{
    if(!map.has(a.baseId)) map.set(a.baseId, new Set());
    const set = map.get(a.baseId);
    if(a.title) set.add(a.title);
  });
  return [...map.entries()].map(([baseId, titles])=>{
    // 표시용 라벨: 제일 최근 제목 1개
    const label = titles.size? [...titles].pop() : baseId;
    return { baseId, label };
  });
}

function loadFilterOptions(all){
  const bases = groupBaseIds(all);
  $base.innerHTML='';
  bases.forEach(({baseId,label})=>{
    const opt=document.createElement('option');
    opt.value=baseId; opt.textContent=label || baseId;
    $base.appendChild(opt);
  });
}

function fmtDate(ts){
  const d=new Date(ts);
  const z=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}`;
}

function render(){
  const all = loadAttempts().map(ensureScaled).sort((a,b)=> b.ts-a.ts);
  if(!$base.options.length) loadFilterOptions(all);
  const baseId = $base.value || (all[0]?.baseId ?? '');
  const kind = $kind.value;

  const rows = all.filter(a=> a.baseId===baseId && (!kind || a.kind===kind));
  $count.textContent = `${rows.length} attempts`;

  // 표
  $tbody.innerHTML='';
  rows.forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${fmtDate(a.ts)}</td>
      <td>${a.title||a.baseId||''}</td>
      <td>${a.kind}</td>
      <td class="right">${a.sections.rw.correct}/${a.sections.rw.total} · <b>${a.sections.rw.scaled}</b></td>
      <td class="right">${a.sections.math.correct}/${a.sections.math.total} · <b>${a.sections.math.scaled}</b></td>
      <td class="right"><b>${a.sat_total}</b></td>
    `;
    $tbody.appendChild(tr);
  });

  // 차트 데이터 (시간 오름차순으로)
  const chronological = [...rows].sort((a,b)=> a.ts-b.ts);
  const labels = chronological.map(a=> new Date(a.ts).toLocaleDateString());
  const lineSAT = chronological.map(a=> a.sat_total);
  const barRW   = chronological.map(a=> a.sections.rw.scaled);
  const barM    = chronological.map(a=> a.sections.math.scaled);

  // 라인 차트
  const ctx1 = document.getElementById('satLine');
  if(LINE) LINE.destroy();
  LINE = new Chart(ctx1, {
    type:'line',
    data:{
      labels,
      datasets:[{ label:'Total SAT', data:lineSAT, tension:0.25 }]
    },
    options:{
      responsive:true,
      scales:{ y:{ suggestedMin:200, suggestedMax:1600 } }
    }
  });

  // 바 차트
  const ctx2 = document.getElementById('sectionBar');
  if(BAR) BAR.destroy();
  BAR = new Chart(ctx2, {
    type:'bar',
    data:{
      labels,
      datasets:[
        { label:'RW',   data:barRW, stack:'sat' },
        { label:'Math', data:barM,  stack:'sat' }
      ]
    },
    options:{
      responsive:true,
      scales:{ y:{ suggestedMin:200, suggestedMax:1600, stacked:true }, x:{ stacked:true } }
    }
  });
}

document.getElementById('exportBtn').onclick = ()=>{
  const all = loadAttempts().map(ensureScaled).sort((a,b)=> b.ts-a.ts);
  const header = ['timestamp','title','kind','rw_raw','rw_total','rw_scaled','math_raw','math_total','math_scaled','sat_total','baseId','curvePreset'];
  const rows = [header];
  all.forEach(a=>{
    rows.push([
      new Date(a.ts).toISOString(),
      (a.title||'').replaceAll('"','""'),
      a.kind,
      a.sections.rw.correct, a.sections.rw.total, a.sections.rw.scaled,
      a.sections.math.correct, a.sections.math.total, a.sections.math.scaled,
      a.sat_total,
      a.baseId,
      a.curvePreset||''
    ]);
  });
  const csv = rows.map(r=> r.map(v=> `"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='dsat_attempts.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
};

document.getElementById('clearBtn').onclick = ()=>{
  if(confirm('정말 모든 대시보드 로그를 삭제할까요? (되돌릴 수 없음)')){
    saveAttempts([]);
    render();
  }
};

$base.addEventListener('change', render);
$kind.addEventListener('change', render);

// 초기 렌더
render();
</script>
</body>
</html>
